<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SingaTrain</title>

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" defer></script>

  <!-- Material Design Icons -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <!-- Premium Typography - Neuralink-inspired fonts -->
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:wght@400;500;600;700&display=swap"
    rel="stylesheet">

  <!-- Animate.css for smooth animations -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">

  <!-- AOS (Animate On Scroll) for premium animations -->
  <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
  <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>

  <!-- Mapbox -->
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.10.0/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.10.0/mapbox-gl.css" rel="stylesheet" />

  <!-- Leaflet for Route Map Overlay -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"
    integrity="sha512-8b30J6k9OWJx7fniRAzE16E7YbgaJ6IAX7AnCM1j403rwhhtjfiPgk41IrT9jp+1rssZCvGSqtEtFPd0PfrNqw=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/ScrollToPlugin.min.js"
    integrity="sha512-7YxrIizSnM4tUHgZfzkWPx4L4/O6Bu0AQOilKjMwrYRnALsivC8Wm0NRrLphEd9w8nCjsUq9zbnmEPTrU3FnaA=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <style>
    :root {
      /* Neuralink-inspired color palette - muted and sophisticated */
      --sg-red: #f97316;
      /* Primary brand orange */
      --sg-red-dark: #c2410c;
      /* Darker hover orange */
      --sg-red-soft: #fff4e6;
      /* Light background tint */
      --sg-orange-rgb: 249, 115, 22;
      --sg-grey: #6b7280;
      --sg-border: #e5e7eb;

      /* Premium Neuralink-inspired variables */
      --primary-gradient: linear-gradient(135deg, #f97316 0%, #c2410c 100%);
      --card-shadow: 0 2px 40px rgba(0, 0, 0, 0.04);
      --card-shadow-hover: 0 8px 60px rgba(0, 0, 0, 0.08);
      --border-radius: 20px;
      --border-radius-sm: 12px;
      --border-radius-lg: 32px;

      /* Neuralink-inspired muted palette */
      --neutral-50: #fafafa;
      --neutral-100: #f5f5f5;
      --neutral-200: #e5e5e5;
      --neutral-300: #d4d4d4;
      --neutral-400: #a3a3a3;
      --neutral-500: #737373;
      --neutral-600: #525252;
      --neutral-700: #404040;
      --neutral-800: #262626;
      --neutral-900: #171717;

      /* Premium accent colors */
      --accent-blue: #0ea5e9;
      --accent-green: #10b981;
      --accent-purple: #8b5cf6;
      --accent-orange: #f59e0b;

      /* Typography scale */
      --text-xs: 0.75rem;
      --text-sm: 0.875rem;
      --text-base: 1rem;
      --text-lg: 1.125rem;
      --text-xl: 1.25rem;
      --text-2xl: 1.5rem;
      --text-3xl: 1.875rem;
      --text-4xl: 2.25rem;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Inter', system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
      background: var(--neutral-50);
      color: var(--neutral-800);
      min-height: 100vh;
      font-weight: 400;
      line-height: 1.7;
      letter-spacing: -0.01em;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      padding-top: 112px;
    }

    /* Premium typography hierarchy */
    h1,
    h2,
    h3,
    h4,
    h5,
    h6 {
      font-family: 'Playfair Display', serif;
      font-weight: 500;
      letter-spacing: -0.02em;
      line-height: 1.2;
    }

    .section-title {
      font-size: var(--text-3xl);
      font-weight: 600;
      color: var(--neutral-900);
      margin-bottom: 0.5rem;
    }

    header {
      position: relative;
    }

    .premium-navbar {
      background: rgba(255, 255, 255, 0.92);
      backdrop-filter: blur(18px);
      border-bottom: 1px solid rgba(var(--sg-orange-rgb), 0.15);
      box-shadow: 0 8px 24px rgba(15, 23, 42, 0.05);
      transition: background 0.4s ease, box-shadow 0.4s ease;
      z-index: 1000;
    }

    body.dark-mode .premium-navbar {
      background: rgba(20, 24, 30, 0.88);
      border-bottom-color: rgba(255, 255, 255, 0.08);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.55);
    }

    .premium-navbar .navbar-brand {
      font-weight: 600;
      color: var(--neutral-900);
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .premium-navbar .navbar-brand span {
      font-size: 1.125rem;
      letter-spacing: -0.01em;
    }

    body.dark-mode .premium-navbar .navbar-brand {
      color: rgba(255, 255, 255, 0.9);
    }

    .premium-navbar .navbar-nav .nav-link {
      font-weight: 500;
      color: var(--neutral-600);
      padding: 0.65rem 1.1rem;
      border-radius: 999px;
      transition: color 0.3s ease, background-color 0.3s ease, transform 0.3s ease;
    }

    body.dark-mode .premium-navbar .navbar-nav .nav-link {
      color: rgba(255, 255, 255, 0.7);
    }

    .premium-navbar .navbar-nav .nav-link:hover {
      color: var(--sg-red);
      background: rgba(var(--sg-orange-rgb), 0.12);
      transform: translateY(-1px);
    }

    .premium-navbar .navbar-nav .nav-link.active {
      color: #fff;
      background: var(--sg-red);
      box-shadow: 0 10px 24px rgba(var(--sg-orange-rgb), 0.25);
    }

    body.dark-mode .premium-navbar .navbar-nav .nav-link.active {
      color: #fff;
    }

    .premium-navbar .navbar-toggler {
      border: none;
      color: var(--sg-red);
      padding: 0.35rem 0.65rem;
      border-radius: 12px;
      box-shadow: 0 4px 18px rgba(var(--sg-orange-rgb), 0.18);
      transition: transform 0.3s ease;
    }

    .premium-navbar .navbar-toggler:focus {
      box-shadow: 0 0 0 0.2rem rgba(var(--sg-orange-rgb), 0.3);
    }

    .premium-navbar .navbar-toggler:hover {
      transform: translateY(-1px);
    }

    .premium-navbar .navbar-toggler .material-icons {
      font-size: 1.4rem;
    }

    .section-card {
      background: #ffffff;
      border: 1px solid var(--neutral-200);
      border-radius: var(--border-radius);
      padding: 48px;
      box-shadow: var(--card-shadow);
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
      backdrop-filter: blur(10px);
    }

    .section-card:hover {
      box-shadow: var(--card-shadow-hover);
      transform: translateY(-4px);
      border-color: var(--neutral-300);
    }

    .section-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: linear-gradient(90deg, var(--sg-red) 0%, var(--accent-blue) 100%);
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .section-card:hover::before {
      opacity: 1;
    }

    h2.section-title {
      color: var(--sg-red);
    }

    .feature-description {
      background: var(--sg-red-soft);
      border: 1px solid rgba(var(--sg-orange-rgb), 0.35);
      color: #92400e;
    }

    .btn-primary {
      background: var(--sg-red);
      border-color: var(--sg-red);
      transition: transform 0.3s ease, box-shadow 0.3s ease, background-color 0.3s ease, border-color 0.3s ease;
    }

    .btn-primary:hover {
      background: var(--sg-red-dark);
      border-color: var(--sg-red-dark);
      transform: translateY(-1px);
      box-shadow: 0 12px 26px rgba(var(--sg-orange-rgb), 0.25);
    }

    .btn-outline-danger {
      color: var(--sg-red);
      border-color: rgba(var(--sg-orange-rgb), 0.55);
      transition: transform 0.3s ease, box-shadow 0.3s ease, background-color 0.3s ease;
    }

    .btn-outline-danger:hover {
      background: var(--sg-red);
      color: #fff;
      transform: translateY(-1px);
      box-shadow: 0 10px 20px rgba(var(--sg-orange-rgb), 0.25);
    }

    .btn-success {
      background: #059669;
      border: #059669;
    }

    .pill {
      display: inline-block;
      padding: .25rem .6rem;
      border-radius: 999px;
      font-size: .85rem;
      background: #f3f4f6;
      border: 1px solid #e5e7eb;
      color: #111827;
    }

    .output-box {
      margin-top: 16px;
      padding: 16px;
      background: #f9fafb;
      border-left: 4px solid var(--sg-red);
      border-radius: 8px;
      min-height: 100px;
    }

    .alert-card {
      border: 1px solid var(--sg-border);
      border-left-width: 4px;
      border-radius: 8px;
      padding: 12px;
    }

    .alert-disrupted {
      border-left-color: #ef4444;
    }

    .alert-normal {
      border-left-color: #16a34a;
    }

    .route-step {
      background: rgba(var(--sg-orange-rgb), 0.08);
      border-left: 4px solid var(--sg-red);
      border-radius: 14px;
      padding: 14px 18px;
      margin: .5rem 0;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      color: var(--neutral-900);
    }

    .route-step strong,
    .route-step small {
      color: var(--neutral-900);
    }

    .route-step:hover {
      transform: translateY(-3px);
      box-shadow: 0 12px 28px rgba(var(--sg-orange-rgb), 0.18);
    }

    .fare-result {
      background: linear-gradient(135deg, var(--sg-red) 0%, var(--sg-red-dark) 100%);
      color: #fff;
      padding: 18px;
      border-radius: 12px;
      text-align: center;
      font-size: 1.1rem;
      box-shadow: 0 18px 30px rgba(var(--sg-orange-rgb), 0.28);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .fare-result:hover {
      transform: translateY(-4px);
      box-shadow: 0 24px 42px rgba(var(--sg-orange-rgb), 0.32);
    }

    .mapboxgl-popup-content {
      border-radius: 12px !important;
    }

    .station-chip {
      font-weight: 600;
      color: var(--sg-red);
    }

    .form-select,
    .form-control {
      border: 2px solid #e5e7eb;
      border-radius: var(--border-radius-sm);
      padding: 12px 16px;
      font-size: 14px;
      transition: all 0.3s ease;
    }

    .form-select:focus,
    .form-control:focus {
      border-color: var(--sg-red);
      box-shadow: 0 0 0 .2rem rgba(220, 38, 38, .15);
      transform: translateY(-1px);
    }

    /* Neuralink-inspired Meetup Section */
    .meetup-container {
      background: var(--neutral-50);
      border-radius: var(--border-radius-lg);
      padding: 40px;
      margin-bottom: 40px;
      border: 1px solid var(--neutral-200);
      position: relative;
      overflow: hidden;
    }

    .meetup-container::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, rgba(var(--sg-orange-rgb), 0.02) 0%, rgba(14, 165, 233, 0.02) 100%);
      pointer-events: none;
    }

    .person-card {
      background: #ffffff;
      border: 1px solid var(--neutral-200);
      border-radius: var(--border-radius);
      padding: 32px;
      margin-bottom: 24px;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
      backdrop-filter: blur(10px);
    }

    .person-card:hover {
      border-color: var(--neutral-300);
      box-shadow: 0 8px 40px rgba(0, 0, 0, 0.06);
      transform: translateY(-3px);
    }

    .person-card.active {
      border-color: var(--sg-red);
      background: linear-gradient(135deg, #ffffff 0%, rgba(var(--sg-orange-rgb), 0.02) 100%);
      box-shadow: 0 8px 40px rgba(var(--sg-orange-rgb), 0.08);
    }

    .person-card.active::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: var(--primary-gradient);
    }

    .person-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
    }

    .person-avatar {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--sg-red) 0%, var(--accent-blue) 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 20px;
      box-shadow: 0 8px 24px rgba(var(--sg-orange-rgb), 0.15);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }

    .person-avatar::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.2) 0%, rgba(255, 255, 255, 0) 100%);
      pointer-events: none;
    }

    .person-info h6 {
      margin: 0;
      color: var(--neutral-900);
      font-weight: 600;
      font-size: var(--text-lg);
      letter-spacing: -0.01em;
    }

    .person-info small {
      color: var(--neutral-500);
      font-size: var(--text-sm);
      font-weight: 400;
    }

    .station-selector {
      position: relative;
    }

    .station-selector .form-select {
      background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23343a40' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m1 6 7 7 7-7'/%3e%3c/svg%3e");
      background-repeat: no-repeat;
      background-position: right 12px center;
      background-size: 16px 12px;
      padding-right: 40px;
    }

    .meetup-actions {
      display: flex;
      gap: 12px;
      margin-top: 24px;
      flex-wrap: wrap;
    }

    .btn-modern {
      background: linear-gradient(135deg, var(--sg-red) 0%, var(--sg-red-dark) 100%);
      border: none;
      border-radius: var(--border-radius-sm);
      padding: 16px 32px;
      font-weight: 500;
      font-size: var(--text-base);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      display: inline-flex;
      align-items: center;
      gap: 12px;
      text-decoration: none;
      color: white;
      letter-spacing: -0.01em;
      position: relative;
      overflow: hidden;
    }

    .btn-modern::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s;
    }

    .btn-modern:hover::before {
      left: 100%;
    }

    .btn-modern:hover {
      transform: translateY(-3px);
      box-shadow: 0 12px 40px rgba(var(--sg-orange-rgb), 0.25);
      color: white;
    }

    .btn-modern.secondary {
      background: var(--neutral-50);
      color: var(--neutral-700);
      border: 1px solid var(--neutral-300);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
    }

    .btn-modern.secondary:hover {
      background: var(--neutral-100);
      border-color: var(--sg-red);
      color: var(--sg-red);
      box-shadow: 0 8px 24px rgba(var(--sg-orange-rgb), 0.1);
    }

    .meetup-results {
      background: #ffffff;
      border: 1px solid var(--neutral-200);
      border-radius: var(--border-radius);
      padding: 40px;
      margin-top: 40px;
      position: relative;
      overflow: hidden;
      box-shadow: 0 8px 40px rgba(0, 0, 0, 0.06);
      backdrop-filter: blur(10px);
    }

    .meetup-results::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--sg-red) 0%, var(--accent-green) 100%);
    }

    .meeting-point {
      background: linear-gradient(135deg, var(--sg-red) 0%, var(--accent-blue) 100%);
      color: white;
      padding: 32px;
      border-radius: var(--border-radius);
      text-align: center;
      margin-bottom: 32px;
      position: relative;
      overflow: hidden;
      box-shadow: 0 12px 40px rgba(var(--sg-orange-rgb), 0.2);
    }

    .meeting-point::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0) 100%);
      pointer-events: none;
    }

    .meeting-point h4 {
      font-size: var(--text-2xl);
      font-weight: 600;
      margin-bottom: 8px;
      letter-spacing: -0.02em;
    }

    .meeting-point p {
      opacity: 0.9;
      font-size: var(--text-base);
      margin: 0;
    }

    .travel-times {
      display: grid;
      gap: 12px;
      margin-top: 20px;
    }

    .travel-time-item {
      background: var(--neutral-50);
      border: 1px solid var(--neutral-200);
      border-radius: var(--border-radius-sm);
      padding: 20px;
      display: flex;
      align-items: center;
      gap: 16px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }

    .travel-time-item:hover {
      background: #ffffff;
      border-color: var(--neutral-300);
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.04);
      transform: translateY(-2px);
    }

    .time-badge {
      background: linear-gradient(135deg, var(--sg-red) 0%, var(--accent-blue) 100%);
      color: white;
      padding: 8px 16px;
      border-radius: 24px;
      font-size: var(--text-sm);
      font-weight: 600;
      min-width: 80px;
      text-align: center;
      box-shadow: 0 4px 12px rgba(var(--sg-orange-rgb), 0.15);
      letter-spacing: -0.01em;
    }

    .quick-stations {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 16px;
    }

    .quick-station-btn {
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 20px;
      padding: 6px 12px;
      font-size: 12px;
      color: #475569;
      text-decoration: none;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .quick-station-btn:hover {
      background: var(--sg-red);
      color: white;
      border-color: var(--sg-red);
      transform: translateY(-1px);
    }

    .floating-action {
      position: fixed;
      bottom: 24px;
      right: 24px;
      width: 56px;
      height: 56px;
      background: var(--primary-gradient);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 24px;
      box-shadow: 0 8px 25px rgba(var(--sg-orange-rgb), 0.3);
      cursor: pointer;
      transition: all 0.3s ease;
      z-index: 1000;
    }

    .floating-action:hover {
      transform: scale(1.1);
      box-shadow: 0 12px 35px rgba(var(--sg-orange-rgb), 0.4);
    }

    /* ===== PROFILE / AUTH SECTIONS ===== */
    #profile {
      margin: 2rem auto;
    }

    #auth-section,
    #password-reset-section,
    #dashboard-section {
      background: #ffffff;
      border: 1px solid var(--neutral-200);
      border-radius: var(--border-radius);
      padding: 32px;
      box-shadow: var(--card-shadow);
      transition: all 0.3s ease;
    }

    #auth-section h2,
    #password-reset-section h2,
    #dashboard-section h2 {
      font-size: var(--text-2xl);
      color: var(--sg-red);
      margin-bottom: 1.5rem;
      text-align: center;
    }

    input[type="text"],
    input[type="email"],
    input[type="password"],
    select {
      width: 100%;
      padding: 12px 16px;
      margin-bottom: 1rem;
      border-radius: var(--border-radius-sm);
      border: 2px solid var(--neutral-200);
      font-size: var(--text-base);
      transition: all 0.3s ease;
    }

    input:focus,
    select:focus {
      border-color: var(--sg-red);
      box-shadow: 0 0 0 0.2rem rgba(220, 38, 38, 0.15);
      outline: none;
    }

    button {
      display: block;
      width: 100%;
      padding: 12px 16px;
      font-size: var(--text-base);
      font-weight: 600;
      border-radius: var(--border-radius-sm);
      border: none;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    #login-btn,
    #send-reset-email-btn {
      background: var(--sg-red);
      color: white;
    }

    #login-btn:hover,
    #send-reset-email-btn:hover {
      background: var(--sg-red-dark);
    }

    #register-btn,
    #saveProfileBtn,
    #addFavoriteBtn,
    #logout-btn {
      background: #ffffff;
      border: 2px solid var(--sg-red);
      color: var(--sg-red);
    }

    #register-btn:hover,
    #saveProfileBtn:hover,
    #addFavoriteBtn:hover,
    #logout-btn:hover {
      background: var(--sg-red);
      color: white;
      box-shadow: var(--card-shadow-hover);
      transform: translateY(-2px);
    }

    #password-requirements {
      background: var(--sg-red-soft);
      border-left: 4px solid var(--sg-red);
      padding: 0.75rem;
      font-size: var(--text-sm);
      margin-bottom: 1rem;
    }

    #password-requirements span.met {
      color: var(--accent-green);
    }

    #password-requirements span.not-met {
      color: var(--sg-red-dark);
    }

    /* Container for login + register */
    .auth-buttons {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 1rem;
    }

    /* Login button: stretch to fill remaining space */
    #login-btn {
      flex: 1 1 auto;
      /* grow, shrink, auto basis */
      min-width: 0;
      /* allow it to shrink in flex */
      width: auto !important;
      /* override global width:100% */
      display: inline-flex !important;
      /* override block */
      justify-content: center;
      padding: 12px 0;
      background: var(--sg-red);
      color: #fff;
      border-radius: var(--border-radius-sm);
      font-weight: 600;
      border: none;
      cursor: pointer;
    }

    #auth-section #register-btn {
      flex: 0 0 auto;
      width: auto !important;
      display: inline-flex !important;
      background: none !important;
      border: none !important;
      color: #777 !important;
      font-weight: 600 !important;
      cursor: pointer !important;
      padding: 0.5rem 1rem !important;
      transition: color 0.3s, text-decoration 0.3s !important;
    }

    #auth-section #register-btn:hover {
      color: var(--sg-red-dark) !important;
      text-decoration: underline !important;
    }

    #favoriteList {
      overflow-y: auto;
      max-height: 400px;
      /* optional: limits height */
      padding: 0;
      list-style: none;
      margin: 0;
    }

    /* Each favorite item */
    #favoriteList li {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background-color: #fff;
      /* white background like cards */
      border: 1px solid #ddd;
      border-radius: 10px;
      padding: 10px 15px;
      margin-bottom: 10px;
      transition: background-color 0.2s, transform 0.2s;
      gap: 10px;
    }

    /* Hover effect */
    #favoriteList li:hover {
      background-color: #f5f5f5;
      transform: scale(1.02);
    }

    /* Station label styling */
    #favoriteList li strong {
      font-weight: 600;
      color: #333;
      margin-right: 5px;
    }

    /* Station name styling */
    #favoriteList li span {
      color: #555;
      flex: 1;
      /* takes up remaining space */
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Remove button styling */
    #favoriteList li button {
      background-color: var(--sg-red) !important;
      color: #fff !important;
      border: none !important;
      border-radius: 8px !important;
      padding: 4px 10px !important;
      cursor: pointer !important;
      font-size: 0.85rem !important;
      flex-shrink: 0 !important;
      width: auto !important;
      /* override full-width */
      display: inline-block !important;
      /* override block */
      margin-left: 10px;
      /* small spacing from station name */
      margin-top: 0px;
    }

    #favoriteList li button:hover {
      background-color: var(--sg-red-dark) !important;
      transform: translateY(-1px);
    }



    #error-message,
    #success-message {
      margin-top: 1rem;
      text-align: center;
      font-weight: 600;
    }

    #error-message {
      color: var(--sg-red-dark);
    }

    #success-message {
      color: var(--accent-green);
    }


    /* Premium Animations */
    @keyframes pulse {
      0% {
        transform: scale(1);
      }

      50% {
        transform: scale(1.05);
      }

      100% {
        transform: scale(1);
      }
    }

    @keyframes slideInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes fadeInScale {
      from {
        opacity: 0;
        transform: scale(0.9);
      }

      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    /* Map Interaction Animations */
    @keyframes mapClickRipple {
      0% {
        transform: scale(0);
        opacity: 1;
      }

      100% {
        transform: scale(4);
        opacity: 0;
      }
    }

    @keyframes stationSelect {
      0% {
        transform: scale(1);
        box-shadow: 0 0 0 0 rgba(var(--sg-orange-rgb), 0.4);
      }

      50% {
        transform: scale(1.2);
        box-shadow: 0 0 0 20px rgba(var(--sg-orange-rgb), 0.1);
      }

      100% {
        transform: scale(1);
        box-shadow: 0 0 0 0 rgba(var(--sg-orange-rgb), 0);
      }
    }

    @keyframes loadingPulse {

      0%,
      100% {
        opacity: 0.4;
        transform: scale(0.95);
      }

      50% {
        opacity: 1;
        transform: scale(1.05);
      }
    }

    @keyframes loadingDots {

      0%,
      20% {
        opacity: 0;
        transform: scale(0.8);
      }

      50% {
        opacity: 1;
        transform: scale(1);
      }

      80%,
      100% {
        opacity: 0;
        transform: scale(0.8);
      }
    }

    @keyframes progressBar {
      0% {
        width: 0%;
        opacity: 0;
      }

      10% {
        opacity: 1;
      }

      90% {
        opacity: 1;
      }

      100% {
        width: 100%;
        opacity: 0;
      }
    }

    @keyframes successCheckmark {
      0% {
        transform: scale(0) rotate(0deg);
        opacity: 0;
      }

      50% {
        transform: scale(1.2) rotate(180deg);
        opacity: 1;
      }

      100% {
        transform: scale(1) rotate(360deg);
        opacity: 1;
      }
    }

    .animate-slide-in {
      animation: slideInUp 0.5s ease-out;
    }

    .animate-fade-in-scale {
      animation: fadeInScale 0.4s ease-out;
    }

    /* Map Animation Classes */
    .map-click-ripple {
      position: absolute;
      border-radius: 50%;
      background: rgba(var(--sg-orange-rgb), 0.3);
      pointer-events: none;
      animation: mapClickRipple 0.6s ease-out;
    }

    .station-selected {
      animation: stationSelect 0.8s ease-out;
    }

    /* Loading Animation Classes */
    .loading-pulse {
      animation: loadingPulse 1.5s ease-in-out infinite;
    }

    .loading-dots {
      display: inline-flex;
      gap: 4px;
    }

    .loading-dots span {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--sg-red);
      animation: loadingDots 1.4s ease-in-out infinite;
    }

    .loading-dots span:nth-child(2) {
      animation-delay: 0.2s;
    }

    .loading-dots span:nth-child(3) {
      animation-delay: 0.4s;
    }

    .progress-bar {
      position: relative;
      height: 3px;
      background: var(--neutral-200);
      border-radius: 2px;
      overflow: hidden;
      margin: 20px 0;
    }

    .progress-bar::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      background: linear-gradient(90deg, var(--sg-red) 0%, var(--accent-blue) 100%);
      border-radius: 2px;
      animation: progressBar 2s ease-out;
    }

    .success-checkmark {
      animation: successCheckmark 0.8s ease-out;
    }

    /* Capybara Loader Animation - From Uiverse.io by Novaxlo */
    .capybaraloader {
      width: 14em;
      height: 10em;
      position: relative;
      z-index: 1;
      --color: rgb(249, 115, 22);
      --color2: rgb(194, 65, 12);
      transform: scale(0.75);
    }

    .capybara {
      width: 100%;
      height: 7.5em;
      position: relative;
      z-index: 1;
    }

    .loader {
      width: 100%;
      height: 2.5em;
      position: relative;
      z-index: 1;
      overflow: hidden;
    }

    .capy {
      width: 85%;
      height: 100%;
      background: linear-gradient(var(--color), 90%, var(--color2));
      border-radius: 45%;
      position: relative;
      z-index: 1;
      animation: movebody 1s linear infinite;
    }

    .capyhead {
      width: 7.5em;
      height: 7em;
      bottom: 0em;
      right: 0em;
      position: absolute;
      background-color: var(--color);
      z-index: 3;
      border-radius: 3.5em;
      box-shadow: -1em 0em var(--color2);
      animation: movebody 1s linear infinite;
    }

    .capyear {
      width: 2em;
      height: 2em;
      background: linear-gradient(-45deg, var(--color), 90%, var(--color2));
      top: 0em;
      left: 0em;
      border-radius: 100%;
      position: absolute;
      overflow: hidden;
      z-index: 3;
    }

    .capyear:nth-child(2) {
      left: 5em;
      background: linear-gradient(25deg, var(--color), 90%, var(--color2));
    }

    .capyear2 {
      width: 100%;
      height: 1em;
      background-color: var(--color2);
      bottom: 0em;
      left: 0.5em;
      border-radius: 100%;
      position: absolute;
      transform: rotate(-45deg);
    }

    .capymouth {
      width: 3.5em;
      height: 2em;
      background-color: var(--color2);
      position: absolute;
      bottom: 0em;
      left: 2.5em;
      border-radius: 50%;
      display: flex;
      justify-content: space-around;
      align-items: center;
      padding: 0.5em;
    }

    .capylips {
      width: 0.25em;
      height: 0.75em;
      border-radius: 100%;
      transform: rotate(-45deg);
      background-color: var(--color);
    }

    .capylips:nth-child(2) {
      transform: rotate(45deg);
    }

    .capyeye {
      width: 2em;
      height: 0.5em;
      background-color: var(--color2);
      position: absolute;
      bottom: 3.5em;
      left: 1.5em;
      border-radius: 5em;
      transform: rotate(45deg);
    }

    .capyeye:nth-child(4) {
      transform: rotate(-45deg);
      left: 5.5em;
      width: 1.75em;
    }

    .capyleg {
      width: 6em;
      height: 5em;
      bottom: 0em;
      left: 0em;
      position: absolute;
      background: linear-gradient(var(--color), 95%, var(--color2));
      z-index: 2;
      border-radius: 2em;
      animation: movebody 1s linear infinite;
    }

    .capyleg2 {
      width: 1.75em;
      height: 3em;
      bottom: 0em;
      left: 3.25em;
      position: absolute;
      background: linear-gradient(var(--color), 80%, var(--color2));
      z-index: 2;
      border-radius: 0.75em;
      box-shadow: inset 0em -0.5em var(--color2);
      animation: moveleg 1s linear infinite;
    }

    .capyleg2:nth-child(3) {
      width: 1.25em;
      left: 0.5em;
      height: 2em;
      animation: moveleg2 1s linear infinite 0.075s;
    }

    @keyframes moveleg {
      0% {
        transform: rotate(-45deg) translateX(-5%);
      }

      50% {
        transform: rotate(45deg) translateX(5%);
      }

      100% {
        transform: rotate(-45deg) translateX(-5%);
      }
    }

    @keyframes moveleg2 {
      0% {
        transform: rotate(45deg);
      }

      50% {
        transform: rotate(-45deg);
      }

      100% {
        transform: rotate(45deg);
      }
    }

    @keyframes movebody {
      0% {
        transform: translateX(0%);
      }

      50% {
        transform: translateX(2%);
      }

      100% {
        transform: translateX(0%);
      }
    }

    .loaderline {
      width: 50em;
      height: 0.5em;
      border-top: 0.5em dashed var(--color2);
      animation: moveline 10s linear infinite;
    }

    @keyframes moveline {
      0% {
        transform: translateX(0%);
        opacity: 0%;
      }

      5% {
        opacity: 100%;
      }

      95% {
        opacity: 100%;
      }

      100% {
        opacity: 0%;
        transform: translateX(-70%);
      }
    }

    /* Map overlay for capybara loading */
    .map-loading-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255, 255, 255, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      backdrop-filter: blur(2px);
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .map-loading-overlay.show {
      opacity: 1;
      visibility: visible;
    }

    .map-loading-content {
      text-align: center;
      color: var(--neutral-800);
    }

    .map-loading-content h6 {
      margin-top: 20px;
      font-size: var(--text-lg);
      font-weight: 600;
    }

    .map-loading-content p {
      margin-top: 8px;
      font-size: var(--text-sm);
      color: var(--neutral-600);
    }

    /* Enhanced hover effects */
    .person-card:hover .person-avatar {
      transform: scale(1.1);
      box-shadow: 0 6px 20px rgba(var(--sg-orange-rgb), 0.4);
    }

    .btn-modern:active {
      transform: translateY(0);
    }

    /* Loading states */
    .loading-shimmer {
      background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
    }

    @keyframes shimmer {
      0% {
        background-position: -200% 0;
      }

      100% {
        background-position: 200% 0;
      }
    }

    /* Success states */
    .success-glow {
      box-shadow: 0 0 20px rgba(34, 197, 94, 0.3);
      border-color: #22c55e;
    }

    /* Error states */
    .error-shake {
      animation: shake 0.5s ease-in-out;
    }

    @keyframes shake {

      0%,
      100% {
        transform: translateX(0);
      }

      25% {
        transform: translateX(-5px);
      }

      75% {
        transform: translateX(5px);
      }
    }

    .feature-result-animate {
      animation: fadeSlideUp 0.6s cubic-bezier(0.25, 0.8, 0.25, 1) forwards;
    }

    @keyframes fadeSlideUp {
      0% {
        opacity: 0;
        transform: translateY(22px) scale(0.97);
      }

      60% {
        opacity: 1;
      }

      100% {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    /* === WOW-FACTOR ENHANCEMENTS === */
    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background: linear-gradient(120deg, rgba(var(--sg-orange-rgb), 0.15), rgba(0, 150, 69, 0.12), rgba(250, 158, 13, 0.1));
      background-size: 180% 180%;
      animation: bg-shift 18s ease infinite;
      z-index: -2;
    }

    body::after {
      content: '';
      position: fixed;
      inset: 0;
      background:
        radial-gradient(circle at 20% 20%, rgba(153, 0, 170, 0.18), transparent 45%),
        radial-gradient(circle at 80% 30%, rgba(0, 94, 196, 0.18), transparent 50%),
        radial-gradient(circle at 50% 80%, rgba(255, 94, 0, 0.12), transparent 40%);
      filter: blur(60px);
      opacity: 0.9;
      pointer-events: none;
      z-index: -1;
      transition: opacity 0.6s ease;
    }

    @keyframes bg-shift {
      0% {
        transform: translate3d(0, 0, 0);
      }

      50% {
        transform: translate3d(-4%, -3%, 0);
      }

      100% {
        transform: translate3d(0, 0, 0);
      }
    }

    body.dark-mode {
      background: var(--neutral-900);
      color: var(--neutral-100);
    }

    body.dark-mode::before {
      background: linear-gradient(135deg, rgba(var(--sg-orange-rgb), 0.35), rgba(0, 94, 196, 0.3), rgba(153, 0, 170, 0.25));
    }

    body.dark-mode::after {
      opacity: 0.55;
    }

    body.dark-mode .section-card {
      background: rgba(26, 29, 36, 0.75);
      border-color: rgba(255, 255, 255, 0.08);
      box-shadow: 0 14px 32px rgba(0, 0, 0, 0.45);
    }


    .live-tools {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      padding: 20px 24px;
      border-radius: 20px;
      background: rgba(255, 255, 255, 0.72);
      border: 1px solid rgba(216, 222, 233, 0.5);
      box-shadow: var(--card-shadow);
      backdrop-filter: blur(12px);
      margin-bottom: 24px;
    }

    body.dark-mode .live-tools {
      background: rgba(19, 21, 25, 0.75);
      border-color: rgba(255, 255, 255, 0.06);
      box-shadow: 0 12px 24px rgba(0, 0, 0, 0.45);
    }

    .live-ticker-card {
      position: relative;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 1.5rem;
      padding: 24px 28px;
      border-radius: 24px;
      background: linear-gradient(135deg, rgba(var(--sg-orange-rgb), 0.12), rgba(255, 255, 255, 0.95));
      border: 1px solid rgba(var(--sg-orange-rgb), 0.25);
      box-shadow: 0 18px 40px rgba(var(--sg-orange-rgb), 0.18);
      overflow: hidden;
    }

    .live-ticker-card::after {
      content: '';
      position: absolute;
      inset: -40% 60% 40% -40%;
      background: radial-gradient(circle, rgba(var(--sg-orange-rgb), 0.25), transparent 55%);
      opacity: 0.5;
      transform: rotate(12deg);
      pointer-events: none;
    }

    .live-ticker-card>* {
      position: relative;
      z-index: 1;
    }

    body.dark-mode .live-ticker-card {
      background: linear-gradient(135deg, rgba(24, 27, 33, 0.9), rgba(15, 17, 21, 0.85));
      border-color: rgba(var(--sg-orange-rgb), 0.35);
      box-shadow: 0 20px 36px rgba(0, 0, 0, 0.55);
    }

    .live-ticker-card .ticker-label {
      font-size: 0.75rem;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: var(--sg-red);
      margin-bottom: 0.35rem;
    }

    .live-ticker-card .ticker-station {
      font-size: var(--text-2xl);
      font-weight: 600;
      color: var(--neutral-900);
      letter-spacing: -0.01em;
    }

    body.dark-mode .live-ticker-card .ticker-station {
      color: rgba(255, 255, 255, 0.92);
    }

    .live-ticker-card .ticker-line {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      font-weight: 600;
      font-size: var(--text-sm);
    }

    .live-ticker-card .ticker-line .material-icons {
      font-size: 1.1rem;
    }

    .live-ticker-card .ticker-times {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      align-items: center;
      justify-content: flex-end;
      min-width: 180px;
    }

    .ticker-pill {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      padding: 8px 16px;
      border-radius: 999px;
      font-weight: 600;
      font-size: var(--text-sm);
      border: 1px solid currentColor;
      background: rgba(var(--sg-orange-rgb), 0.1);
      box-shadow: 0 10px 20px rgba(var(--sg-orange-rgb), 0.15);
    }

    body.dark-mode .ticker-pill {
      background: rgba(var(--sg-orange-rgb), 0.22);
      color: #fff;
      box-shadow: 0 12px 24px rgba(0, 0, 0, 0.45);
    }

    .live-ticker-card.cycle {
      animation: tickerSwap 0.6s ease both;
    }

    @keyframes tickerSwap {
      0% {
        opacity: 0;
        transform: translateY(18px);
      }

      100% {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .theme-toggle {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      border-radius: 999px;
      padding: 6px 14px;
      background: rgba(var(--sg-orange-rgb), 0.08);
      color: var(--sg-red);
      cursor: pointer;
      transition: background 0.35s ease, color 0.35s ease;
    }

    .theme-toggle .material-icons {
      font-size: 1.2rem;
    }

    .theme-toggle.active {
      background: var(--sg-red);
      color: #fff;
      box-shadow: 0 14px 24px rgba(var(--sg-orange-rgb), 0.35);
    }

    body.dark-mode .theme-toggle {
      background: rgba(255, 255, 255, 0.08);
      color: rgba(255, 255, 255, 0.82);
    }

    .live-clock {
      font-size: var(--text-lg);
      font-weight: 600;
      letter-spacing: 0.08em;
    }

    .live-clock span {
      font-variant-numeric: tabular-nums;
    }

    .hover-float {
      transition: transform 0.45s ease;
    }

    .hover-float:hover {
      transform: translateY(-4px);
    }

    .live-arrivals-grid {
      display: grid;
      gap: 1.5rem;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    }

    .arrival-card {
      position: relative;
      background: rgba(255, 255, 255, 0.82);
      border-radius: 20px;
      padding: 24px;
      border: 1px solid rgba(216, 222, 233, 0.6);
      box-shadow: var(--card-shadow);
      overflow: hidden;
      backdrop-filter: blur(12px);
      transition: transform 0.45s cubic-bezier(0.25, 0.8, 0.25, 1), box-shadow 0.45s ease, border-color 0.45s ease;
    }

    .arrival-card:hover {
      transform: translateY(-6px) scale(1.01);
      box-shadow: var(--card-shadow-hover);
      border-color: rgba(var(--sg-orange-rgb), 0.25);
    }

    .arrival-card::after {
      content: '';
      position: absolute;
      inset: -40% 40% 60% -40%;
      opacity: 0;
      background: radial-gradient(circle, rgba(255, 255, 255, 0.35), transparent 55%);
      transform: rotate(15deg);
      transition: opacity 0.6s ease;
    }

    .arrival-card:hover::after {
      opacity: 1;
    }

    body.dark-mode .arrival-card {
      background: rgba(19, 21, 25, 0.85);
      border-color: rgba(var(--sg-orange-rgb), 0.15);
    }

    .arrival-card.arriving-soon {
      animation: pulse-highlight 1.8s ease-in-out infinite;
    }

    @keyframes pulse-highlight {

      0%,
      100% {
        box-shadow: 0 10px 30px rgba(var(--sg-orange-rgb), 0.25);
      }

      50% {
        box-shadow: 0 18px 40px rgba(var(--sg-orange-rgb), 0.4);
      }
    }

    .arrival-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      gap: 0.75rem;
    }

    .arrival-header .station-name {
      font-size: var(--text-xl);
      font-weight: 600;
    }

    .arrival-header .tag {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      padding: 6px 12px;
      border-radius: 999px;
      background: rgba(var(--sg-orange-rgb), 0.08);
      color: var(--sg-red);
    }

    body.dark-mode .arrival-header .tag {
      background: rgba(255, 255, 255, 0.08);
      color: rgba(255, 255, 255, 0.75);
    }

    .favorite-toggle {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border: none;
      width: 34px;
      height: 34px;
      border-radius: 50%;
      background: rgba(var(--sg-orange-rgb), 0.08);
      color: var(--sg-red);
      transition: transform 0.35s ease, background 0.35s ease, color 0.35s ease;
    }

    .favorite-toggle.active {
      background: var(--sg-red);
      color: #fff;
      box-shadow: 0 10px 20px rgba(var(--sg-orange-rgb), 0.35);
    }

    .favorite-toggle:hover {
      transform: scale(1.1);
    }

    body.dark-mode .favorite-toggle {
      background: rgba(255, 255, 255, 0.12);
      color: rgba(255, 255, 255, 0.75);
    }

    .line-section {
      display: grid;
      gap: 12px;
      padding-top: 8px;
    }

    .line-label {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 0.75rem;
      font-weight: 600;
    }

    .line-label .subtle {
      font-size: 0.75rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      opacity: 0.7;
    }

    .arrival-row {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .arrival-row .arrival-details {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 0.45rem;
    }

    .arrival-row .train-icon {
      width: 36px;
      height: 36px;
      border-radius: 12px;
      display: grid;
      place-items: center;
      font-size: 1.2rem;
      background: rgba(var(--sg-orange-rgb), 0.12);
      box-shadow: inset 0 0 0 1px rgba(var(--sg-orange-rgb), 0.18);
    }

    .arrival-row .countdown {
      font-weight: 600;
      min-width: 78px;
    }

    .arrival-row .progress-bar {
      flex: 1;
      height: 10px;
      border-radius: 999px;
      background: rgba(var(--sg-orange-rgb), 0.1);
      overflow: hidden;
      position: relative;
    }

    .arrival-row .progress-fill {
      position: absolute;
      inset: 0;
      border-radius: inherit;
      transform-origin: left center;
      transform: scaleX(0);
      transition: transform 0.9s ease;
    }

    .arrival-row .progress-glow {
      position: absolute;
      inset: -40%;
      opacity: 0.15;
      background: radial-gradient(circle, currentColor, transparent 65%);
      filter: blur(10px);
    }

    .status-pill {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: var(--text-xs);
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .status-pill.status-on-time {
      background: rgba(var(--sg-orange-rgb), 0.12);
      color: var(--sg-red);
    }

    .status-pill.status-arriving {
      background: rgba(34, 197, 94, 0.15);
      color: #15803d;
      animation: statusPulse 1.6s ease-in-out infinite;
    }

    .status-pill.status-departing {
      background: rgba(59, 130, 246, 0.18);
      color: #1d4ed8;
      animation: statusPulse 1.2s ease-in-out infinite;
    }

    .status-pill.status-delayed {
      background: rgba(239, 68, 68, 0.18);
      color: #991b1b;
      box-shadow: 0 0 18px rgba(239, 68, 68, 0.25);
    }

    @keyframes statusPulse {

      0%,
      100% {
        transform: scale(1);
      }

      50% {
        transform: scale(1.05);
      }
    }

    .hero {
      position: relative;
      padding: 88px 0 72px;
      display: grid;
      gap: 48px;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      align-items: center;
    }

    .hero-intro h1 {
      font-size: clamp(2.8rem, 4vw, 3.6rem);
      margin-bottom: 1.25rem;
    }

    .hero-intro p {
      font-size: var(--text-lg);
      color: rgba(17, 24, 39, 0.78);
      max-width: 520px;
      margin-bottom: 2rem;
    }

    body.dark-mode .hero-intro p {
      color: rgba(255, 255, 255, 0.75);
    }

    .hero-cta {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      align-items: center;
    }

    .hero-cta .btn {
      padding: 14px 28px;
      border-radius: 14px;
      font-weight: 600;
      letter-spacing: 0.04em;
    }

    .hero-illustration {
      position: relative;
      min-height: 320px;
      border-radius: 24px;
      padding: 32px;
      background: linear-gradient(135deg, rgba(var(--sg-orange-rgb), 0.35), rgba(0, 150, 69, 0.2), rgba(0, 94, 196, 0.28));
      box-shadow: 0 24px 60px rgba(var(--sg-orange-rgb), 0.35);
      overflow: hidden;
    }

    .hero-map {
      position: absolute;
      inset: 12%;
      border-radius: 18px;
      background: url('https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?auto=format&fit=crop&w=930&q=80') center/cover;
      filter: grayscale(10%) contrast(105%) brightness(110%);
      opacity: 0.35;
    }

    .hero-train {
      position: relative;
      width: 220px;
      margin: 0 auto;
      padding: 20px 26px;
      border-radius: 18px;
      background: rgba(255, 255, 255, 0.9);
      box-shadow: 0 12px 35px rgba(0, 0, 0, 0.18);
      text-align: center;
      animation: float 4.8s ease-in-out infinite;
    }

    .hero-train .material-icons {
      font-size: 42px;
      color: var(--sg-red);
      text-shadow: 0 8px 20px rgba(var(--sg-orange-rgb), 0.45);
      animation: glow 2.4s ease-in-out infinite alternate;
    }

    .hero-train .tagline {
      font-size: 0.9rem;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: rgba(17, 24, 39, 0.65);
      margin-top: 18px;
    }

    .floating-pill {
      position: absolute;
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      padding: 10px 16px;
      border-radius: 999px;
      font-size: 0.9rem;
      background: rgba(255, 255, 255, 0.85);
      color: var(--sg-red);
      box-shadow: 0 12px 20px rgba(var(--sg-orange-rgb), 0.15);
      animation: float 5.2s ease-in-out infinite;
    }

    .hero-illustration .floating-pill:nth-of-type(1) {
      top: 30px;
      left: 12%;
      animation-delay: 0.2s;
    }

    .hero-illustration .floating-pill:nth-of-type(2) {
      bottom: 40px;
      right: 10%;
      animation-delay: 0.9s;
    }

    .hero-illustration .floating-pill:nth-of-type(3) {
      top: 140px;
      right: 18%;
      animation-delay: 1.5s;
    }

    body.dark-mode .hero-illustration {
      background: linear-gradient(135deg, rgba(var(--sg-orange-rgb), 0.55), rgba(0, 94, 196, 0.45), rgba(153, 0, 170, 0.45));
      box-shadow: 0 24px 40px rgba(0, 0, 0, 0.55);
    }

    body.dark-mode .hero-train {
      background: rgba(15, 17, 21, 0.85);
      color: rgba(255, 255, 255, 0.85);
    }

    body.dark-mode .floating-pill {
      background: rgba(15, 17, 21, 0.82);
      color: rgba(255, 255, 255, 0.82);
      box-shadow: 0 14px 28px rgba(0, 0, 0, 0.45);
    }

    @keyframes float {

      0%,
      100% {
        transform: translateY(0px);
      }

      50% {
        transform: translateY(-12px);
      }
    }

    @keyframes glow {
      0% {
        text-shadow: 0 8px 20px rgba(var(--sg-orange-rgb), 0.45);
      }

      100% {
        text-shadow: 0 16px 35px rgba(var(--sg-orange-rgb), 0.65);
      }
    }

    .gradient-divider {
      height: 1px;
      margin: 28px 0;
      background: linear-gradient(90deg, transparent, rgba(var(--sg-orange-rgb), 0.35), rgba(0, 94, 196, 0.35), transparent);
    }

    .timings-panel {
      border: 1px solid rgba(var(--sg-orange-rgb), 0.25);
      border-radius: 20px;
      background: rgba(255, 255, 255, 0.85);
      box-shadow: 0 18px 40px rgba(var(--sg-orange-rgb), 0.18);
      backdrop-filter: blur(14px);
    }

    body.dark-mode .timings-panel {
      background: rgba(24, 27, 33, 0.9);
      border-color: rgba(var(--sg-orange-rgb), 0.35);
    }

    .timings-panel .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 1rem;
      padding: 20px 24px;
    }

    .timings-panel .panel-header h5 {
      margin: 0;
      font-weight: 600;
      color: var(--sg-red);
    }

    .timings-filters {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      padding: 0 24px 20px;
    }

    .timings-filters .form-control,
    .timings-filters .form-select {
      background: rgba(255, 255, 255, 0.92);
    }

    body.dark-mode .timings-filters .form-control,
    body.dark-mode .timings-filters .form-select {
      background: rgba(15, 17, 21, 0.85);
      color: rgba(255, 255, 255, 0.82);
      border-color: rgba(255, 255, 255, 0.1);
    }

    .timings-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 1.25rem;
      padding: 0 24px 24px;
    }

    .timing-card {
      border: 1px solid rgba(var(--sg-orange-rgb), 0.18);
      border-radius: 16px;
      padding: 18px;
      background: rgba(255, 255, 255, 0.92);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      display: flex;
      flex-direction: column;
      gap: 0.6rem;
    }

    .timing-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 16px 28px rgba(var(--sg-orange-rgb), 0.18);
    }

    body.dark-mode .timing-card {
      background: rgba(19, 22, 28, 0.92);
      border-color: rgba(255, 255, 255, 0.08);
    }

    .timing-card .station-code {
      font-size: var(--text-xs);
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: rgba(var(--sg-orange-rgb), 1);
    }

    .timing-card .station-name {
      font-size: var(--text-lg);
      font-weight: 600;
      letter-spacing: -0.01em;
    }

    .timing-card .time-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: var(--text-sm);
    }

    .timing-card .time-row span {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      font-weight: 500;
    }

    /* ===== AUTH SECTIONS ===== */
    #auth-section,
    #password-reset-section,
    #dashboard-section {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      padding: 24px 28px;
      margin: 40px auto;
      text-align: left;
      transition: all 0.3s ease;
    }

    #auth-section h2,
    #password-reset-section h2,
    #dashboard-section h2 {
      color: #7A0000;
      /* MRT red */
      font-size: 1.5rem;
      text-align: center;
      margin-bottom: 20px;
    }

    #auth-section label,
    #password-reset-section label {
      display: block;
      font-weight: 600;
      margin-top: 10px;
      color: #333;
    }

    #auth-section input,
    #password-reset-section input {
      width: 100%;
      padding: 10px 12px;
      margin-top: 6px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 0.95rem;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    #auth-section input:focus,
    #password-reset-section input:focus {
      border-color: #7A0000;
      box-shadow: 0 0 4px rgba(122, 0, 0, 0.3);
      outline: none;
    }

    #auth-section button,
    #password-reset-section button,
    #dashboard-section button {
      width: 100%;
      margin-top: 15px;
      padding: 10px 0;
      background-color: #7A0000;
      color: #fff;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      font-size: 1rem;
      cursor: pointer;
      transition: background 0.3s ease;
    }

    #auth-section button:hover,
    #password-reset-section button:hover,
    #dashboard-section button:hover {
      background-color: #a40000;
    }

    .text-center {
      text-align: center;
      margin-top: 12px;
    }

    .text-center a {
      color: #7A0000;
      text-decoration: none;
      font-weight: 600;
      font-size: 0.9rem;
    }

    .text-center a:hover {
      text-decoration: underline;
    }

    /* ===== PASSWORD REQUIREMENTS ===== */
    #password-requirements {
      margin-top: 10px;
      background: #f9f9f9;
      padding: 10px 14px;
      border-radius: 8px;
      font-size: 0.9rem;
      border-left: 3px solid #7A0000;
    }

    #password-requirements p {
      font-weight: 600;
      margin-bottom: 6px;
      color: #333;
    }

    #password-requirements span {
      display: block;
      margin-left: 6px;
    }

    .not-met {
      color: #a40000;
    }

    .met {
      color: green;
    }

    /* ===== MESSAGE STYLES ===== */
    #success-message,
    #error-message {
      margin: 10px auto;
      padding: 10px 14px;
      border-radius: 8px;
      font-weight: 600;
      text-align: center;
    }

    #success-message {
      background-color: #e8f6ec;
      color: #2a7a3b;
      border: 1px solid #bde3c3;
    }

    #error-message {
      background-color: #fce8e8;
      color: #a40000;
      border: 1px solid #f3b0b0;
    }

    /* Hide when inactive */
    .hidden {
      display: none !important;
    }

    @media (max-width: 768px) {
      .arrival-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.4rem;
      }

      .arrival-header .station-name {
        font-size: 1.1rem;
      }

      .arrival-row {
        flex-direction: column;
        align-items: flex-start;
      }

      .arrival-row .countdown {
        min-width: auto;
      }

      .arrival-row .progress-bar {
        width: 100%;
      }

      .live-clock {
        width: 100%;
        text-align: left;
      }

      .hero {
        padding: 60px 0 48px;
        gap: 32px;
      }

      .hero-illustration {
        min-height: 260px;
      }

      .live-ticker-card {
        padding: 20px;
        gap: 1rem;
      }

      .live-ticker-card .ticker-times {
        justify-content: flex-start;
        min-width: 100%;
      }

      .timings-panel .panel-header {
        flex-direction: column;
        align-items: flex-start;
      }

      .timings-grid {
        padding: 0 18px 20px;
      }

      .meetup-container {
        padding: 16px;
      }

      .person-card {
        padding: 16px;
      }

      .meetup-actions {
        flex-direction: column;
      }

      .btn-modern {
        width: 100%;
        justify-content: center;
      }

      .floating-action {
        bottom: 16px;
        right: 16px;
      }

      .travel-times {
        gap: 8px;
      }

      .travel-time-item {
        padding: 12px;
      }
    }

    @media (max-width: 576px) {
      body {
        padding-top: 96px;
      }

      .section-card {
        padding: 20px;
      }

      .live-ticker-card {
        flex-direction: column;
        align-items: flex-start;
      }

      .live-ticker-card .ticker-times {
        width: 100%;
        justify-content: flex-start;
      }

      .timings-grid {
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 1rem;
        padding: 0 16px 16px;
      }

      .meetup-container {
        padding: 12px;
      }

      .person-card {
        padding: 12px;
      }

      .quick-stations {
        gap: 6px;
      }

      .quick-station-btn {
        font-size: 11px;
        padding: 4px 8px;
      }
    }

    /* === PROFILE LAYOUT === */
    .profile-layout {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-top: 20px;
    }

    .left-column {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .card {
      background-color: var(--card-bg, #fff);
      padding: 16px;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
    }

    .card-header,
    #user-display-name {
      background-color: transparent !important;
    }

    .card-header hr {
      margin: 0 12px;
      border: 1px solid #ddd;
    }

    .logout-btn {
      margin-top: 30px;
      width: 100%;
      padding: 10px;
      background: #dc2626;
      color: #fff;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }

    .logout-btn:hover {
      background: #b91c1c;
    }

    /* === FLIP CARD BASE === */
    .flip-card {
      background-color: transparent;
      perspective: 1000px;
      width: 100%;
      max-width: 100%;
      margin: 0 auto;
      border-radius: 10px;
      overflow: hidden;
      border: 2px solid red;
      /* for debugging */
    }

    .flip-card-inner {
      position: relative;
      width: 100%;
      height: 0;
      padding-top: 100%;
      /* square aspect ratio */
      transition: transform 0.6s ease-in-out;
      transform-style: preserve-3d;
      cursor: pointer;
    }

    .flip-card-inner.is-flipped {
      transform: rotateY(180deg);
    }

    .flip-card-front,
    .flip-card-back {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border-radius: 10px;
      padding: 20px;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      backface-visibility: hidden;
      overflow-y: auto;
      scrollbar-width: none;
      /* Firefox */
      -ms-overflow-style: none;
      /* IE/Edge */
    }

    .flip-card-front::-webkit-scrollbar,
    .flip-card-back::-webkit-scrollbar {
      display: none;
      /* Chrome/Safari/Opera */
    }

    .flip-card-front {
      background-color: var(--card-bg, #fff);
      color: #111827;
      z-index: 2;
    }

    .flip-card-back {
      background-color: var(--card-bg, #fff);
      color: #111827;
      transform: rotateY(180deg);
      gap: 16px;
      justify-content: flex-start;
      padding-top: 10px;
    }



    /* Header inside card */
    .card-header h2 {
      font-size: 1.5rem;
      font-weight: bold;
      color: #111827;
      border-bottom: 1px solid #ddd;
      padding-bottom: 8px;
      width: 100%;
      text-align: center;
    }

    /* Account Info */
    .account-info {
      width: 100%;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .account-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .account-row .icon {
      width: 20px;
      height: 20px;
      background-color: #7A0000;
      border-radius: 50%;
    }

    .label {
      font-size: 0.8rem;
      color: #6b7280;
      margin: 0;
    }

    .value {
      font-weight: 500;
      margin: 0;
    }

    /* Favorites */
    .favorites-list {
      width: 100%;
      max-height: 150px;
      overflow-y: auto;
      flex-shrink: 0;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }

    .favorites-list::-webkit-scrollbar {
      display: none;
    }

    .favorites-title {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    #favoriteList div {
      background-color: #f9f9f9;
      border: 1px solid #ddd;
      padding: 6px 10px;
      border-radius: 6px;
      margin-bottom: 4px;
    }

    .logo {
      max-width: 50%;
      height: auto;
      border-radius: 5%;
      margin-bottom: 20px;
    }

    /* Hover hint */
    .hover-hint {
      font-size: 1.3rem;
      font-weight: 600;
      text-align: center;
      animation: pulseHintObvious 1.5s infinite ease-in-out;
      transition: opacity 0.3s, transform 0.3s, color 0.3s;
    }

    .flip-card-inner.is-flipped .hover-hint {
      opacity: 0;
    }

    @keyframes pulseHintObvious {

      0%,
      100% {
        transform: scale(1);
        opacity: 0.6;
        color: #222;
      }

      50% {
        transform: scale(1.0.5);
        opacity: 1;
      }
    }

    /* === MEDIA QUERIES === */

    /* Tablet (769992px): tap flip only */
    @media (min-width: 769px) and (max-width: 992px) {
      .flip-card {
        max-width: 360px;
        margin: 0 auto;
      }

      .flip-card-inner {
        height: auto;
        min-height: 500px;
        padding-top: 0;
      }

      .flip-card:hover .flip-card-inner {
        transform: rotateY(0deg);
        /* disable hover */
      }

      .flip-card:hover .flip-card-inner.is-flipped {
        transform: rotateY(180deg);
        /* keep flip if tapped */
      }
    }

    /* Desktop (993px): hover flip */
    @media (min-width: 993px) {
      .flip-card:hover .flip-card-inner {
        transform: rotateY(180deg);
      }

      .flip-card:hover .hover-hint {
        opacity: 0;
      }
    }

    /* Mobile (768px) */
    @media (max-width: 768px) {
      .profile-layout {
        grid-template-columns: 1fr;
      }

      .left-column {
        order: 2;
      }

      #user-info-card {
        order: 1;
      }

      .logout-btn {
        order: 3;
      }

      .flip-card-inner {
        height: auto;
        padding-top: 0;
        min-height: 400px;
        /* prevents collapse, adjust as needed */
      }
    }
  </style>
</head>

<body>
  <!-- HEADER -->
  <header>
    <nav class="premium-navbar navbar navbar-expand-lg fixed-top py-3">
      <div class="container">
        <a class="navbar-brand" href="#">
          <img src="./singatrainlogo.png" alt="SingaTrain Logo" width="38" height="38" class="rounded-3">
          <span>SingaTrain</span>
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#primaryNav"
          aria-controls="primaryNav" aria-expanded="false" aria-label="Toggle navigation">
          <span class="material-icons">menu</span>
        </button>
        <div class="collapse navbar-collapse mt-3 mt-lg-0" id="primaryNav">
          <ul class="navbar-nav ms-auto align-items-lg-center gap-lg-2">
            <li class="nav-item"><a class="nav-link active" href="#" data-tab="dashboard">Dashboard</a></li>
            <li class="nav-item"><a class="nav-link" href="#" data-tab="live">Live Tracking</a></li>
            <li class="nav-item"><a class="nav-link" href="#" data-tab="route">Route Planner</a></li>
            <li class="nav-item"><a class="nav-link" href="#" data-tab="meetup">Meet-up</a></li>
            <li class="nav-item"><a class="nav-link" href="#" data-tab="alternatives">Alt Routes</a></li>
            <li class="nav-item"><a class="nav-link" href="#" data-tab="fare">Fare</a></li>
            <li class="nav-item"><a class="nav-link" href="#" data-tab="profile">Profile</a></li>
          </ul>
          <div class="d-flex align-items-center gap-3 ms-lg-4 pt-3 pt-lg-0">
            <span class="fw-semibold text-secondary" id="userName">Guest User</span>
            <button class="btn btn-outline-danger btn-sm" onclick="showTab('profile')">Profile</button>
          </div>
        </div>
      </div>
    </nav>
  </header>

  <section class="hero container">
    <div class="hero-intro" data-aos="fade-right">
      <span class="pill mb-3">Singapore MRT Companion</span>
      <h1 class="fw-semibold">Stay Ahead Of Every Train</h1>
      <p>Experience a commuter dashboard crafted for speed and clarity. Watch live countdowns, favourite your go-to
        stations, and glide between light and dark modes for the perfect travel briefing.</p>
      <div class="hero-cta">
        <a class="btn btn-primary btn-lg hover-float" onclick="navigateToTab('live')">
          <span class="material-icons me-2">bolt</span>
          Launch Live Tracking
        </a>
        <a class="btn btn-outline-danger hover-float" onclick="navigateToTab('dashboard')">
          <span class="material-icons me-2">dashboard</span>
          Explore the Dashboard
        </a>
      </div>
    </div>
    <div class="hero-illustration position-relative" data-aos="fade-left">
      <div class="hero-map"></div>
      <div class="floating-pill"><span class="material-icons">rocket_launch</span>Peak-Ready</div>
      <div class="floating-pill"><span class="material-icons">favorite</span>Personalised</div>
      <div class="floating-pill"><span class="material-icons">offline_bolt</span>30s Refresh</div>
      <div class="hero-train">
        <span class="material-icons">train</span>
        <div class="tagline">Real-time Confidence</div>
      </div>
    </div>
  </section>
  <div class="gradient-divider container"></div>

  <main class="container my-4">

    <!-- DASHBOARD -->
    <section id="dashboard" class="section-card">
      <h2 class="section-title mb-2"> My Dashboard</h2>
      <div class="feature-description p-3 rounded mb-3">
        Quick access to your favorite stations, map, and live alerts.
      </div>

      <!-- Map -->
      <div class="mb-3">
        <h5 class="mb-2"> Singapore MRT Network</h5>
        <div id="singaporeMap"
          style="width:100%;height:400px;border:1px solid var(--sg-border);border-radius:12px;background:#f3f4f6"></div>
      </div>

      <h5 class="mt-3"> Favorite Stations</h5>
      <div id="dashboardFavorites" class="row g-3"></div>

      <h5 class="mt-4"> Current Service Alerts</h5>
      <div id="dashboardAlerts" class="mt-2"></div>
    </section>

    <!-- LIVE -->
    <section id="live" class="section-card d-none">
      <h2 class="section-title mb-2"> Real-Time Train Tracking</h2>
      <div class="feature-description p-3 rounded mb-3">Live service alerts and station crowd levels by line.</div>

      <div class="live-tools">
        <div class="d-flex flex-wrap align-items-center gap-3">
          <button class="theme-toggle" id="themeToggle">
            <span class="material-icons">dark_mode</span>
            <span class="toggle-label">Night Mode</span>
          </button>
          <div class="d-flex align-items-center gap-2">
            <div class="form-check form-switch m-0">
              <input class="form-check-input" type="checkbox" id="delayToggle" checked
                onchange="toggleSimulatedDelay(this.checked)">
              <label class="form-check-label small text-secondary" for="delayToggle">Simulate delays</label>
            </div>
            <button class="btn btn-outline-secondary btn-sm hover-float" onclick="manualRefreshArrivals()">
              <span class="material-icons me-1">refresh</span>
              Refresh Now
            </button>
          </div>
        </div>
        <div class="live-clock" id="liveClock">
          <span>--:--:--</span>
        </div>
      </div>

      <div class="live-ticker-card mb-4" id="liveTickerCard">
        <div>
          <div class="ticker-label">Simulated Live Feed</div>
          <div class="ticker-station">Marina Bay</div>
          <div class="ticker-line text-secondary">
            <span class="material-icons">train</span>North-South Line
          </div>
        </div>
        <div class="ticker-times">
          <span class="ticker-pill">2 min</span>
          <span class="ticker-pill">4 min</span>
          <span class="ticker-pill">7 min</span>
        </div>
      </div>

      <div class="row g-3 align-items-end mb-4">
        <div class="col-lg-8">
          <label class="form-label">Filter by MRT Line</label>
          <select id="liveTrainLine" class="form-select">
            <option value="">Show All Lines</option>
            <option value="North-South Line">North-South Line (NSL)</option>
            <option value="East-West Line">East-West Line (EWL)</option>
            <option value="Circle Line">Circle Line (CCL)</option>
            <option value="Downtown Line">Downtown Line (DTL)</option>
            <option value="North-East Line">North East Line (NEL)</option>
            <option value="Thomson-East Coast Line">Thomson-East Coast Line (TEL)</option>
            <option value="Jurong Region Line">Jurong Region Line (JRL)</option>
          </select>
        </div>
        <div class="col-lg-4">
          <label class="form-label">Presentation Mode</label>
          <button class="btn btn-primary w-100 hover-float" onclick="triggerDemoNarration()">
            <span class="material-icons me-2">play_circle</span>Suggested Narration
          </button>
        </div>
      </div>

      <div id="liveArrivals" class="live-arrivals-grid"></div>

      <div class="timings-panel mt-4">
        <div class="panel-header">
          <h5 class="d-flex align-items-center gap-2 mb-0">
            <span class="material-icons text-warning">schedule</span>
            First &amp; Last Train Timings
          </h5>
          <button class="btn btn-outline-danger btn-sm hover-float" type="button" data-bs-toggle="collapse"
            data-bs-target="#trainTimingsPanel" aria-expanded="true" aria-controls="trainTimingsPanel">
            <span class="material-icons me-1">unfold_more</span>
            Toggle View
          </button>
        </div>
        <div class="collapse show" id="trainTimingsPanel">
          <div class="timings-filters">
            <div>
              <label class="form-label small text-uppercase fw-semibold text-secondary">MRT Line</label>
              <select class="form-select" id="timingLineSelect"></select>
            </div>
            <div>
              <label class="form-label small text-uppercase fw-semibold text-secondary">Direction</label>
              <select class="form-select" id="timingDirectionSelect"></select>
            </div>
            <div>
              <label class="form-label small text-uppercase fw-semibold text-secondary">Search Station</label>
              <div class="input-group">
                <span class="input-group-text"><span class="material-icons">search</span></span>
                <input type="search" class="form-control" id="timingSearchInput" placeholder="e.g. Dhoby Ghaut">
              </div>
            </div>
          </div>
          <div class="timings-grid" id="trainTimingsGrid"></div>
        </div>
      </div>

      <div class="output-box mt-3" id="liveOutput">
        <div class="text-secondary">Use the filter above or tap a star to personalise the live arrivals showcase.</div>
      </div>
    </section>

    <!-- ROUTE -->
    <section id="route" class="section-card d-none">
      <h2 class="section-title mb-2"> Interactive Route Planner</h2>
      <div class="feature-description p-3 rounded mb-3">Shortest path (fewest stops) across lines & interchanges with
        time estimate.</div>

      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label">Starting Station</label>
          <select id="routeStart" class="form-select"></select>
        </div>
        <div class="col-md-6">
          <label class="form-label">Destination Station</label>
          <select id="routeEnd" class="form-select"></select>
        </div>
      </div>
      <button class="btn btn-primary mt-3" onclick="planRoute()">Plan Route</button>

      <div class="output-box mt-3" id="routeOutput">
        <div class="text-secondary">Enter start & destination to plan your route.</div>
      </div>

      <!-- Dynamic Route Map Visualization -->
      <div class="mt-4" id="routeMapContainer" style="display:none;">
        <h5 class="mb-3"> Visual Route Map</h5>
        <div id="routeVisualizerMap"
          style="width:100%;height:500px;border:1px solid var(--neutral-200);border-radius:var(--border-radius);background:var(--neutral-50);box-shadow: 0 4px 20px rgba(0,0,0,0.04);position:relative;">
        </div>
        <div class="mt-2" style="font-size: var(--text-sm); color: var(--neutral-800);">
          <span class="material-icons"
            style="font-size: 18px; vertical-align: middle; margin-right: 8px; color: var(--neutral-600);">info</span>
          Interactive route visualization with station markers and path overlay
        </div>
      </div>
    </section>

    <!-- MEETUP -->
    <section id="meetup" class="section-card d-none">
      <div class="d-flex align-items-center gap-3 mb-6">
        <div class="person-avatar" style="width: 64px; height: 64px; font-size: 28px;">
          <span class="material-icons">group</span>
        </div>
        <div>
          <h2 class="section-title mb-2">Meet-up Point Finder</h2>
          <p class="text-muted mb-0" style="font-size: var(--text-lg); color: var(--neutral-600);">Find the perfect
            meeting spot that's fair for everyone</p>
        </div>
      </div>

      <div class="meetup-container">
        <div class="d-flex align-items-center justify-content-between mb-6">
          <h5 class="mb-0 d-flex align-items-center gap-3"
            style="font-size: var(--text-xl); color: var(--neutral-900);">
            <span class="material-icons" style="color: var(--sg-red);">group</span>
            Group Members
          </h5>
          <button class="btn-modern secondary" onclick="addMeetupLocation()">
            <span class="material-icons">add</span>
            Add Person
          </button>
        </div>

        <div id="meetupLocations"></div>

        <div class="quick-stations">
          <span class="text-muted me-3" style="font-size: var(--text-sm); color: var(--neutral-500);">Quick
            select:</span>
          <span class="quick-station-btn" onclick="quickSelectStation('City Hall')">City Hall</span>
          <span class="quick-station-btn" onclick="quickSelectStation('Orchard')">Orchard</span>
          <span class="quick-station-btn" onclick="quickSelectStation('Raffles Place')">Raffles Place</span>
          <span class="quick-station-btn" onclick="quickSelectStation('Marina Bay')">Marina Bay</span>
          <span class="quick-station-btn" onclick="quickSelectStation('Dhoby Ghaut')">Dhoby Ghaut</span>
        </div>
      </div>

      <div class="meetup-actions">
        <button class="btn-modern" onclick="findMeetupPoint()">
          <span class="material-icons">location_searching</span>
          Find Best Meeting Point
        </button>
        <button class="btn-modern secondary" onclick="clearAllLocations()">
          <span class="material-icons">clear_all</span>
          Clear All
        </button>
      </div>

      <!-- Map for Meet-up -->
      <div class="mt-6">
        <div class="d-flex align-items-center gap-3 mb-4">
          <span class="material-icons" style="color: var(--sg-red); font-size: 28px;">map</span>
          <h5 class="mb-0" style="font-size: var(--text-xl); color: var(--neutral-900);">Interactive MRT Network</h5>
        </div>
        <div id="meetupMap"
          style="width:100%;height:500px;border:1px solid var(--neutral-200);border-radius:var(--border-radius);background:var(--neutral-50);box-shadow: 0 4px 20px rgba(0,0,0,0.04);">
        </div>
        <div class="mt-3 text-muted" style="font-size: var(--text-sm); color: var(--neutral-500);">
          <span class="material-icons" style="font-size: 18px; vertical-align: middle; margin-right: 8px;">info</span>
          Click on stations to add them to your group members
        </div>
      </div>

      <div id="meetupOutput" class="meetup-results d-none">
        <!-- Results will be populated here -->
      </div>

      <!-- Floating Action Button -->
      <div class="floating-action d-none" id="floatingAction" onclick="addMeetupLocation()">
        <span class="material-icons">add</span>
      </div>
    </section>

    <!-- ALTERNATIVES -->
    <section id="alternatives" class="section-card d-none">
      <h2 class="section-title mb-2"> Alternative Routes (Breakdown Mode)</h2>
      <div class="feature-description p-3 rounded mb-3">Auto-detect disruptions from Live Alerts. Offers MRT-only, Bus,
        or Mixed alternatives.</div>

      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label">Your Current Location</label>
          <select id="altStart" class="form-select"></select>
        </div>
        <div class="col-md-6">
          <label class="form-label">Your Destination</label>
          <select id="altEnd" class="form-select"></select>
        </div>
      </div>
      <div class="row g-3 mt-1">
        <div class="col-md-6">
          <label class="form-label">Affected Line (optional)</label>
          <select id="affectedLine" class="form-select">
            <option value="">Auto-detect from alerts</option>
            <option value="NSL">North South Line (NSL)</option>
            <option value="EWL">East West Line (EWL)</option>
            <option value="DTL">Downtown Line (DTL)</option>
            <option value="CCL">Circle Line (CCL)</option>
            <option value="NEL">North East Line (NEL)</option>
            <option value="TEL">Thomson-East Coast Line (TEL)</option>
          </select>
        </div>
      </div>

      <button class="btn btn-primary mt-3" onclick="findAlternatives()">Find Alternative Routes</button>
      <div class="output-box mt-3" id="altOutput">
        <div class="text-secondary">Enter your journey details.</div>
      </div>
    </section>

    <!-- FARE -->
    <section id="fare" class="section-card d-none">
      <h2 class="section-title mb-2"> Fare Calculator</h2>
      <div class="feature-description p-3 rounded mb-3">Distance-based adult & concession fares + Monthly Pass
        breakeven.</div>

      <div class="row g-3">
        <div class="col-md-4">
          <label class="form-label">From</label>
          <select id="fareStart" class="form-select"></select>
        </div>
        <div class="col-md-4">
          <label class="form-label">To</label>
          <select id="fareEnd" class="form-select"></select>
        </div>
        <div class="col-md-4">
          <label class="form-label">Commuter Type</label>
          <select id="commuterType" class="form-select">
            <option value="adult">Adult</option>
            <option value="primary">Primary School Student</option>
            <option value="secondary">Secondary School Student</option>
            <option value="polytechnic">Polytechnic Student</option>
            <option value="university">University Student</option>
            <option value="senior">Senior Citizen</option>
            <option value="disability">Person with Disabilities</option>
            <option value="ns">National Serviceman</option>
            <option value="workfare">Workfare Concession</option>
          </select>
        </div>
      </div>
      <button class="btn btn-primary mt-3" onclick="calculateFare()">Calculate Fare</button>
      <div class="output-box mt-3" id="fareOutput"></div>

      <h5 class="mt-4">Monthly Pass Calculator</h5>
      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label">Daily Round Trips</label>
          <input type="number" id="dailyTrips" class="form-control" value="2" min="1" max="10">
        </div>
        <div class="col-md-6">
          <label class="form-label">Working Days / Month</label>
          <input type="number" id="workingDays" class="form-control" value="22" min="1" max="31">
        </div>
      </div>
      <button class="btn btn-primary mt-3" onclick="calculatePassValue()">Check if Pass is Worth It</button>
      <div class="output-box mt-3" id="passOutput"></div>
    </section>

    <!-- PROFILE -->
    <section id="profile" class="section-card d-none">
      <!-- MESSAGE DISPLAYS -->
      <div id="error-message" class="hidden"></div>
      <div id="success-message" class="hidden"></div>

      <!-- AUTH SECTION -->
      <div id="auth-section">
        <h2>Join or Sign In</h2>

        <label for="auth-email">Email:</label>
        <input type="email" id="auth-email" placeholder="Enter your email">

        <label for="auth-password">Password:</label>
        <input type="password" id="auth-password" placeholder="Enter your password">

        <div id="password-requirements" class="hidden">
          <p>Password must contain:</p>
          <span id="req-length" class="not-met">- At least 6 characters</span>
          <span id="req-uppercase" class="not-met">- An uppercase letter</span>
          <span id="req-lowercase" class="not-met">- A lowercase letter</span>
          <span id="req-number" class="not-met">- A number</span>
          <span id="req-special" class="not-met">- A special character (!@#$%^&*)</span>
        </div>

        <div class="auth-buttons">
          <button id="login-btn">Sign In</button>
          <button id="register-btn">Register New Account</button>
        </div>


        <div class="text-center">
          <a href="#" id="forgot-password-link">Forgot Password?</a>
        </div>
      </div>

      <!-- PASSWORD RESET SECTION -->
      <div id="password-reset-section" class="hidden">
        <h2>Reset Your Password</h2>

        <label for="reset-email">Email:</label>
        <input type="email" id="reset-email" placeholder="Enter your account email">
        <button id="send-reset-email-btn">Send Reset Email</button>

        <div class="text-center">
          <a href="#" id="back-to-auth-link">Back to Login</a>
        </div>
      </div>

      <!-- USER DASHBOARD -->
      <!-- USER DASHBOARD -->
      <div id="dashboard-section" class="hidden">
        <h2>Welcome to SingaTrain!</h2>
        <p style="color:#111827">You are logged in as: <strong id="user-display-email"></strong></p>

        <!--  Profile Layout -->
        <div class="profile-layout">
          <!-- LEFT COLUMN -->
          <div class="left-column">
            <!-- Change Display Name -->
            <div class="card" id="change-name-div">
              <h3>Change Display Name</h3>
              <input type="text" id="profileName" placeholder="Current name">
              <button id="saveProfileBtn">Save Profile</button>
            </div>

            <!-- Add New Favorite Station -->
            <div class="card" id="add-favorite-div">
              <h3>Add New Favorite Station</h3>
              <label for="favoriteLabel">Label:</label>
              <input type="text" id="favoriteLabel" placeholder="Favorite name">

              <label for="favoriteStation">Station:</label>
              <select id="favoriteStation"></select>
              <button id="addFavoriteBtn">Add Favorite Station</button>
            </div>
          </div>

          <!-- RIGHT COLUMN (User Info Card) -->
          <div class="card flip-card" id="user-info-card">
            <div class="flip-card-inner">
              <div class="flip-card-front">
                <img src="singatrainlogo.png" alt="SingaTrain Logo" class="logo">
                <p class="hover-hint">Hover to see profile details</p>
              </div>
              <div class="flip-card-back">
                <!-- Header -->
                <div class="card-header">
                  <h2 id="user-display-name">User Name</h2>
                </div>

                <!-- Account Info -->
                <div class="account-info">
                  <div class="account-row">
                    <span class="material-icons" style="color:#7A0000;">calendar_today</span>
                    <div>
                      <p class="label">Member Since</p>
                      <p id="member-since" class="value">--/--/----</p>
                    </div>
                  </div>

                  <div class="account-row">
                    <span class="material-icons" style="color:#7A0000;">star</span>
                    <div>
                      <p class="label">Favorite Stations</p>
                      <p id="favorite-count" class="value">0 stations</p>
                    </div>
                  </div>
                </div>

                <!-- Favorite Stations List -->
                <div class="favorites-list">
                  <h3 class="favorites-title">Your Favorite Stations</h3>
                  <div id="favoriteList"></div>
                </div>
              </div>

            </div>
          </div>
        </div>

        <!-- Sign Out Button -->
        <button id="logout-btn" class="logout-btn">Sign Out</button>


    </section>

    <!-- Toast (API errors/info) -->
    <div class="position-fixed bottom-0 end-0 p-3" style="z-index:1100">
      <div id="appToast" class="toast align-items-center text-bg-danger border-0" role="alert" aria-live="assertive"
        aria-atomic="true">
        <div class="d-flex">
          <div class="toast-body" id="toastMsg">An error occurred.</div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"
            aria-label="Close"></button>
        </div>
      </div>
    </div>

  </main>
  <script src="config.js"></script>
  <script>
    // ====== API CONFIG ======
    const PROXY = "https://corsproxy.io/?";
    const API_BASE = "https://datamall2.mytransport.sg/ltaodataservice";
    // <- replace with your real key

    // ====== STATIONS DB (simplified; you can expand) ======
    const MRT_STATIONS = {
      NSL: ['Jurong East', 'Bukit Batok', 'Bukit Gombak', 'Choa Chu Kang', 'Yew Tee', 'Kranji', 'Marsiling', 'Woodlands', 'Admiralty', 'Sembawang', 'Canberra', 'Yishun', 'Khatib', 'Yio Chu Kang', 'Ang Mo Kio', 'Bishan', 'Braddell', 'Toa Payoh', 'Novena', 'Newton', 'Orchard', 'Somerset', 'Dhoby Ghaut', 'City Hall', 'Raffles Place', 'Marina Bay', 'Marina South Pier'],
      EWL: ['Pasir Ris', 'Tampines', 'Simei', 'Tanah Merah', 'Bedok', 'Kembangan', 'Eunos', 'Paya Lebar', 'Aljunied', 'Kallang', 'Lavender', 'Bugis', 'City Hall', 'Raffles Place', 'Tanjong Pagar', 'Outram Park', 'Tiong Bahru', 'Redhill', 'Queenstown', 'Commonwealth', 'Buona Vista', 'Dover', 'Clementi', 'Jurong East', 'Chinese Garden', 'Lakeside', 'Boon Lay', 'Pioneer', 'Joo Koon', 'Gul Circle', 'Tuas Crescent', 'Tuas West Road', 'Tuas Link'],
      DTL: ['Bukit Panjang', 'Cashew', 'Hillview', 'Beauty World', 'King Albert Park', 'Sixth Avenue', 'Tan Kah Kee', 'Botanic Gardens', 'Stevens', 'Newton', 'Little India', 'Rochor', 'Bugis', 'Promenade', 'Bayfront', 'Downtown', 'Telok Ayer', 'Chinatown', 'Fort Canning', 'Bencoolen', 'Jalan Besar', 'Bendemeer', 'Geylang Bahru', 'Mattar', 'MacPherson', 'Ubi', 'Kaki Bukit', 'Bedok North', 'Bedok Reservoir', 'Tampines West', 'Tampines', 'Tampines East', 'Upper Changi', 'Expo'],
      CCL: ['Dhoby Ghaut', 'Bras Basah', 'Esplanade', 'Promenade', 'Nicoll Highway', 'Stadium', 'Mountbatten', 'Dakota', 'Paya Lebar', 'MacPherson', 'Tai Seng', 'Bartley', 'Serangoon', 'Lorong Chuan', 'Bishan', 'Marymount', 'Caldecott', 'Botanic Gardens', 'Farrer Road', 'Holland Village', 'Buona Vista', 'one-north', 'Kent Ridge', 'Haw Par Villa', 'Pasir Panjang', 'Labrador Park', 'Telok Blangah', 'HarbourFront'],
      NEL: ['HarbourFront', 'Outram Park', 'Chinatown', 'Clarke Quay', 'Dhoby Ghaut', 'Little India', 'Farrer Park', 'Boon Keng', 'Potong Pasir', 'Woodleigh', 'Serangoon', 'Kovan', 'Hougang', 'Buangkok', 'Sengkang', 'Punggol'],
      TEL: ['Woodlands North', 'Woodlands', 'Woodlands South', 'Springleaf', 'Lentor', 'Mayflower', 'Bright Hill', 'Upper Thomson', 'Caldecott', 'Mount Pleasant', 'Stevens', 'Napier', 'Orchard Boulevard', 'Orchard', 'Great World', 'Havelock', 'Outram Park', 'Maxwell', 'Shenton Way', 'Marina Bay', 'Marina South', 'Gardens by the Bay']
    };
    const ALL_STATIONS = [...new Set(Object.values(MRT_STATIONS).flat())].sort();

    // ====== USER DATA ======
    let userData = {
      uid: null,         // Firebase UID
      name: 'Guest User',
      email: null,
      favorites: []      // Array of { label, station }
    };


    // ====== UI HELPERS ======
    const toastEl = document.getElementById('appToast');
    const toastMsg = document.getElementById('toastMsg');
    function showToast(msg, isError = true) {
      toastMsg.textContent = msg;
      toastEl.classList.remove('text-bg-danger', 'text-bg-primary', 'text-bg-success');
      toastEl.classList.add(isError ? 'text-bg-danger' : 'text-bg-primary');
      new bootstrap.Toast(toastEl, { delay: 3500 }).show();
    }

    function setActiveTab(tabName) {
      document.querySelectorAll('.nav-link').forEach(b => b.classList.remove('active'));
      document.querySelector(`.nav-link[data-tab="${tabName}"]`)?.classList.add('active');
      document.querySelectorAll('main section').forEach(s => s.classList.add('d-none'));
      document.getElementById(tabName)?.classList.remove('d-none');

      // Show/hide floating action button
      const floatingAction = document.getElementById('floatingAction');
      if (tabName === 'meetup') {
        floatingAction?.classList.remove('d-none');
        initMeetupMap();
        // Add first person if none exist
        const existingPersons = document.querySelectorAll('#meetupLocations .person-card');
        if (existingPersons.length === 0) {
          addMeetupLocation();
        }
      } else {
        floatingAction?.classList.add('d-none');
      }

      if (tabName === 'dashboard') {
        loadDashboard();
      }
      if (tabName === 'live') {
        startArrivalRenderLoop();
        startLiveTicker();
      } else {
        stopArrivalRenderLoop();
        stopLiveTicker();
      }
    }
    function navigateToTab(tabName) {
      setActiveTab(tabName);
      const target = document.getElementById(tabName);
      if (!target) return;
      const offset = 90;
      const top = target.getBoundingClientRect().top + window.pageYOffset - offset;
      if (window.gsap) {
        gsap.to(window, { duration: 0.6, scrollTo: top, ease: 'power2.out' });
      } else {
        window.scrollTo({ top, behavior: 'smooth' });
      }
    }
    document.querySelectorAll('.nav-link').forEach(btn => {
      btn.addEventListener('click', (event) => {
        event.preventDefault();
        navigateToTab(btn.dataset.tab);
      });
    });
    function showTab(tab) { navigateToTab(tab); }

    // ====== INIT DROPDOWNS ======
    function fillSelect(el) {
      el.innerHTML = '<option value="">-- Select Station --</option>' +
        ALL_STATIONS.map(s => `<option value="${s}">${s}</option>`).join('');
    }
    function initializeDropdowns() {
      ['routeStart', 'routeEnd', 'altStart', 'altEnd', 'fareStart', 'fareEnd', 'favoriteStation'].forEach(id => {
        const el = document.getElementById(id); if (el) fillSelect(el);
      });
      addMeetupLocation(); // seed first row
    }

    // ====== BUILD GRAPH (for routing) ======
    // Graph maps "Station (LINE)" nodes; interchanges are connected with small penalty.
    const graph = new Map();
    function nodeKey(st, line) { return `${st} (${line})`; }

    function addEdge(a, b, weight = 1) {
      if (!graph.has(a)) graph.set(a, []);
      if (!graph.has(b)) graph.set(b, []);
      graph.get(a).push({ to: b, w: weight });
      graph.get(b).push({ to: a, w: weight });
    }
    function buildGraph() {
      graph.clear();
      // connect consecutive stations on same line
      Object.entries(MRT_STATIONS).forEach(([line, stations]) => {
        stations.forEach((st, i) => {
          const A = nodeKey(st, line);
          if (i > 0) {
            const B = nodeKey(stations[i - 1], line);
            addEdge(A, B, 1);
          }
          if (i < stations.length - 1) {
            const C = nodeKey(stations[i + 1], line);
            addEdge(A, C, 1);
          }
        });
      });
      // connect interchanges (same physical station across lines)
      const stationToLines = new Map();
      Object.entries(MRT_STATIONS).forEach(([line, stations]) => {
        stations.forEach(st => {
          if (!stationToLines.has(st)) stationToLines.set(st, []);
          stationToLines.get(st).push(line);
        });
      });
      stationToLines.forEach((lines, st) => {
        if (lines.length > 1) {
          // small interchange cost ~0.5 stops so pathfinder can pick smart transfers
          for (let i = 0; i < lines.length; i++) {
            for (let j = i + 1; j < lines.length; j++) {
              addEdge(nodeKey(st, lines[i]), nodeKey(st, lines[j]), 0.5);
            }
          }
        }
      });
    }
    buildGraph();

    // ====== SHORTEST PATH (Dijkstra) by stops (weights) ======
    function shortestPath(startStation, endStation) {
      // start from any line containing startStation; end at any line containing endStation
      const startNodes = Object.keys(MRT_STATIONS).filter(l => MRT_STATIONS[l].includes(startStation)).map(l => nodeKey(startStation, l));
      const endNodes = Object.keys(MRT_STATIONS).filter(l => MRT_STATIONS[l].includes(endStation)).map(l => nodeKey(endStation, l));
      if (startNodes.length === 0 || endNodes.length === 0) return null;

      const dist = new Map(), prev = new Map(), pq = [];
      function push(n, d) { pq.push([d, n]); pq.sort((a, b) => a[0] - b[0]); }

      // initialize
      graph.forEach((_, n) => dist.set(n, Infinity));
      startNodes.forEach(n => { dist.set(n, 0); push(n, 0); });

      let target = null;
      const endSet = new Set(endNodes);

      while (pq.length) {
        const [d, u] = pq.shift();
        if (d !== dist.get(u)) continue;
        if (endSet.has(u)) { target = u; break; }
        for (const { to, w } of (graph.get(u) || [])) {
          const nd = d + w;
          if (nd < dist.get(to)) {
            dist.set(to, nd);
            prev.set(to, u);
            push(to, nd);
          }
        }
      }
      if (!target) return null;

      // reconstruct
      const path = [];
      let cur = target;
      while (cur) { path.unshift(cur); cur = prev.get(cur); }
      // compress to [ {station, line}... ]
      const steps = path.map(k => {
        const m = k.match(/^(.*) \((.*)\)$/);
        return { station: m ? m[1] : k, line: m ? m[2] : '?' };
      });
      const totalWeight = dist.get(target); // stops incl. interchange weight

      return { steps, totalWeight };
    }

    // ====== TIME / DISTANCE ESTIMATES ======
    // avg 2.2 min between stops; interchange adds ~4 min walking; distance ~1.1 km per stop
    function estimateTimeMinutes(totalWeight) {
      // split weight into stops vs. interchanges (0.5 weights become transfers)
      const stopsApprox = Math.max(0, Math.round(totalWeight)); // approx whole stops
      const transfersApprox = Math.max(0, Math.round((totalWeight - stopsApprox) * 2)); // each 0.5 => 1 transfer
      return Math.round(stopsApprox * 2.2 + transfersApprox * 4 + 3); // +3 buffer
    }
    function estimateDistanceKm(totalWeight) {
      const stops = Math.max(0, Math.round(totalWeight)); // only full edges
      const transfers = Math.round((totalWeight - stops) * 2);
      return +(stops * 1.1 + transfers * 0.3).toFixed(1); // add small transfer walk dist
    }

    // ====== LIVE INFO ======
    async function fetchLiveInfo() {
      const line = document.getElementById('liveTrainLine').value;
      const out = document.getElementById('liveOutput');
      out.innerHTML = '<div class="text-secondary">Fetching live data</div>';

      try {
        // Alerts
        let alerts = [];
        try {
          const alertUrl = `${PROXY}${encodeURIComponent(API_BASE + "/TrainServiceAlerts")}`;
          const res = await fetch(alertUrl, { headers: { AccountKey: ACCOUNT_KEY, accept: "application/json" } });
          if (res.ok) {
            const data = await res.json();
            alerts = Array.isArray(data.value || data.Value) ? (data.value || data.Value) : (Array.isArray(data) ? data : []);
          }
        } catch (e) {
          console.log('Service Alerts API unavailable, using demo data');
          alerts = []; // Use empty array instead of showing error
        }
        // Crowd
        let crowds = [];
        try {
          const crowdUrl = `${PROXY}${encodeURIComponent(API_BASE + "/PCDRealTime?TrainLine=" + line)}`;
          const res = await fetch(crowdUrl, { headers: { AccountKey: ACCOUNT_KEY, accept: "application/json" } });
          if (res.ok) {
            const data = await res.json();
            // console.log('Crowd API Response:', data); // Debug log
            crowds = Array.isArray(data.value || data.Value) ? (data.value || data.Value) : (Array.isArray(data) ? data : []);
            // console.log('Extracted crowds:', crowds); // Debug log
          }
        } catch (e) {
          console.log('Crowd data API error:', e);
          crowds = []; // Use empty array instead of showing error
        }

        // Render
        let html = '<h5>Service Status</h5>';
        const lineAlert = alerts.find(a => (a.Line || a.line || '').toUpperCase().includes(line));
        if (lineAlert) {
          html += `<div class="alert-card alert-disrupted mb-2">
            <strong> ${lineAlert.Line || line}</strong><br>
            <small>${lineAlert.Message || 'Service disruption reported'}</small>
          </div>`;
        } else {
          html += `<div class="alert-card alert-normal mb-2">
            <strong> ${line}</strong><br><small>All services operating normally</small>
          </div>`;
        }

        html += '<h5 class="mt-3">Station Crowd Levels</h5>';
        if (crowds.length) {
          html += crowds.map(s => {
            const lvlRaw = (s.CrowdLevel || s.crowdLevel || '').toString().toLowerCase();
            const label = lvlRaw === 'h' ? 'High' : lvlRaw === 'm' ? 'Moderate' : lvlRaw === 'l' ? 'Low' : (s.CrowdLevel || 'N/A');
            const cls = lvlRaw === 'h' ? 'text-danger fw-semibold' : (lvlRaw === 'm' ? 'text-warning fw-semibold' : 'text-success fw-semibold');
            return `<div class="d-flex justify-content-between border rounded p-2 mb-1">
              <span>${s.Station || s.station || 'Unknown'}</span>
              <span class="${cls}">${label}</span>
            </div>`;
          }).join('');
        } else {
          html += '<div class="text-secondary">No crowd data for this line.</div>';
        }
        out.innerHTML = html;
      } catch (err) {
        out.innerHTML = `<span class="text-danger">Error: ${err.message}</span>`;
        showToast(err.message);
        console.error(err);
      }
    }

    // ====== STATION COORDINATES FOR ROUTE VISUALIZATION ======
    const STATION_COORDINATES = `EW1 Pasir Ris/ 6840, 1600
EW2,DT32 Tampines/ 6840,1895
EW3 Simei / 6840, 2050
EW4,CG Tanah Merah/ 6815,2203
CG1,DT35 Expo/ 7215, 2490
CG2 Changi Airport/ 7500,2490
EW5 Bedok/ 6283,2203
EW6 Kembangan/ 5886,2416
EW7 Eunos/ 5650, 2650
EW8,CC9 Paya Lebar/ 5400,2900
EW9 Aljunied / 5170, 3130
EW10 Kallang/ 5000,3310
EW11 Lavender/ 4815,3490
EW12,DT14 Bugis/ 4610, 3695
EW13,NS25 City Hall/ 4185,4130
EW14,NS26 Raffles Place/ 4180,4380
EW15 Tanjong Pagar/ 3444,4495
EW16,NE3,TE17 Outram Park/ 3200,4120
EW17 Tiong Bahru/ 2865,3930
EW18 Redhill/ 2680, 3750
EW19 Queenstown/ 2500, 3580
EW20 Commonwealth/ 2345, 3420
EW21,CC22 Buona Vista/ 2100, 3265
EW22 Dover/ 1815, 3265
EW23 Clementi/ 1550, 3265
EW24,NS1 Jurong East/ 1160, 3265
EW25 Chinese Garden/ 850,3265
EW26 Lakeside/ 560, 3265
EW27 Boon Lay/ 300, 2975
EW28 Pioneer/ 300, 2750
EW29 Joo Koon/ 300, 2525
EW30 Gul Circle/ 300, 2290
EW31 Tuas Crescent/ 300, 2060
EW32 Tuas West Road/ 300,1830
EW33 Tuas Link/ 300,1600
NS2 Bukit Batok/ 1160, 2755
NS3 Bukit Gombak/ 1160,2360
NS4,BP1 Choa Chu Kang/ 1160, 1928
NS5 Yew Tee/ 1160, 1460
NS7 Kranji/1160, 1030
NS8 Marsiling/ 1400,540
NS9,TE2 Woodlands/1983,437
NS10 Admiralty/2360,437
NS11 Sembawang/2710,437
NS12 Canberra/3060,437
NS13 Yishun/3411,550
NS14 Khatib/3600,765
NS15 Yio Chu Kang/3640,1030
NS16 Ang Mo Kio/3640, 1300
NS17,CC15 Bishan/3640, 1607
NS18 Braddell/ 3640,1780
NS19 Toa Payoh/ 3640, 2035
NS20 Novena/ 3490,2330
NS21,DT11 Newton/ 3376,2511
NS22,TE14 Orchard/ 2990,2928
NS23 Somerset/ 3253,3203
NS24,NE6,CC1 Dhoby Ghaut/3690,3635
NS27,TE20,CE2 Marina Bay/ 4323,4758
NS28 Marina South Pier / 4478,4988
CC2 Bras Basah/ 4223,3757
CC3 Esplanade/ 4592,4127
CC4,DT15 Promenade/5072,4256
CE1,DT16 Bayfront/ 4727,4583
CC5 Nicoll Highway/5270,3980
CC6 Stadium/5365,3740
CC7 Mountbatten/5427,3484
CC8 Dakota/5442,3225
CC10,DT26 MacPherson/5283,2558
CC11 Tai Seng/5096,2255
CC12 Bartley/4866,2020
CC13,NE12 Serangoon/4525,1785
CC14 Lorong Chuan/4127, 1640
CC16 Marymount/3225,1684
CC17,TE9 Caldecott/2927,1838
CC19,DT9 Botanic Gardens/2404,2299
CC20 Farrer Road/2227,2625
CC21 Holland Village/2135,2890
CC23 one-north/2111,3489
CC24 Kent Ridge/2164,3748
CC25 Haw Par Villa/2255,3983
CC26 Pasir Panjang/2371,4189
CC27 Labrador Park/2529,4391
CC28 Telok Blangah/2731,4587
CC29,NE1 HarbourFront/ 3057,4784
NE4,DT19 Chinatown/3441,3911
NE5 Clarke Quay/3565,3752
NE7,DT12 Little India/3916,2994
NE8 Farrer Park/3911,2745
NE9 Boon Keng/3911,2510
NE10 Potong Pasir/4065,2265
NE11 Woodleigh/4290,2035
NE13 Kovan/4727,1588
NE14 Hougang/4904,1411
NE15 Buangkok/5072,1257
NE16,STC Sengkang/5235,1080
SW1 Cheng Lim/5132,798
SW2 Farmway/5038,702
SW3 Kupang/4949,616
SW4 Thanggam/4824,593
SW5 Fernvale/4740,672
SW6 Layar/4782,778
SW7 Tongkang/4873,867
SW8 Renjong/4962,950
SE1 Compassvale/5595,1258
SE2 Rumbia/5698,1357
SE3 Bakau/5703,1532
SE4 Kangkar/5523,1514
SE5 Ranggung/5400,1400
NE17,PTC Punggol/5600,710
PE1 Cove/5772,906
PE2 Meridian/5861,1027
PE3 Coral Edge/5949,1115
PE4 Riviera/6124,1123
PE5 Kadaloor/6144,978
PE6 Oasis/6043,879
PE7 Damai/5942,786
PW1 Sam Kee/5533,372
PW3 Punggol Point/5371,212
PW4 Samudera/5206,207
PW5 Nibong/5181,352
PW6 Sumang/5267,436
PW7 Soo Teck/5341,512
NE18 Punggol Coast/5758,552
DT1,BP6 Bukit Panjang/1742,1244
BP2 South View/1289,1745
BP3 Keat Hong/1289,1553
BP4 Teck Whye/1289,1381
BP5 Phoenix/1482,1182
BP7 Petir/1836,990
BP8 Pending/1860,860
BP9 Bangkit/1860, 736
BP10 Fajar/1745,615
BP11 Segar/1625,736
BP12 Jelapang/1625,860
BP13 Senja/1648,980
DT2 Cashew/1742,1436
DT3 Hillview/1742,1566
DT5 Beauty World/1742,1830
DT6 King Albert Park/1742,1960
DT7 Sixth Avenue/1742,2090
DT8 Tan Kah Kee/2009,2289
DT10,TE11 Stevens/2924,2292
DT13 Rochor/4158,3233
DT17 Downtown/4422,4659
DT18 Telok Ayer/3937,4386
DT20 Fort Canning/3419,3634
DT21 Bencoolen/4295,3552
DT22 Jalan Besar/4493,3354
DT23 Bendemeer/4757,3093
DT24 Geylang Bahru/4926,2917
DT25 Mattar/5109,2729
DT27 Ubi/5500,2344
DT28 Kaki Bukit/5698,2146
DT29 Bedok North/5884,1960
DT30 Bedok Reservoir/6216,1902
DT31 Tampines West/6545,1902
DT33 Tampines East/7216,2051
DT34 Upper Changi/7212,2234
TE1 Woodlands North/1741,182
TE3 Woodlands South/2148,613
TE4 Springleaf/2312,771
TE5 Lentor/2463,934
TE6 Mayflower/2621,1092
TE7 Bright Hill/2785,1262
TE8 Upper Thomson/2931,1553
TE12 Napier/2931,2518
TE13 Orchard Boulevard/2931,2724
TE15 Great World/2931,3173
TE16 Havelock/2931,3422
TE18 Maxwell/3513,4278
TE19 Shenton Way/3920,4672
TE22 Gardens By The Bay/5351,4557
TE23 Tanjong Rhu/5746,4150
TE24 Katong Park/5910,3992
TE25 Tanjong Katong/6061,3829
TE26 Marine Parade/6219,3677
TE27 Marine Terrace/6383,3513
TE28 Siglap/6535,3361
TE29 Bayshore/6680,3222`;

    // Parse station coordinates
    const parsedStationCoords = [];
    const coordLines = STATION_COORDINATES.split('\n');
    coordLines.forEach(line => {
      line = line.trim();
      if (!line) return;

      const match = line.match(/^([A-Z0-9,]+)\s+(.+?)\/\s*(\d+)\s*,\s*(\d+)/);
      if (match) {
        const [, codes, name, x, y] = match;
        parsedStationCoords.push({
          codes: codes.trim(),
          name: name.trim(),
          x: parseInt(x),
          y: parseInt(y)
        });
      }
    });

    // Global variables for route map
    let routeMapInstance = null;
    let routeMapLine = null;
    let routeMapStartMarker = null;
    let routeMapEndMarker = null;

    // Initialize route visualizer map
    function initRouteVisualizerMap() {
      if (routeMapInstance) return; // Already initialized

      const imageUrl = './MRT-Map.png';
      const img = new Image();

      img.onload = function () {
        const imgW = img.width;
        const imgH = img.height;

        routeMapInstance = L.map('routeVisualizerMap', {
          crs: L.CRS.Simple,
          minZoom: -5,
          maxZoom: 2,
          zoomControl: true,
        });

        const imageLatLngBounds = L.latLngBounds([
          routeMapInstance.unproject([0, imgH], routeMapInstance.getMaxZoom()),
          routeMapInstance.unproject([imgW, 0], routeMapInstance.getMaxZoom())
        ]);

        L.imageOverlay(imageUrl, imageLatLngBounds).addTo(routeMapInstance);
        routeMapInstance.fitBounds(imageLatLngBounds);

        // Store lat/lng for all stations (but don't add markers yet)
        parsedStationCoords.forEach((station) => {
          const latlng = routeMapInstance.unproject([station.x, station.y], routeMapInstance.getMaxZoom());
          station.latlng = latlng;
        });

        // Force map to invalidate size for proper alignment
        setTimeout(() => {
          routeMapInstance.invalidateSize();
        }, 100);
      };

      img.onerror = function () {
        console.error('Failed to load MRT map image for route visualization');
        document.getElementById('routeMapContainer').innerHTML = '<div class="alert alert-warning">Route map image not available. Please ensure MRT-Map.png is in the main folder.</div>';
      };

      img.src = imageUrl;
    }

    // Store route markers for cleanup
    let routeIntermediateMarkers = [];

    // Draw route on visualizer map
    function drawRouteOnMap(startStationName, endStationName, routeSteps) {
      // Clear previous route and all markers
      if (routeMapLine) {
        routeMapInstance.removeLayer(routeMapLine);
        routeMapLine = null;
      }
      if (routeMapStartMarker) {
        routeMapInstance.removeLayer(routeMapStartMarker);
        routeMapStartMarker = null;
      }
      if (routeMapEndMarker) {
        routeMapInstance.removeLayer(routeMapEndMarker);
        routeMapEndMarker = null;
      }
      // Remove all intermediate markers
      routeIntermediateMarkers.forEach(marker => {
        routeMapInstance.removeLayer(marker);
      });
      routeIntermediateMarkers = [];

      // Find station coordinates
      const findStationCoords = (name) => {
        return parsedStationCoords.find(s => s.name.toLowerCase() === name.toLowerCase());
      };

      const startCoord = findStationCoords(startStationName);
      const endCoord = findStationCoords(endStationName);

      if (!startCoord || !endCoord) {
        console.warn('Could not find coordinates for start or end station');
        return;
      }

      // Highlight start marker
      routeMapStartMarker = L.circleMarker(startCoord.latlng, {
        color: '#27ae60',
        fillColor: '#2ecc71',
        fillOpacity: 1,
        radius: 8,
        weight: 3
      }).addTo(routeMapInstance);
      routeMapStartMarker.bindPopup(`<strong>START: ${startCoord.name}</strong><br><small>${startCoord.codes}</small>`).openPopup();

      // Highlight end marker
      routeMapEndMarker = L.circleMarker(endCoord.latlng, {
        color: '#c0392b',
        fillColor: '#e74c3c',
        fillOpacity: 1,
        radius: 8,
        weight: 3
      }).addTo(routeMapInstance);
      routeMapEndMarker.bindPopup(`<strong>END: ${endCoord.name}</strong><br><small>${endCoord.codes}</small>`);

      // Build route line from all stations in the path and add markers
      const routeLatLngs = [];
      const routeStationNames = new Set();

      routeSteps.forEach((step, idx) => {
        const coord = findStationCoords(step.station);
        if (coord && coord.latlng) {
          routeLatLngs.push(coord.latlng);
          routeStationNames.add(step.station.toLowerCase());

          // Add intermediate markers (not start or end)
          if (idx > 0 && idx < routeSteps.length - 1) {
            const intermediateMarker = L.circleMarker(coord.latlng, {
              color: '#495057',
              fillColor: '#adb5bd',
              fillOpacity: 0.8,
              radius: 5,
              weight: 2
            }).addTo(routeMapInstance);
            intermediateMarker.bindPopup(`<strong>${coord.name}</strong><br><small>${coord.codes}</small>`);
            routeIntermediateMarkers.push(intermediateMarker);
          }
        }
      });

      if (routeLatLngs.length > 1) {
        routeMapLine = L.polyline(routeLatLngs, {
          color: '#6c757d',
          weight: 10,
          opacity: 0.6
        }).addTo(routeMapInstance);

        // Fit map to show the route with padding
        const bounds = L.latLngBounds(routeLatLngs);
        routeMapInstance.fitBounds(bounds, { padding: [80, 80] });

        // Ensure proper alignment
        setTimeout(() => {
          routeMapInstance.invalidateSize();
          routeMapInstance.fitBounds(bounds, { padding: [80, 80] });
        }, 100);
      }
    }

    // ====== ROUTE PLANNER ======
    function planRoute() {
      const start = document.getElementById('routeStart').value;
      const end = document.getElementById('routeEnd').value;
      const out = document.getElementById('routeOutput');
      if (!start || !end) { out.innerHTML = '<span class="text-danger">Please select both stations.</span>'; animateResult(out); return; }
      if (start === end) { out.innerHTML = '<span class="text-secondary">You are already at your destination </span>'; animateResult(out); return; }

      const path = shortestPath(start, end);
      if (!path) { out.innerHTML = '<span class="text-danger">No route found.</span>'; animateResult(out); return; }

      const mins = estimateTimeMinutes(path.totalWeight);
      const dist = estimateDistanceKm(path.totalWeight);

      let html = `<h5>Route from <span class="station-chip">${start}</span> to <span class="station-chip">${end}</span></h5>`;
      html += `<div class="fare-result my-2">Estimated Time: <strong>${mins} mins</strong>  Approx Distance: <strong>${dist} km</strong></div>`;

      // Build steps (group consecutive same-line segments)
      const steps = [];
      let i = 0;
      while (i < path.steps.length - 1) {
        const cur = path.steps[i];
        let j = i + 1;
        while (j < path.steps.length && path.steps[j].line === cur.line) j++;
        const segEnd = path.steps[j - 1];
        if (cur.station !== segEnd.station) {
          const stations = getStopsCount(cur, segEnd);
          steps.push({ action: `Take ${cur.line}`, details: `${cur.station}  ${segEnd.station} (${stations} stops)` });
        }
        if (j < path.steps.length) {
          const transferAt = segEnd.station;
          steps.push({ action: `Transfer`, details: `Change lines at ${transferAt}` });
        }
        i = j;
      }
      steps.push({ action: `Arrive`, details: `${end}  journey complete` });

      steps.forEach((s, idx) => {
        html += `<div class="route-step"><strong>Step ${idx + 1}:</strong> ${s.action}<br><small>${s.details}</small></div>`;
      });

      out.innerHTML = html;
      animateResult(out);

      // Show and initialize the route visualizer map
      const mapContainer = document.getElementById('routeMapContainer');
      mapContainer.style.display = 'block';

      // Initialize map if not already done
      if (!routeMapInstance) {
        initRouteVisualizerMap();
        // Wait for map to load before drawing route
        setTimeout(() => {
          if (routeMapInstance) {
            drawRouteOnMap(start, end, path.steps);
          }
        }, 1000);
      } else {
        drawRouteOnMap(start, end, path.steps);
      }
    }
    function getStopsCount(a, b) {
      // count stations between a and b on line a.line
      const list = MRT_STATIONS[a.line] || [];
      const ia = list.indexOf(a.station), ib = list.indexOf(b.station);
      return Math.abs(ib - ia);
    }

    // ====== MEET-UP ======
    function addMeetupLocation() {
      const container = document.getElementById('meetupLocations');
      const personNumber = container.children.length + 1;
      const personCard = document.createElement('div');
      personCard.className = 'person-card animate__animated animate__fadeInUp';
      personCard.innerHTML = `
        <div class="person-header">
          <div class="person-avatar">${personNumber}</div>
          <div class="person-info">
            <h6>Person ${personNumber}</h6>
            <small>Select their starting station</small>
          </div>
        </div>
        <div class="station-selector">
          <select class="form-select meetup-station" onchange="updatePersonCard(this)">
            <option value="">-- Select Station --</option>
            ${ALL_STATIONS.map(s => `<option value="${s}">${s}</option>`).join('')}
          </select>
        </div>
        <div class="d-flex justify-content-end mt-3">
          <button class="btn-modern secondary" onclick="removePersonCard(this)" style="padding: 8px 16px; font-size: 12px;">
            <span class="material-icons" style="font-size: 16px;">delete</span>
            Remove
          </button>
        </div>
      `;
      container.appendChild(personCard);

      // Add animation
      setTimeout(() => {
        personCard.classList.add('animate__fadeInUp');
      }, 50);
    }

    function updatePersonCard(selectElement) {
      const personCard = selectElement.closest('.person-card');
      const station = selectElement.value;

      if (station) {
        personCard.classList.add('active');
        const personInfo = personCard.querySelector('.person-info small');
        personInfo.textContent = `Starting from ${station}`;

        // Add success animation
        personCard.style.animation = 'none';
        setTimeout(() => {
          personCard.style.animation = 'pulse 0.6s ease-in-out';
        }, 10);
      } else {
        personCard.classList.remove('active');
        const personInfo = personCard.querySelector('.person-info small');
        personInfo.textContent = 'Select their starting station';
      }
    }

    function removePersonCard(button) {
      const personCard = button.closest('.person-card');
      personCard.classList.add('animate__fadeOutDown');

      setTimeout(() => {
        personCard.remove();
        updatePersonNumbers();
      }, 300);
    }

    function updatePersonNumbers() {
      const personCards = document.querySelectorAll('.person-card');
      personCards.forEach((card, index) => {
        const personNumber = index + 1;
        const avatar = card.querySelector('.person-avatar');
        const title = card.querySelector('.person-info h6');

        avatar.textContent = personNumber;
        title.textContent = `Person ${personNumber}`;
      });
    }

    function quickSelectStation(stationName) {
      const allSelects = document.querySelectorAll('#meetupLocations .meetup-station');
      let emptySelect = null;

      // Find first empty dropdown
      for (let select of allSelects) {
        if (!select.value || select.value === '') {
          emptySelect = select;
          break;
        }
      }

      if (emptySelect) {
        emptySelect.value = stationName;
        updatePersonCard(emptySelect);

        // Add success feedback
        const quickBtn = event.target;
        quickBtn.style.background = 'var(--sg-red)';
        quickBtn.style.color = 'white';
        setTimeout(() => {
          quickBtn.style.background = '';
          quickBtn.style.color = '';
        }, 1000);
      } else {
        // Add new person if no empty slots
        addMeetupLocation();
        setTimeout(() => {
          const newSelects = document.querySelectorAll('#meetupLocations .meetup-station');
          const newSelect = newSelects[newSelects.length - 1];
          if (newSelect) {
            newSelect.value = stationName;
            updatePersonCard(newSelect);
          }
        }, 100);
      }
    }

    function clearAllLocations() {
      const personCards = document.querySelectorAll('.person-card');
      personCards.forEach((card, index) => {
        setTimeout(() => {
          card.classList.add('animate__fadeOutDown');
          setTimeout(() => card.remove(), 300);
        }, index * 100);
      });

      // Clear results
      const output = document.getElementById('meetupOutput');
      output.classList.add('d-none');

      showToast('All locations cleared', false);
    }

    function findMeetupPoint() {
      const stations = Array.from(document.querySelectorAll('.meetup-station')).map(s => s.value).filter(Boolean);
      const out = document.getElementById('meetupOutput');

      if (stations.length < 2) {
        showToast('Please add at least 2 locations to find a meeting point', true);
        return;
      }

      // Show capybara loading animation over the map
      showMapLoadingAnimation();

      // Simulate processing time for better UX
      setTimeout(() => {

        // brute force: evaluate each candidate as meetup, choose minimal totalWeight sum
        const candidates = ALL_STATIONS;
        let best = { station: null, sum: Infinity, times: [] };

        candidates.forEach(cand => {
          let total = 0, times = [];
          for (const s of stations) {
            const p = shortestPath(s, cand);
            if (!p) { total = Infinity; break; }
            total += p.totalWeight;
            times.push(estimateTimeMinutes(p.totalWeight));
          }
          if (total < best.sum) { best = { station: cand, sum: total, times }; }
        });

        if (!best.station) {
          out.innerHTML = `
            <div class="text-center py-4">
              <span class="material-icons text-danger mb-2" style="font-size: 48px;">error_outline</span>
              <h6 class="text-danger">No Meeting Point Found</h6>
              <p class="text-muted">Unable to find a common reachable station for all locations.</p>
            </div>
          `;
          return;
        }

        // Calculate average travel time
        const avgTime = Math.round(best.times.reduce((a, b) => a + b, 0) / best.times.length);
        const maxTime = Math.max(...best.times);
        const minTime = Math.min(...best.times);

        let html = `
          <div class="d-flex align-items-center gap-3 mb-6">
            <span class="material-icons text-success success-checkmark" style="font-size: 40px;">check_circle</span>
            <h5 class="mb-0 text-success" style="font-size: var(--text-xl);">Perfect Meeting Point Found!</h5>
          </div>
          
          <div class="meeting-point animate-fade-in-scale">
            <h4 class="mb-2">${best.station}</h4>
            <p class="mb-0 opacity-75">The most convenient location for everyone</p>
          </div>
          
          <div class="row g-4 mb-6">
            <div class="col-md-4">
              <div class="text-center p-4 bg-light rounded" style="border: 1px solid var(--neutral-200);">
                <div class="h3 text-primary mb-2" style="font-family: 'Playfair Display', serif;">${avgTime}</div>
                <small class="text-muted" style="font-size: var(--text-sm);">Avg Travel Time (mins)</small>
              </div>
            </div>
            <div class="col-md-4">
              <div class="text-center p-4 bg-light rounded" style="border: 1px solid var(--neutral-200);">
                <div class="h3 text-success mb-2" style="font-family: 'Playfair Display', serif;">${minTime}</div>
                <small class="text-muted" style="font-size: var(--text-sm);">Shortest Time (mins)</small>
              </div>
            </div>
            <div class="col-md-4">
              <div class="text-center p-4 bg-light rounded" style="border: 1px solid var(--neutral-200);">
                <div class="h3 text-warning mb-2" style="font-family: 'Playfair Display', serif;">${maxTime}</div>
                <small class="text-muted" style="font-size: var(--text-sm);">Longest Time (mins)</small>
              </div>
            </div>
          </div>
          
          <h6 class="mb-4 d-flex align-items-center gap-3" style="font-size: var(--text-lg); color: var(--neutral-900);">
            <span class="material-icons" style="color: var(--sg-red);">schedule</span>
            Individual Travel Times
          </h6>
          
          <div class="travel-times">`;

        stations.forEach((s, i) => {
          const personCard = document.querySelectorAll('.person-card')[i];
          const personName = personCard ? personCard.querySelector('.person-info h6').textContent : `Person ${i + 1}`;

          html += `
            <div class="travel-time-item animate-slide-in" style="animation-delay: ${i * 0.1}s;">
              <div class="person-avatar" style="width: 40px; height: 40px; font-size: 16px;">${i + 1}</div>
              <div class="flex-grow-1">
                <div class="fw-semibold" style="font-size: var(--text-base); color: var(--neutral-900);">${personName}</div>
                <small class="text-muted" style="font-size: var(--text-sm);">From ${s}</small>
              </div>
              <div class="time-badge">${best.times[i]} min</div>
            </div>`;
        });

        html += `
          </div>
          
          <div class="d-flex gap-3 mt-6 flex-wrap">
            <button class="btn-modern" onclick="showMeetingPointInfo('${best.station}')">
              <span class="material-icons">info</span>
              Meeting Point Info
            </button>
            <button class="btn-modern secondary" onclick="shareMeetingPoint('${best.station}', [${stations.map(s => `'${s}'`).join(',')}])">
              <span class="material-icons">share</span>
              Share Meeting Point
            </button>
            <button class="btn-modern secondary" onclick="getDirections('${best.station}')">
              <span class="material-icons">directions</span>
              Get Directions
            </button>
          </div>
          
          <div class="mt-4 p-4 bg-light rounded" style="border: 1px solid var(--neutral-200);">
            <small class="text-muted" style="font-size: var(--text-sm);">
              <span class="material-icons" style="font-size: 18px; vertical-align: middle; margin-right: 8px;">info</span>
              This location minimizes total travel time for all group members (${best.sum.toFixed(1)} combined stops)
            </small>
          </div>
        `;

        out.innerHTML = html;
        out.classList.remove('d-none');

        // Hide the map loading animation and scroll to results
        hideMapLoadingAnimation();

        // Scroll to results after a short delay to ensure elements are restored
        setTimeout(() => {
          out.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }, 100);

        showToast(`Found perfect meeting point: ${best.station}!`, false);
      }, 2000);
    }

    function shareMeetingPoint(meetingPoint, locations) {
      const shareText = `Let's meet at ${meetingPoint}! \n\nOur starting locations:\n${locations.map((loc, i) => `${i + 1}. ${loc}`).join('\n')}\n\nFound using SingaTrain Meet-up Finder`;

      if (navigator.share) {
        navigator.share({
          title: 'Meeting Point',
          text: shareText
        });
      } else {
        // Fallback: copy to clipboard
        navigator.clipboard.writeText(shareText).then(() => {
          showToast('Meeting details copied to clipboard!', false);
        });
      }
    }

    function getDirections(station) {
      // This would integrate with Google Maps or Apple Maps
      const mapsUrl = `https://www.google.com/maps/search/${encodeURIComponent(station + ' MRT Station Singapore')}`;
      window.open(mapsUrl, '_blank');
    }

    function createCapybaraLoader() {
      return `
        <div class="capybaraloader">
          <div class="capybara">
            <div class="capy">
              <div class="capyhead">
                <div class="capyear">
                  <div class="capyear2"></div>
                </div>
                <div class="capyear">
                  <div class="capyear2"></div>
                </div>
                <div class="capymouth">
                  <div class="capylips"></div>
                  <div class="capylips"></div>
                </div>
                <div class="capyeye"></div>
                <div class="capyeye"></div>
              </div>
              <div class="capyleg">
                <div class="capyleg2"></div>
                <div class="capyleg2"></div>
              </div>
            </div>
          </div>
          <div class="loader">
            <div class="loaderline"></div>
          </div>
        </div>
      `;
    }

    function showMapLoadingAnimation() {
      const mapContainer = document.getElementById('meetupMap');
      if (!mapContainer) return;

      // Hide all form elements during loading
      const meetupSection = document.getElementById('meetup');
      const formElements = meetupSection.querySelectorAll('.meetup-container, .meetup-actions');
      const mapSection = meetupSection.querySelector('.mt-6'); // Map container

      // Store original display states
      window.meetupFormStates = [];
      formElements.forEach((element, index) => {
        window.meetupFormStates[index] = element.style.display;
        element.style.display = 'none';
      });

      // Show only the map section
      if (mapSection) {
        mapSection.style.display = 'block';
        mapSection.style.marginTop = '0';
      }

      // Create overlay if it doesn't exist
      let overlay = mapContainer.querySelector('.map-loading-overlay');
      if (!overlay) {
        overlay = document.createElement('div');
        overlay.className = 'map-loading-overlay';
        overlay.innerHTML = `
          <div class="map-loading-content">
            ${createCapybaraLoader()}
            <h6>Finding the perfect meeting point</h6>
            <p>Analyzing locations across the MRT network</p>
          </div>
        `;
        mapContainer.style.position = 'relative';
        mapContainer.appendChild(overlay);
      }

      // Show the overlay
      setTimeout(() => {
        overlay.classList.add('show');
      }, 100);
    }

    function hideMapLoadingAnimation() {
      const mapContainer = document.getElementById('meetupMap');
      if (!mapContainer) return;

      const overlay = mapContainer.querySelector('.map-loading-overlay');
      if (overlay) {
        overlay.classList.remove('show');
        // Remove overlay after animation completes
        setTimeout(() => {
          if (overlay.parentNode) {
            overlay.parentNode.removeChild(overlay);
          }
        }, 300);
      }

      // Restore form elements after loading
      const meetupSection = document.getElementById('meetup');
      const formElements = meetupSection.querySelectorAll('.meetup-container, .meetup-actions');
      const mapSection = meetupSection.querySelector('.mt-6'); // Map container

      // Restore original display states
      if (window.meetupFormStates) {
        formElements.forEach((element, index) => {
          if (window.meetupFormStates[index] !== undefined) {
            element.style.display = window.meetupFormStates[index] || '';
          } else {
            element.style.display = '';
          }
        });
      }

      // Restore map section margin
      if (mapSection) {
        mapSection.style.marginTop = '';
      }

      // Clear stored states
      window.meetupFormStates = null;
    }

    // ====== ALTERNATIVE ROUTES ======
    async function findAlternatives() {
      const start = document.getElementById('altStart').value;
      const end = document.getElementById('altEnd').value;
      const affectedLine = document.getElementById('affectedLine').value;
      const out = document.getElementById('altOutput');
      if (!start || !end) { out.innerHTML = '<span class="text-danger">Please select both start and destination.</span>'; return; }

      out.innerHTML = '<div class="text-secondary">Finding alternative routes</div>';

      // get disrupted lines (if not provided)
      let affected = [];
      try {
        if (affectedLine) {
          affected = [affectedLine];
        } else {
          try {
            const alertUrl = `${PROXY}${encodeURIComponent(API_BASE + "/TrainServiceAlerts")}`;
            const res = await fetch(alertUrl, { headers: { AccountKey: ACCOUNT_KEY, accept: "application/json" } });
            if (res.ok) {
              const data = await res.json();
              const alerts = Array.isArray(data.value || data.Value) ? (data.value || data.Value) : (Array.isArray(data) ? data : []);
              affected = alerts.filter(a => a.Status == 2).map(a => a.Line || a.line).filter(Boolean);
            }
          } catch (e) {
            console.log('Alternative routes API unavailable, no affected lines detected');
            affected = [];
          }
        }
      } catch (e) { /* ignore, show no affected */ }

      let html = '<h5>Alternative Routes</h5>';
      if (affected.length) {
        html += `<div class="alert-card alert-disrupted mb-2"><strong> Disruption:</strong> ${affected.join(', ')}</div>`;
      }

      // Option 1: MRT alternative  well just return normal route (path planner will likely avoid nothing without full GTFS);
      const p = shortestPath(start, end);
      if (p) {
        html += renderAltCard('Alternative MRT Route', p);
      } else {
        html += `<div class="text-danger">No MRT path found.</div>`;
      }

      // Option 2 / 3: simple placeholders (since bus routes require other datasets/APIs)
      html += renderSimpleAlt('Bus Alternative', 'Take closest bus from origin, transfer where needed, and alight near destination. Check Bus Arrival in LTA apps.');
      html += renderSimpleAlt('Mixed MRT + Bus', 'Ride MRT part-way, switch to bus to bypass affected section, then continue MRT.');

      out.innerHTML = html;
    }
    function renderAltCard(title, path) {
      const mins = estimateTimeMinutes(path.totalWeight);
      let stepsHTML = '';
      // collapse steps by line
      const segs = [];
      let i = 0;
      while (i < path.steps.length - 1) {
        const cur = path.steps[i]; let j = i + 1;
        while (j < path.steps.length && path.steps[j].line === cur.line) j++;
        segs.push({ from: cur.station, to: path.steps[j - 1].station, line: cur.line, stops: getStopsCount(cur, path.steps[j - 1]) });
        i = j;
      }
      stepsHTML += segs.map(s => `<div class="route-step">Take <strong>${s.line}</strong>: ${s.from}  ${s.to} (${s.stops} stops)</div>`).join('');
      return `
        <div class="border rounded-3 p-3 my-2">
          <h6 class="text-danger">${title}</h6>
          <p class="mb-1"><strong>Estimated Time:</strong> ${mins} minutes</p>
          <p class="mb-1"><strong>Route:</strong></p>
          ${stepsHTML}
        </div>
      `;
    }
    function renderSimpleAlt(title, text) {
      return `
        <div class="border rounded-3 p-3 my-2">
          <h6 class="text-danger">${title}</h6>
          <p class="mb-1">${text}</p>
        </div>`;
    }

    // ====== FARES ======
    // --- Adult (Card) ---
    const fareBandsAdult = [
      { max: 3.2, fare: 1.19 }, { max: 4.2, fare: 1.29 }, { max: 5.2, fare: 1.40 },
      { max: 6.2, fare: 1.50 }, { max: 7.2, fare: 1.59 }, { max: 8.2, fare: 1.66 },
      { max: 9.2, fare: 1.73 }, { max: 10.2, fare: 1.77 }, { max: 11.2, fare: 1.81 },
      { max: 12.2, fare: 1.85 }, { max: 13.2, fare: 1.89 }, { max: 14.2, fare: 1.93 },
      { max: 15.2, fare: 1.98 }, { max: 16.2, fare: 2.02 }, { max: 17.2, fare: 2.06 },
      { max: 18.2, fare: 2.10 }, { max: 19.2, fare: 2.14 }, { max: 20.2, fare: 2.17 },
      { max: 21.2, fare: 2.20 }, { max: 22.2, fare: 2.23 }, { max: 23.2, fare: 2.26 },
      { max: 24.2, fare: 2.28 }, { max: 25.2, fare: 2.30 }, { max: 26.2, fare: 2.32 },
      { max: 27.2, fare: 2.33 }, { max: 28.2, fare: 2.34 }, { max: 29.2, fare: 2.35 },
      { max: 30.2, fare: 2.36 }, { max: 31.2, fare: 2.37 }, { max: 32.2, fare: 2.38 },
      { max: 33.2, fare: 2.39 }, { max: 34.2, fare: 2.40 }, { max: 35.2, fare: 2.41 },
      { max: 36.2, fare: 2.42 }, { max: 37.2, fare: 2.43 }, { max: 38.2, fare: 2.44 },
      { max: 39.2, fare: 2.45 }, { max: 40.2, fare: 2.46 }, { max: Infinity, fare: 2.47 }
    ];

    // --- Student (Card) ---
    const fareBandsStudent = [
      { max: 3.2, fare: 0.52 }, { max: 4.2, fare: 0.57 }, { max: 5.2, fare: 0.63 },
      { max: 6.2, fare: 0.68 }, { max: 7.2, fare: 0.71 }, { max: Infinity, fare: 0.74 }
    ];

    // --- Senior Citizens / Persons with Disabilities (Card) ---
    const fareBandsSenior = [
      { max: 3.2, fare: 0.69 }, { max: 4.2, fare: 0.76 }, { max: 5.2, fare: 0.84 },
      { max: 6.2, fare: 0.91 }, { max: 7.2, fare: 0.97 }, { max: Infinity, fare: 1.03 }
    ];

    // --- Workfare Transport Concession (Card) ---
    const fareBandsWorkfare = [
      { max: 3.2, fare: 0.78 }, { max: 4.2, fare: 0.86 }, { max: 5.2, fare: 0.95 },
      { max: 6.2, fare: 1.03 }, { max: 7.2, fare: 1.10 }, { max: 8.2, fare: 1.16 },
      { max: 9.2, fare: 1.22 }, { max: 10.2, fare: 1.25 }, { max: 11.2, fare: 1.28 },
      { max: 12.2, fare: 1.31 }, { max: 13.2, fare: 1.34 }, { max: 14.2, fare: 1.37 },
      { max: 15.2, fare: 1.40 }, { max: 16.2, fare: 1.43 }, { max: 17.2, fare: 1.46 },
      { max: 18.2, fare: 1.49 }, { max: 19.2, fare: 1.52 }, { max: 20.2, fare: 1.55 },
      { max: 21.2, fare: 1.58 }, { max: 22.2, fare: 1.61 }, { max: 23.2, fare: 1.64 },
      { max: 24.2, fare: 1.66 }, { max: 25.2, fare: 1.67 }, { max: 26.2, fare: 1.68 },
      { max: 27.2, fare: 1.69 }, { max: 28.2, fare: 1.70 }, { max: 29.2, fare: 1.71 },
      { max: 30.2, fare: 1.72 }, { max: 31.2, fare: 1.73 }, { max: 32.2, fare: 1.74 },
      { max: 33.2, fare: 1.75 }, { max: 34.2, fare: 1.76 }, { max: 35.2, fare: 1.77 },
      { max: 36.2, fare: 1.78 }, { max: 37.2, fare: 1.79 }, { max: 38.2, fare: 1.80 },
      { max: 39.2, fare: 1.81 }, { max: 40.2, fare: 1.82 }, { max: Infinity, fare: 1.83 }
    ];



    // ====== Monthly Pass Tables (LTA Dec 2024) ======
    const monthlyPasses = {
      // --- Train-only passes ---
      train: {
        primary: 21.00,
        secondary: 26.50,
        polytechnic: 26.50,
        university: 48.00,
        ns: 48.00,
        senior: 58.00,
        disability: 58.00,
        workfare: 96.00,
        adult: 128.00
      },

      // --- Bus-only passes ---
      bus: {
        primary: 24.00,
        secondary: 29.00,
        polytechnic: 29.00,
        university: 55.50,
        ns: 55.50,
        senior: 58.00,
        disability: 58.00,
        workfare: 96.00,
        adult: 128.00
      },

      // --- Hybrid (Bus + Train) passes ---
      hybrid: {
        primary: 39.00,
        secondary: 49.00,
        polytechnic: 49.00,
        university: 81.00,
        ns: 81.00,
        senior: 58.00,
        disability: 58.00,
        workfare: 96.00,
        adult: 128.00
      }
    };


    function fareByType(km, type = "adult") {
      let bands;

      switch (type) {
        //  Students up to Polytechnic  Student table
        case "primary":
        case "secondary":
        case "polytechnic":
          bands = fareBandsStudent;
          break;

        //  Seniors & PWD  Senior table
        case "senior":
        case "disability":
          bands = fareBandsSenior;
          break;

        //  Workfare  Workfare table
        case "workfare":
          bands = fareBandsWorkfare;
          break;

        //  University & NS use the same fare as Adults
        case "university":
        case "ns":
        case "adult":
        default:
          bands = fareBandsAdult;
      }

      for (const b of bands) {
        if (km <= b.max) return b.fare;
      }
      return bands[bands.length - 1].fare;
    }


    function calculateFare() {
      const start = document.getElementById('fareStart').value;
      const end = document.getElementById('fareEnd').value;
      const type = document.getElementById('commuterType').value;
      const out = document.getElementById('fareOutput');

      if (!start || !end) {
        out.innerHTML = '<span class="text-danger">Please select both stations.</span>';
        animateResult(out);
        return;
      }

      const p = shortestPath(start, end);
      if (!p) {
        out.innerHTML = '<span class="text-danger">No route found.</span>';
        animateResult(out);
        return;
      }

      const km = estimateDistanceKm(p.totalWeight);
      const fare = fareByType(km, type);
      const typeText = document.querySelector(`#commuterType option[value="${type}"]`).textContent;

      let html = `<h5>Fare Calculation</h5>`;
      html += `<div class="fare-result">
    <div class="fs-3 mb-1">$${fare.toFixed(2)}</div>
    <div class="small">Estimated fare (${typeText})</div>
  </div>`;
      html += `<div class="border rounded p-3 bg-light">
    <p class="mb-1"><strong>Journey:</strong> ${start}  ${end}</p>
    <p class="mb-1"><strong>Approx Distance:</strong> ${km} km (stops-based estimate)</p>
  </div>`;
      out.innerHTML = html;
      animateResult(out);
    }

    function calculatePassValue() {
      const start = document.getElementById('fareStart').value;
      const end = document.getElementById('fareEnd').value;
      const type = document.getElementById('commuterType').value;
      const dailyTrips = parseInt(document.getElementById('dailyTrips').value) || 2;
      const workingDays = parseInt(document.getElementById('workingDays').value) || 22;
      const out = document.getElementById('passOutput');

      if (!start || !end) {
        out.innerHTML = '<span class="text-danger">Select journey in the fare calculator above.</span>';
        animateResult(out);
        return;
      }

      const path = shortestPath(start, end);
      if (!path) {
        out.innerHTML = '<span class="text-danger">No route found.</span>';
        animateResult(out);
        return;
      }

      // Estimate trip fare
      const km = estimateDistanceKm(path.totalWeight);
      const singleFare = fareByType(km, type);
      const monthlyTotal = singleFare * dailyTrips * workingDays;

      // Decide relevant pass types
      const travelModes = ["train", "bus", "hybrid"];
      const results = [];

      for (const mode of travelModes) {
        const passPrice = monthlyPasses[mode][type] ?? monthlyPasses[mode]["adult"];
        const savings = monthlyTotal - passPrice;
        const worth = savings > 0;
        results.push({ mode, passPrice, savings, worth });
      }

      // Render output
      let html = `<h5>Monthly Pass Analysis</h5>`;
      html += `<div class="border rounded p-3 bg-light mb-3">
    <p><strong>Single Trip Fare:</strong> $${singleFare.toFixed(2)}</p>
    <p><strong>Daily Trips:</strong> ${dailyTrips}</p>
    <p><strong>Working Days:</strong> ${workingDays}</p>
    <p><strong>Estimated Monthly Spend (Pay-Per-Ride):</strong> $${monthlyTotal.toFixed(2)}</p>
  </div>`;

      html += `<div class="table-responsive">
    <table class="table table-striped align-middle">
      <thead class="table-warning text-center">
        <tr>
          <th>Pass Type</th>
          <th>Price ($)</th>
          <th>Net Savings / Loss ($)</th>
          <th>Recommendation</th>
        </tr>
      </thead>
      <tbody class="text-center">`;

      for (const r of results) {
        html += `<tr>
      <td class="text-capitalize">${r.mode}</td>
      <td>${r.passPrice.toFixed(2)}</td>
      <td class="${r.worth ? 'text-success' : 'text-danger'}">
        ${r.worth ? '+' : ''}${Math.abs(r.savings).toFixed(2)}
      </td>
      <td>${r.worth ? ' Worth It' : ' Not Worth It'}</td>
    </tr>`;
      }

      html += `</tbody></table></div>`;

      out.innerHTML = html;
      animateResult(out);
    }

    function animateResult(element) {
      if (!element) return;
      element.classList.remove('feature-result-animate');
      void element.offsetWidth;
      element.classList.add('feature-result-animate');
      if (window.gsap) {
        gsap.fromTo(element, { opacity: 0, y: 18 }, { opacity: 1, y: 0, duration: 0.45, ease: 'power2.out' });
      }
    }

    let arrivalRenderIntervalId = null;
    let liveClockIntervalId = null;
    let liveTickerIntervalId = null;
    let liveTickerIndex = 0;
    function getStationsForArrivalDisplay(arrivalData) {
      if (!arrivalData) return [];
      const favoriteStations = Array.isArray(userData?.favorites)
        ? userData.favorites.map(f => f.station)
        : [];
      const availableStations = Object.keys(arrivalData);
      const validFavorites = favoriteStations.filter(station => arrivalData[station]);
      if (validFavorites.length > 0) { return validFavorites; }
      return availableStations.slice(0, 4);
    }
    function formatArrivalCountdown(totalSeconds) {
      if (totalSeconds <= 0) { return 'Arriving'; }
      const minutes = Math.max(1, Math.ceil(totalSeconds / 60));
      return `${minutes} min${minutes > 1 ? 's' : ''}`;
    }
    function generateTickerTimes() {
      const count = Math.floor(Math.random() * 2) + 2; // 2 or 3 trains
      const times = Array.from({ length: count }, () => Math.floor(Math.random() * 6) + 1);
      times.sort((a, b) => a - b);
      return times;
    }
    function renderLiveTickerCard(animate = true) {
      const card = document.getElementById('liveTickerCard');
      if (!card) return;
      const entry = LIVE_TICKER_STATIONS[liveTickerIndex % LIVE_TICKER_STATIONS.length];
      const lineColor = getLineColor(entry.line);
      const times = generateTickerTimes();
      const timeBadges = times.map(min => `<span class="ticker-pill" style="color:${lineColor};border-color:${lineColor};">${min} min${min > 1 ? 's' : ''}</span>`).join('');
      card.innerHTML = `
        <div>
          <div class="ticker-label">Simulated Live Feed</div>
          <div class="ticker-station">${entry.station}</div>
          <div class="ticker-line" style="color:${lineColor}">
            <span class="material-icons">train</span>${entry.line}
          </div>
        </div>
        <div class="ticker-times">
          ${timeBadges}
        </div>
      `;
      card.classList.remove('cycle');
      if (window.gsap) {
        gsap.fromTo(card, { scale: 0.96, opacity: 0.75 }, { scale: 1, opacity: 1, duration: 0.5, ease: 'power2.out' });
      } else if (animate) {
        void card.offsetWidth;
        card.classList.add('cycle');
      } else {
        // no animation requested
      }
    }
    function startLiveTicker() {
      if (liveTickerIntervalId !== null) return;
      liveTickerIndex = Math.floor(Math.random() * LIVE_TICKER_STATIONS.length);
      renderLiveTickerCard();
      liveTickerIntervalId = setInterval(() => {
        liveTickerIndex = (liveTickerIndex + 1) % LIVE_TICKER_STATIONS.length;
        renderLiveTickerCard();
      }, LIVE_TICKER_ROTATION_MS);
    }
    function stopLiveTicker() {
      if (liveTickerIntervalId !== null) {
        clearInterval(liveTickerIntervalId);
        liveTickerIntervalId = null;
      }
    }
    function renderLiveArrivals() {
      const container = document.getElementById('liveArrivals');
      if (!container) return;

      const simulator = window.trainArrivalSimulator;
      const delayToggle = document.getElementById('delayToggle');
      if (delayToggle && simulator?.config?.delay) {
        delayToggle.checked = !!simulator.config.delay.enabled;
      }

      if (!simulator) {
        container.innerHTML = '<div class="text-secondary">Arrival simulator is still loading</div>';
        return;
      }

      const arrivalData = simulator.getArrivals({ returnSeconds: true });
      const delayFlags = typeof simulator.getDelayFlags === 'function' ? simulator.getDelayFlags() : {};
      let stations = getStationsForArrivalDisplay(arrivalData);

      // Favorite stations for highlighting
      const favoriteStations = Array.isArray(userData?.favorites)
        ? userData.favorites.map(f => f.station)
        : [];

      const filterLine = document.getElementById('liveTrainLine')?.value || '';
      if (filterLine) {
        const filterStations = Object.entries(arrivalData)
          .filter(([, lineMap]) => lineMap && lineMap[filterLine])
          .map(([station]) => station);

        if (filterStations.length) {
          const ordered = [];
          const seen = new Set();
          [...stations.filter(st => filterStations.includes(st)), ...filterStations].forEach(station => {
            if (!seen.has(station)) {
              ordered.push(station);
              seen.add(station);
            }
          });
          stations = ordered;
        }
      }

      if (stations.length === 0) {
        const supported = Object.keys(simulator.config.stationLines || {}).join(', ');
        container.innerHTML = `<div class="text-secondary">Add a favorite station to see simulated countdowns. Supported demo stations: ${supported || 'loading'}.</div>`;
        return;
      }

      const cards = [];
      const buildStatus = (seconds, idx, isDelayed) => {
        if (isDelayed) {
          return { label: 'Delayed', css: 'status-delayed', icon: 'report_problem' };
        }
        if (seconds <= 20) {
          return { label: 'Departing', css: 'status-departing', icon: 'directions_walk' };
        }
        if (seconds <= 75) {
          return { label: 'Arriving', css: 'status-arriving', icon: 'south_east' };
        }
        if (idx === 0 && seconds <= 120) {
          return { label: 'Approaching', css: 'status-arriving', icon: 'schedule' };
        }
        return { label: 'On Time', css: 'status-on-time', icon: 'check_circle' };
      };

      stations.forEach(station => {
        const lineMap = arrivalData[station];
        if (!lineMap) return;

        let hasMatchingLine = false;
        let soonestCountdown = Infinity;

        const lineSectionsHtml = Object.entries(lineMap).map(([lineName, arrivals]) => {
          if (filterLine && lineName !== filterLine) return '';
          if (!Array.isArray(arrivals) || arrivals.length === 0) return '';

          hasMatchingLine = true;
          const lineColor = getLineColor(lineName);
          const maxSeconds = getLineMaxSeconds(simulator, lineName);
          const isDelayed = Boolean(delayFlags?.[station]?.[lineName] && delayFlags[station][lineName] > Date.now());

          const rows = arrivals.map((seconds, idx) => {
            const label = formatArrivalCountdown(seconds);
            if (seconds < soonestCountdown) soonestCountdown = seconds;
            const progress = Math.min(1, Math.max(0, 1 - seconds / maxSeconds));
            const styleColor = lineColor;
            const iconStyles = `background:${styleColor}1a;color:${styleColor};box-shadow:inset 0 0 0 1px ${styleColor}55;`;
            const status = buildStatus(seconds, idx, isDelayed && idx === 0);
            const statusPill = `<span class="status-pill ${status.css}"><span class="material-icons" style="font-size:14px;">${status.icon}</span>${status.label}</span>`;
            return `<div class="arrival-row">
          <div class="train-icon" style="${iconStyles}">
            <span class="material-icons">${idx === 0 ? 'train' : 'tram'}</span>
          </div>
          <div class="arrival-details">
            <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
              <div class="countdown">${label}</div>
              ${statusPill}
            </div>
            <div class="progress-bar" aria-hidden="true">
            <div class="progress-fill" style="background:${styleColor};transform:scaleX(${progress.toFixed(2)});"></div>
            <div class="progress-glow" style="color:${styleColor};"></div>
            </div>
          </div>
        </div>`;
          }).join('');

          return `<div class="line-section">
        <div class="line-label" style="color:${lineColor}">
          <span>${lineName}</span>
          <span class="subtle">Next ${arrivals.length} trains</span>
        </div>
        ${rows}
      </div>`;
        }).filter(Boolean).join('');

        if (!hasMatchingLine) return;

        const isFavorite = favoriteStations.includes(station);
        const favoriteClass = isFavorite ? 'favorite-toggle active' : 'favorite-toggle';
        const badgeTone = isFavorite ? 'bg-danger-subtle text-danger' : 'bg-secondary-subtle text-secondary';
        const soonClass = soonestCountdown <= 45 ? 'arrival-card arriving-soon' : 'arrival-card';
        const stationForJs = station.replace(/\\/g, '\\\\').replace(/'/g, '\\\'');

        cards.push(`<div class="${soonClass}">
      <div class="arrival-header">
        <div>
          <div class="station-name">${station}</div>
          <span class="badge ${badgeTone}">Next trains</span>
        </div>
        <button class="${favoriteClass}" type="button" onclick="toggleFavorite('${stationForJs}')">
          <span class="material-icons">${isFavorite ? 'star' : 'star_border'}</span>
        </button>
      </div>
      ${lineSectionsHtml}
    </div>`);
      });

      container.innerHTML = cards.length ? cards.join('') : '<div class="text-secondary">No simulated data available for your selected stations yet.</div>';
    }
    if (window.gsap && container.children.length) {
      gsap.fromTo(container.querySelectorAll('.arrival-card'), { opacity: 0, y: 20 }, {
        opacity: 1,
        y: 0,
        duration: 0.6,
        ease: 'power2.out',
        stagger: 0.05
      });
    }
    window.manualRefreshArrivals = function () {
      renderLiveArrivals();
      renderLiveTickerCard();
    };
    window.toggleSimulatedDelay = function (isEnabled) {
      if (window.trainArrivalSimulator?.config?.delay) {
        window.trainArrivalSimulator.config.delay.enabled = isEnabled;
      }
      renderLiveArrivals();
      renderLiveTickerCard();
    };
    const timingState = {
      line: 'Downtown Line',
      direction: null,
      search: ''
    };

    function getTimingDirections(line) {
      const lineData = TRAIN_TIMINGS[line];
      return lineData ? Object.keys(lineData) : [];
    }

    function populateTimingFilters() {
      const lineSelect = document.getElementById('timingLineSelect');
      const directionSelect = document.getElementById('timingDirectionSelect');
      if (!lineSelect || !directionSelect) return;

      const lines = Object.keys(TRAIN_TIMINGS);
      lineSelect.innerHTML = lines.map(line => `<option value="${line}">${line}</option>`).join('');

      if (!lines.includes(timingState.line)) {
        timingState.line = lines[0];
      }
      lineSelect.value = timingState.line;

      const directions = getTimingDirections(timingState.line);
      directionSelect.innerHTML = directions.length
        ? directions.map(direction => `<option value="${direction}">${direction}</option>`).join('')
        : '<option value="">Coming Soon</option>';
      if (!timingState.direction || !directions.includes(timingState.direction)) {
        timingState.direction = directions[0] || '';
      }
      directionSelect.value = timingState.direction || '';
      directionSelect.disabled = !directions.length;

      const searchInput = document.getElementById('timingSearchInput');
      if (searchInput) {
        searchInput.value = timingState.search;
      }

      renderTrainTimings();
    }

    function renderTrainTimings() {
      const grid = document.getElementById('trainTimingsGrid');
      if (!grid) return;
      const lineData = TRAIN_TIMINGS[timingState.line] || {};
      const directionData = timingState.direction ? (lineData[timingState.direction] || []) : [];
      const query = timingState.search.trim().toLowerCase();

      if (!directionData.length) {
        grid.innerHTML = `<div class="text-secondary">Timings for ${timingState.line} will be available soon. Stay tuned!</div>`;
        return;
      }

      const results = query
        ? directionData.filter(item =>
          item.station.toLowerCase().includes(query) || item.code.toLowerCase().includes(query))
        : directionData;

      if (!results.length) {
        grid.innerHTML = `<div class="text-secondary">No stations matched ${timingState.search}. Try a different name.</div>`;
        return;
      }

      const cards = results.map(item => {
        const firstIcon = item.first === '' ? 'hourglass_empty' : 'light_mode';
        const lastIcon = item.last === '' ? 'hourglass_empty' : 'nightlight';
        const firstTime = item.first === '' ? 'Coming Soon' : item.first;
        const lastTime = item.last === '' ? 'Coming Soon' : item.last;
        return `<div class="timing-card">
            <div class="station-code">${item.code}</div>
            <div class="station-name">${item.station}</div>
            <div class="time-row"><span><span class="material-icons">${firstIcon}</span>First Train</span><span>${firstTime}</span></div>
            <div class="time-row"><span><span class="material-icons">${lastIcon}</span>Last Train</span><span>${lastTime}</span></div>
          </div>`;
      });

      grid.innerHTML = cards.join('');
      if (window.gsap) {
        gsap.fromTo(grid.children, { opacity: 0, y: 16 }, {
          opacity: 1,
          y: 0,
          duration: 0.5,
          ease: 'power2.out',
          stagger: 0.06
        });
      }
    }

    function handleTimingFilterChange() {
      const lineSelect = document.getElementById('timingLineSelect');
      const directionSelect = document.getElementById('timingDirectionSelect');
      const searchInput = document.getElementById('timingSearchInput');
      if (!lineSelect || !directionSelect || !searchInput) return;

      lineSelect.addEventListener('change', () => {
        timingState.line = lineSelect.value;
        const directions = getTimingDirections(timingState.line);
        timingState.direction = directions[0] || '';
        timingState.search = '';
        searchInput.value = '';
        populateTimingFilters();
      });

      directionSelect.addEventListener('change', () => {
        timingState.direction = directionSelect.value;
        renderTrainTimings();
      });

      searchInput.addEventListener('input', () => {
        timingState.search = searchInput.value;
        renderTrainTimings();
      });
    }

    function registerGsapAnimations() {
      if (!window.gsap) return;
      gsap.from('.premium-navbar', { y: -40, opacity: 0, duration: 0.8, ease: 'power2.out' });
      gsap.from('.hero-intro', { opacity: 0, y: 40, duration: 0.9, ease: 'power2.out', delay: 0.15 });
      gsap.from('.hero-illustration', { opacity: 0, y: 60, duration: 1, ease: 'power2.out', delay: 0.25 });
      gsap.from('.timings-panel', { opacity: 0, scale: 0.96, duration: 0.75, ease: 'power2.out', delay: 0.4 });
      document.querySelectorAll('.hover-float').forEach(btn => {
        if (btn.dataset.gsapBound) return;
        btn.dataset.gsapBound = 'true';
        btn.addEventListener('mouseenter', () => gsap.to(btn, { y: -4, duration: 0.25, ease: 'power2.out' }));
        btn.addEventListener('mouseleave', () => gsap.to(btn, { y: 0, duration: 0.3, ease: 'power2.out' }));
      });
    }
    function triggerDemoNarration() {
      // Quick script cue card for presenters to highlight hero interactions
      const message = [
        'Demo Tips:',
        '1. Notice how the hero animation feels alive, setting the tone for a high-speed commuter experience.',
        '2. Watch the train cards glow when a service is arriving; it mimics platform announcements.',
        '3. Favorites sync across the dashboard and live viewtap the star to personalize your commute.',
        '4. Light and dark themes keep the UI presentation-ready whether youre indoors or on the go.'
      ].join('\n');
      alert(message);
    }
    function updateLiveClockDisplay() {
      const clockEl = document.getElementById('liveClock');
      if (!clockEl) return;
      const now = new Date();
      const parts = now.toLocaleTimeString(undefined, { hour12: false });
      clockEl.innerHTML = `<span>${parts}</span>`;
    }
    function startLiveClock() {
      if (liveClockIntervalId === null) {
        liveClockIntervalId = setInterval(updateLiveClockDisplay, 1000);
      }
      updateLiveClockDisplay();
    }
    function startArrivalRenderLoop() {
      if (arrivalRenderIntervalId === null) {
        arrivalRenderIntervalId = setInterval(renderLiveArrivals, 1000);
      }
      renderLiveArrivals();
    }
    function stopArrivalRenderLoop() {
      if (arrivalRenderIntervalId !== null) {
        clearInterval(arrivalRenderIntervalId);
        arrivalRenderIntervalId = null;
      }
    }
    function setTheme(mode) {
      const bodyEl = document.body;
      const toggleBtn = document.getElementById('themeToggle');
      // Update global palette and button state, storing preference for later visits
      if (mode === 'dark') {
        bodyEl.classList.add('dark-mode');
        toggleBtn?.classList.add('active');
        if (toggleBtn) {
          toggleBtn.querySelector('.material-icons').textContent = 'light_mode';
          toggleBtn.querySelector('.toggle-label').textContent = 'Day Mode';
        }
        localStorage.setItem('singatrain-theme', 'dark');
      } else {
        bodyEl.classList.remove('dark-mode');
        toggleBtn?.classList.remove('active');
        if (toggleBtn) {
          toggleBtn.querySelector('.material-icons').textContent = 'dark_mode';
          toggleBtn.querySelector('.toggle-label').textContent = 'Night Mode';
        }
        localStorage.setItem('singatrain-theme', 'light');
      }
    }
    function initializeThemeToggle() {
      const saved = localStorage.getItem('singatrain-theme');
      const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
      const initialMode = saved || (prefersDark ? 'dark' : 'light');
      setTheme(initialMode);
      document.getElementById('themeToggle')?.addEventListener('click', () => {
        const isDark = document.body.classList.contains('dark-mode');
        setTheme(isDark ? 'light' : 'dark');
      });
    }
    // robust loadDashboard that waits for visibility + forces reflow
    async function loadDashboard() {
      const favContainer = document.getElementById('dashboardFavorites');
      const alertContainer = document.getElementById('dashboardAlerts');

      if (!favContainer) {
        console.warn('loadDashboard: #dashboardFavorites not found in DOM yet');
        return;
      }

      // Clear quickly to avoid duplicate content
      favContainer.innerHTML = '';

      // If dashboardSection is hidden, make it visible first so CSS/layout can settle
      const dashboardSectionEl = document.getElementById('dashboard');
      if (dashboardSectionEl && dashboardSectionEl.classList.contains('d-none')) {
        dashboardSectionEl.classList.remove('d-none');
        // if you use .hidden instead of .d-none, adjust accordingly
      }

      // Wait for the next two animation frames so browser can apply styles / layout
      await new Promise(requestAnimationFrame);
      await new Promise(requestAnimationFrame);

      // Small extra tick to allow fonts/CSS to settle
      await new Promise(res => setTimeout(res, 25));

      // Debug info
      console.debug('loadDashboard: userData.favorites length =', userData?.favorites?.length);
      console.debug('loadDashboard: favContainer clientWidth,height =', favContainer.clientWidth, favContainer.clientHeight);

      // Populate favorites grid
      if (!userData || !Array.isArray(userData.favorites) || userData.favorites.length === 0) {
        favContainer.innerHTML = '<div class="text-secondary">No favorites. Add some in Profile.</div>';
      } else {
        favContainer.innerHTML = userData.favorites.map(f => `
      <div class="col-md-6">
        <div class="border rounded p-3 h-100" role="button" onclick="viewFavoriteDetails('${f.station.replace(/'/g, "\\'")}')">
          <div class="fw-semibold">${f.label}</div>
          <div class="text-danger">${f.station}</div>
          <div class="small text-secondary">Click for live info</div>
        </div>
      </div>
    `).join('');
      }

      // Force synchronous reflow / repaint to ensure bootstrap columns lay out
      // reading offsetHeight triggers reflow
      // eslint-disable-next-line no-unused-expressions
      favContainer.offsetHeight;

      // Trigger a window resize event (some layouts respond to it)
      window.dispatchEvent(new Event('resize'));

      // --- Alerts (unchanged, but wrapped so it doesn't block) ---
      alertContainer.innerHTML = '<div class="text-secondary">Loading alerts</div>';
      (async () => {
        try {
          const url = `${PROXY}${encodeURIComponent(API_BASE + "/TrainServiceAlerts")}`;
          const res = await fetch(url, { headers: { AccountKey: ACCOUNT_KEY, accept: "application/json" } });
          if (!res.ok) throw new Error('Alerts not available');
          const data = await res.json();
          let alerts = Array.isArray(data.value || data.Value) ? (data.value || data.Value) : (Array.isArray(data) ? data : []);
          if (alerts.length === 0) {
            alertContainer.innerHTML = '<div class="alert-card alert-normal"> All train lines operating normally</div>';
          } else {
            alertContainer.innerHTML = alerts.map(a => {
              const disrupted = a.Status == 2;
              return `<div class="alert-card ${disrupted ? 'alert-disrupted' : 'alert-normal'} mb-2">
            <strong>${disrupted ? '' : ''} ${a.Line || 'Line'}</strong><br>
            <small>${a.Message || 'No details'}</small>
          </div>`;
            }).join('');
          }
        } catch (err) {
          console.log('Dashboard alerts API unavailable, showing normal status');
          alertContainer.innerHTML = '<div class="alert-card alert-normal"> All train lines operating normally (demo mode)</div>';
        }
      })();
    }

  function viewFavoriteDetails(station) {
    alert(`Live details for ${station} would appear here.

In a full build: live arrivals, crowd level, service alerts, nearby facilities.`);
  }


    // ====== MAPBOX ======
    function initMeetupMap() {
      mapboxgl.accessToken = 'pk.eyJ1IjoiY2hlZWF1biIsImEiOiJja2NydG83cWMwaGJsMnBqdjR5aHc3MzdlIn0.YGTZpi7JQMquEOv9E8K_bg';
      const map = new mapboxgl.Map({
        container: 'meetupMap',
        style: 'mapbox://styles/mapbox/streets-v11',
        center: [103.8475, 1.3011], zoom: 11, renderWorldCopies: false
      });
      map.addControl(new mapboxgl.NavigationControl());

      map.on('load', async () => {
        try {
          const response = await fetch('./rail-map-standalone/sg-rail.geo.66ea655e.json');
          if (!response.ok) throw new Error(`HTTP ${response.status}`);
          const data = await response.json();

          map.addSource('mrt-stations', { type: 'geojson', data });
          map.addLayer({
            id: 'mrt-lines', source: 'mrt-stations', filter: ['==', ['geometry-type'], 'LineString'], type: 'line',
            paint: {
              'line-width': ['interpolate', ['linear'], ['zoom'], 10, 2, 16, 6],
              'line-color': [
                'match', ['get', 'line_color'],
                'orangered', '#d42e12', 'mediumseagreen', '#009645', 'orange', '#fa9e0d', 'saddlebrown', '#9D5B25',
                'darkmagenta', '#9900aa', 'darkslateblue', '#005ec4', 'gray', '#748477', '#748477'
              ], 'line-opacity': 0.8
            }, layout: { 'line-cap': 'round', 'line-join': 'round' }
          });
          map.addLayer({
            id: 'stations', source: 'mrt-stations', filter: ['==', ['get', 'stop_type'], 'station'], type: 'circle',
            paint: {
              'circle-radius': 6,
              'circle-color': [
                'match', ['get', 'station_colors'],
                'red', '#d42e12', 'green', '#009645', 'orange', '#fa9e0d', 'brown', '#9D5B25', 'purple', '#9900aa', 'blue', '#005ec4', '#748477'
              ],
              'circle-stroke-color': '#fff', 'circle-stroke-width': 2
            }
          });
          map.addLayer({
            id: 'station-labels', source: 'mrt-stations', filter: ['==', ['get', 'stop_type'], 'station'], type: 'symbol',
            layout: { 'text-field': ['get', 'name'], 'text-size': 12, 'text-anchor': 'bottom', 'text-offset': [0, -1] },
            paint: { 'text-halo-color': '#fff', 'text-halo-width': 2 }
          });

          // Store avatar markers
          const avatarMarkers = new Map();

          map.on('click', 'stations', (e) => {
            const f = e.features[0];
            const props = f.properties;
            const name = props.name;
            const coordinates = e.lngLat;

            // Create click ripple animation
            createMapClickRipple(e.point);

            // Add station selection animation
            const stationElement = e.originalEvent.target;
            if (stationElement) {
              stationElement.classList.add('station-selected');
              setTimeout(() => {
                stationElement.classList.remove('station-selected');
              }, 800);
            }

            // Get all dropdowns
            const allSelects = document.querySelectorAll('#meetupLocations .meetup-station');

            // Check if this station is already selected
            let selectedIndex = -1;
            for (let i = 0; i < allSelects.length; i++) {
              if (allSelects[i].value === name) {
                selectedIndex = i;
                break;
              }
            }

            if (selectedIndex !== -1) {
              // Station already selected - remove it
              allSelects[selectedIndex].value = '';
              removeAvatarMarker(name);
              showToast(`Removed ${name} from person ${selectedIndex + 1}`, false);
            } else {
              // Station not selected - add it
              let emptySelect = null;

              // Look for first empty dropdown
              for (let select of allSelects) {
                if (!select.value || select.value === '') {
                  emptySelect = select;
                  break;
                }
              }

              if (emptySelect) {
                // Fill the empty slot
                emptySelect.value = name;
                const personNumber = Array.from(allSelects).indexOf(emptySelect) + 1;
                addAvatarMarker(name, coordinates, personNumber);
                showToast(`Selected ${name} for person ${personNumber}`, false);
              } else {
                // No empty slots, add a new person only if we have less than 10 people
                const currentCount = allSelects.length;
                if (currentCount < 10) {
                  addMeetupLocation();
                  // Wait for DOM update, then fill the new select
                  setTimeout(() => {
                    const newSelects = document.querySelectorAll('#meetupLocations .meetup-station');
                    const newSelect = newSelects[newSelects.length - 1]; // Get the last one
                    if (newSelect) {
                      newSelect.value = name;
                      const personNumber = newSelects.length;
                      addAvatarMarker(name, coordinates, personNumber);
                      showToast(`Added ${name} as person ${personNumber}`, false);
                    }
                  }, 50); // Increased timeout for DOM update
                } else {
                  showToast('Maximum 10 people allowed', true);
                }
              }
            }
          });

          function createMapClickRipple(point) {
            const mapContainer = document.getElementById('meetupMap');
            const ripple = document.createElement('div');
            ripple.className = 'map-click-ripple';
            ripple.style.left = point.x + 'px';
            ripple.style.top = point.y + 'px';
            ripple.style.width = '20px';
            ripple.style.height = '20px';
            ripple.style.marginLeft = '-10px';
            ripple.style.marginTop = '-10px';

            mapContainer.appendChild(ripple);

            setTimeout(() => {
              ripple.remove();
            }, 600);
          }

          function addAvatarMarker(stationName, coordinates, personNumber) {
            // Remove existing marker if any
            removeAvatarMarker(stationName);

            // Create simple emoji marker
            const avatarEl = document.createElement('div');
            avatarEl.className = 'avatar-marker';
            avatarEl.innerHTML = getCarEmoji(personNumber);
            avatarEl.style.cssText = `
              width: 30px;
              height: 30px;
              display: flex;
              align-items: center;
              justify-content: center;
              cursor: pointer;
              font-size: 20px;
              background: white;
              border-radius: 50%;
              box-shadow: 0 2px 8px rgba(0,0,0,0.2);
              border: 2px solid var(--sg-red);
            `;

            // Add marker to map
            const marker = new mapboxgl.Marker(avatarEl)
              .setLngLat([coordinates.lng, coordinates.lat])
              .addTo(map);

            avatarMarkers.set(stationName, marker);
          }


          function removeAvatarMarker(stationName) {
            const marker = avatarMarkers.get(stationName);
            if (marker) {
              marker.remove();
              avatarMarkers.delete(stationName);
            }
          }

          function getAvatarEmoji(personNumber) {
            const cars = ['', '', '', '', '', '', '', '', '', ''];
            return cars[(personNumber - 1) % cars.length];
          }

          // Driving animation functions
          function showMeetingPointInfo(meetingStation) {
            showToast(` Meeting Point: ${meetingStation}`, false);

            // Center the map on the meeting point
            const stationCoords = getStationCoordinates(meetingStation);
            if (stationCoords) {
              map.flyTo({
                center: [stationCoords.lng, stationCoords.lat],
                zoom: 15,
                duration: 1000
              });
            }
          }

          function getStationCoordinates(stationName) {
            // This would normally query the GeoJSON data
            // For now, return some sample coordinates
            const sampleCoords = {
              'City Hall': { lng: 103.8523, lat: 1.2931 },
              'Raffles Place': { lng: 103.8514, lat: 1.2834 },
              'Marina Bay': { lng: 103.8546, lat: 1.2767 },
              'Orchard': { lng: 103.8320, lat: 1.3048 },
              'Dhoby Ghaut': { lng: 103.8458, lat: 1.2990 },
              'Newton': { lng: 103.8384, lat: 1.3003 },
              'Stevens': { lng: 103.8254, lat: 1.3201 },
              'Napier': { lng: 103.8080, lat: 1.3048 },
              'Orchard Boulevard': { lng: 103.8320, lat: 1.3048 }
            };

            return sampleCoords[stationName] || null;
          }
          map.on('mouseenter', 'stations', () => map.getCanvas().style.cursor = 'pointer');
          map.on('mouseleave', 'stations', () => map.getCanvas().style.cursor = '');
        } catch (error) {
          console.error('Meetup map load error, using fallback:', error);
          const fallback = {
            type: 'FeatureCollection', features: [
              { type: 'Feature', properties: { name: 'City Hall', station_codes: 'NS25-EW13', station_colors: 'red', 'name_zh-Hans': '', name_ta: ' ' }, geometry: { type: 'Point', coordinates: [103.8523, 1.2931] } },
              { type: 'Feature', properties: { name: 'Raffles Place', station_codes: 'NS26-EW14', station_colors: 'green', 'name_zh-Hans': '', name_ta: ' ' }, geometry: { type: 'Point', coordinates: [103.8514, 1.2834] } },
              { type: 'Feature', properties: { name: 'Marina Bay', station_codes: 'NS27-CC4-TE2', station_colors: 'orange', 'name_zh-Hans': '', name_ta: ' ' }, geometry: { type: 'Point', coordinates: [103.8546, 1.2767] } }
            ]
          };
          map.addSource('mrt-stations', { type: 'geojson', data: fallback });
          map.addLayer({
            id: 'stations', source: 'mrt-stations', type: 'circle',
            paint: { 'circle-radius': 8, 'circle-color': '#d42e12', 'circle-stroke-color': '#fff', 'circle-stroke-width': 2 }
          });
        }
      });
    }

    // ====== TRAIN ARRIVAL SIMULATION ======
    const TRAIN_STATION_LINES = {
      'Bishan': ['North-South Line', 'Circle Line'],
      'Dhoby Ghaut': ['North-South Line', 'North-East Line', 'Circle Line'],
      'Jurong East': ['North-South Line', 'East-West Line', 'Jurong Region Line'],
      'Woodlands': ['North-South Line', 'Thomson-East Coast Line'],
      'Paya Lebar': ['East-West Line', 'Circle Line'],
      'HarbourFront': ['North-East Line', 'Circle Line']
    };
    const LINE_COLOR_MAP = {
      'North-South Line': '#d42e12',
      'East-West Line': '#009645',
      'Circle Line': '#fa9e0d',
      'Downtown Line': '#005ec4',
      'North-East Line': '#9900aa',
      'Thomson-East Coast Line': '#9D5B25',
      'Jurong Region Line': '#00a0a8',
      'LRT Line': '#748477'
    };
    const LIVE_TICKER_STATIONS = [
      { station: 'Marina Bay', line: 'North-South Line' },
      { station: 'Paya Lebar', line: 'Circle Line' },
      { station: 'Woodlands', line: 'Thomson-East Coast Line' },
      { station: 'Dhoby Ghaut', line: 'North-East Line' },
      { station: 'Jurong East', line: 'East-West Line' }
    ];
    const LIVE_TICKER_ROTATION_MS = 5000;
    function getLineColor(lineName) {
      return LINE_COLOR_MAP[lineName] || '#6b7280';
    }
    function getLineMaxSeconds(simulator, lineName) {
      const defaultIntervals = DEFAULT_LINE_INTERVALS.default;
      const lineIntervals = simulator?.config?.lineIntervals?.[lineName] || simulator?.config?.lineIntervals?.default || defaultIntervals;
      const candidates = [];
      Object.values(lineIntervals || {}).forEach(range => {
        if (Array.isArray(range)) {
          range.forEach((value) => {
            if (Number.isFinite(value)) candidates.push(value);
          });
        }
      });
      if (candidates.length === 0) {
        Object.values(defaultIntervals).forEach(range => {
          if (Array.isArray(range)) {
            range.forEach((value) => {
              if (Number.isFinite(value)) candidates.push(value);
            });
          }
        });
      }
      return candidates.length ? Math.max(...candidates) : 360;
    }

    const DEFAULT_LINE_INTERVALS = {
      default: {
        peak: [60, 180],       // 1-3 minutes during crowded periods
        shoulder: [120, 240],  // 2-4 minutes during shoulder periods
        offPeak: [180, 360]    // 3-6 minutes during quieter hours
      }
    };

    const TRAIN_TIMINGS = {
      'Downtown Line': {
        'Towards Expo': [
          { code: 'DT1', station: 'Bukit Panjang', first: '5:30 AM', last: '11:35 PM' },
          { code: 'DT7', station: 'Sixth Avenue', first: '5:38 AM', last: '11:42 PM' },
          { code: 'DT14', station: 'Bugis', first: '5:44 AM', last: '11:55 PM' },
          { code: 'DT21', station: 'Bencoolen', first: '5:47 AM', last: '12:02 AM' },
          { code: 'DT35', station: 'Expo', first: '5:50 AM', last: '12:15 AM' }
        ],
        'Towards Bukit Panjang': [
          { code: 'DT35', station: 'Expo', first: '5:32 AM', last: '11:40 PM' },
          { code: 'DT29', station: 'Bedok North', first: '5:41 AM', last: '11:52 PM' },
          { code: 'DT20', station: 'Fort Canning', first: '5:49 AM', last: '12:08 AM' },
          { code: 'DT9', station: 'Newton', first: '5:55 AM', last: '12:18 AM' },
          { code: 'DT1', station: 'Bukit Panjang', first: '6:03 AM', last: '12:33 AM' }
        ]
      },
      'North East Line': {
        'Towards HarbourFront': [
          { code: 'NE17', station: 'Punggol', first: '5:36 AM', last: '11:47 PM' },
          { code: 'NE12', station: 'Serangoon', first: '5:42 AM', last: '11:59 PM' },
          { code: 'NE7', station: 'Little India', first: '5:47 AM', last: '12:08 AM' },
          { code: 'NE3', station: 'Outram Park', first: '5:53 AM', last: '12:20 AM' },
          { code: 'NE1', station: 'HarbourFront', first: '5:56 AM', last: '12:24 AM' }
        ],
        'Towards Punggol Coast': [
          { code: 'NE1', station: 'HarbourFront', first: '5:34 AM', last: '11:45 PM' },
          { code: 'NE4', station: 'Chinatown', first: '5:38 AM', last: '11:53 PM' },
          { code: 'NE10', station: 'Potong Pasir', first: '5:46 AM', last: '12:05 AM' },
          { code: 'NE14', station: 'Hougang', first: '5:51 AM', last: '12:15 AM' },
          { code: 'NE18', station: 'Punggol Coast (future)', first: '', last: '' }
        ]
      },
      'North-South Line': {},
      'East-West Line': {},
      'Thomson-East Coast Line': {},
      'Circle Line': {},
      'LRT Line': {}
    };

    const ARRIVAL_STORAGE_KEY = 'singatrain-arrivals-v2';
    const ARRIVAL_STORAGE_MAX_AGE = 1000 * 60 * 45; // 45 minutes

    function createTrainArrivalSimulator(customConfig = {}) {
      const baseConfig = {
        stationLines: TRAIN_STATION_LINES,
        lineIntervals: DEFAULT_LINE_INTERVALS,
        updateIntervalMs: 30000,
        trainsPerLine: 3,
        delay: {
          enabled: true,
          probability: 0.2,          // 20% chance once the cycle check is reached
          checkEvery: 4,             // inspect for delays roughly every 2 minutes
          durationRangeSeconds: [180, 300] // add 3-5 minutes when a delay is triggered
        }
      };
      const config = {
        ...baseConfig,
        ...customConfig,
        delay: { ...baseConfig.delay, ...(customConfig.delay || {}) }
      };

      const state = {
        cycles: 0,
        arrivals: {},
        delayFlags: {}
      };

      function randomInt(min, max) {
        return Math.floor(Math.random() * (max - min + 1)) + min;
      }

      function getStorage() {
        try {
          return window.localStorage;
        } catch {
          return null;
        }
      }

      function pruneDelayFlags(now = Date.now()) {
        Object.entries(state.delayFlags).forEach(([station, lines]) => {
          Object.entries(lines).forEach(([line, expiry]) => {
            if (!expiry || expiry < now) {
              delete state.delayFlags[station][line];
            }
          });
          if (Object.keys(state.delayFlags[station]).length === 0) {
            delete state.delayFlags[station];
          }
        });
      }

      function persistState() {
        const storage = getStorage();
        if (!storage) return;
        const payload = {
          timestamp: Date.now(),
          arrivals: state.arrivals,
          delayFlags: state.delayFlags
        };
        try {
          storage.setItem(ARRIVAL_STORAGE_KEY, JSON.stringify(payload));
        } catch {
          // ignore storage errors
        }
      }

      function loadPersistedState() {
        const storage = getStorage();
        if (!storage) return false;
        try {
          const raw = storage.getItem(ARRIVAL_STORAGE_KEY);
          if (!raw) return false;
          const payload = JSON.parse(raw);
          if (!payload || !payload.timestamp || !payload.arrivals) return false;
          const age = Date.now() - payload.timestamp;
          if (age < 0 || age > ARRIVAL_STORAGE_MAX_AGE) {
            storage.removeItem(ARRIVAL_STORAGE_KEY);
            return false;
          }
          const elapsedSeconds = Math.floor(age / 1000);
          state.arrivals = payload.arrivals;
          state.delayFlags = payload.delayFlags || {};
          Object.entries(state.arrivals).forEach(([station, lineMap]) => {
            Object.entries(lineMap).forEach(([lineName, queue]) => {
              for (let i = 0; i < queue.length; i += 1) {
                queue[i] = Math.max(0, queue[i] - elapsedSeconds);
              }
              while (queue.length && queue[0] <= 0) {
                queue.shift();
              }
            });
          });
          pruneDelayFlags(payload.timestamp);
          return true;
        } catch {
          return false;
        }
      }

      function resolveLineInterval(lineName, servicePeriod) {
        const lineConfig = config.lineIntervals[lineName] || config.lineIntervals.default;
        const range = lineConfig[servicePeriod] || lineConfig.offPeak;
        return Array.isArray(range) ? range : config.lineIntervals.default.offPeak;
      }

      function getServicePeriod(currentDate = new Date()) {
        const hour = currentDate.getHours();
        if ((hour >= 7 && hour < 9) || (hour >= 17 && hour < 20)) {
          return 'peak';
        }
        if ((hour >= 6 && hour < 7) || (hour >= 9 && hour < 11) || (hour >= 16 && hour < 17) || (hour >= 20 && hour < 22)) {
          return 'shoulder';
        }
        return 'offPeak';
      }

      function generateNextArrival(lineName, previousTailSeconds) {
        const period = getServicePeriod();
        const [minGap, maxGap] = resolveLineInterval(lineName, period);
        const gapSeconds = randomInt(minGap, maxGap);
        return previousTailSeconds + gapSeconds;
      }

      function seedLine(lineName) {
        const queue = [];
        let tail = 0;
        for (let i = 0; i < config.trainsPerLine; i += 1) {
          tail = generateNextArrival(lineName, tail);
          queue.push(tail);
        }
        return queue;
      }

      function initialiseState() {
        Object.entries(config.stationLines).forEach(([station, lines]) => {
          if (!state.arrivals[station]) state.arrivals[station] = {};
          lines.forEach((lineName) => {
            if (!Array.isArray(state.arrivals[station][lineName]) || state.arrivals[station][lineName].length === 0) {
              state.arrivals[station][lineName] = seedLine(lineName);
            } else {
              while (state.arrivals[station][lineName].length < config.trainsPerLine) {
                const tail = state.arrivals[station][lineName][state.arrivals[station][lineName].length - 1] || 0;
                state.arrivals[station][lineName].push(generateNextArrival(lineName, tail));
              }
            }
          });
        });
        pruneDelayFlags();
        persistState();
      }

      function applyDelayIfNeeded() {
        if (!config.delay.enabled) return;
        if (state.cycles % config.delay.checkEvery !== 0) return;
        if (Math.random() > config.delay.probability) return;

        const stations = Object.keys(state.arrivals);
        if (!stations.length) return;
        const station = stations[randomInt(0, stations.length - 1)];
        const lines = Object.keys(state.arrivals[station]);
        if (!lines.length) return;
        const line = lines[randomInt(0, lines.length - 1)];
        const queue = state.arrivals[station][line];
        if (!queue.length) return;

        const [minDelay, maxDelay] = config.delay.durationRangeSeconds;
        const extraSeconds = randomInt(minDelay, maxDelay);
        for (let i = 0; i < queue.length; i += 1) {
          queue[i] += extraSeconds;
        }
        if (!state.delayFlags[station]) state.delayFlags[station] = {};
        state.delayFlags[station][line] = Date.now() + (extraSeconds * 1000);
      }

      function tick() {
        state.cycles += 1;
        const deltaSeconds = config.updateIntervalMs / 1000;
        pruneDelayFlags();

        Object.values(state.arrivals).forEach((lineMap) => {
          Object.entries(lineMap).forEach(([lineName, queue]) => {
            for (let i = 0; i < queue.length; i += 1) {
              queue[i] = Math.max(0, queue[i] - deltaSeconds);
            }
            while (queue.length && queue[0] <= 0) {
              queue.shift();
            }
            while (queue.length < config.trainsPerLine) {
              const tail = queue.length ? queue[queue.length - 1] : 0;
              queue.push(generateNextArrival(lineName, tail));
            }
          });
        });

        applyDelayIfNeeded();
        persistState();
      }

      function getArrivals(options = {}) {
        const { returnSeconds = false } = options;
        const response = {};
        Object.entries(state.arrivals).forEach(([station, lineMap]) => {
          response[station] = {};
          Object.entries(lineMap).forEach(([lineName, queue]) => {
            response[station][lineName] = queue.map((seconds) => {
              if (returnSeconds) {
                return Math.max(0, Math.round(seconds));
              }
              return Math.max(0, Math.ceil(seconds / 60));
            });
          });
        });
        return response;
      }

      const loaded = loadPersistedState();
      initialiseState();

      const intervalId = setInterval(tick, config.updateIntervalMs);

      return {
        getArrivals,
        getDelayFlags: () => JSON.parse(JSON.stringify(state.delayFlags)),
        updateNow: tick,
        stop: () => clearInterval(intervalId),
        config
      };
    }

    const trainArrivalSimulator = createTrainArrivalSimulator();
    window.trainArrivalSimulator = trainArrivalSimulator;
    window.getSimulatedArrivals = () => trainArrivalSimulator.getArrivals();

    function initMap() {
      mapboxgl.accessToken = 'pk.eyJ1IjoiY2hlZWF1biIsImEiOiJja2NydG83cWMwaGJsMnBqdjR5aHc3MzdlIn0.YGTZpi7JQMquEOv9E8K_bg';
      const map = new mapboxgl.Map({
        container: 'singaporeMap',
        style: 'mapbox://styles/mapbox/streets-v11',
        center: [103.8475, 1.3011], zoom: 11, renderWorldCopies: false
      });
      map.addControl(new mapboxgl.NavigationControl());

      map.on('load', async () => {
        try {
          const response = await fetch('./rail-map-standalone/sg-rail.geo.66ea655e.json');
          if (!response.ok) throw new Error(`HTTP ${response.status}`);
          const data = await response.json();

          map.addSource('mrt-stations', { type: 'geojson', data });
          map.addLayer({
            id: 'mrt-lines', source: 'mrt-stations', filter: ['==', ['geometry-type'], 'LineString'], type: 'line',
            paint: {
              'line-width': ['interpolate', ['linear'], ['zoom'], 10, 2, 16, 6],
              'line-color': [
                'match', ['get', 'line_color'],
                'orangered', '#d42e12', 'mediumseagreen', '#009645', 'orange', '#fa9e0d', 'saddlebrown', '#9D5B25',
                'darkmagenta', '#9900aa', 'darkslateblue', '#005ec4', 'gray', '#748477', '#748477'
              ], 'line-opacity': 0.8
            }, layout: { 'line-cap': 'round', 'line-join': 'round' }
          });
          map.addLayer({
            id: 'stations', source: 'mrt-stations', filter: ['==', ['get', 'stop_type'], 'station'], type: 'circle',
            paint: {
              'circle-radius': 6,
              'circle-color': [
                'match', ['get', 'station_colors'],
                'red', '#d42e12', 'green', '#009645', 'orange', '#fa9e0d', 'brown', '#9D5B25', 'purple', '#9900aa', 'blue', '#005ec4', '#748477'
              ],
              'circle-stroke-color': '#fff', 'circle-stroke-width': 2
            }
          });
          map.addLayer({
            id: 'station-labels', source: 'mrt-stations', filter: ['==', ['get', 'stop_type'], 'station'], type: 'symbol',
            layout: { 'text-field': ['get', 'name'], 'text-size': 12, 'text-anchor': 'bottom', 'text-offset': [0, -1] },
            paint: { 'text-halo-color': '#fff', 'text-halo-width': 2 }
          });

          map.on('click', 'stations', (e) => {
            document.querySelectorAll('.mapboxgl-popup').forEach(p => p.remove());
            const f = e.features[0];
            const props = f.properties;
            const name = props.name;
            const codes = props.station_codes;
            const colors = props.station_colors;
            const nameZh = props['name_zh-Hans'] || '';
            const nameTa = props.name_ta || '';
            const lineName = {
              'red': 'North-South Line (NSL)', 'green': 'East-West Line (EWL)', 'orange': 'Circle Line (CCL)', 'brown': 'Downtown Line (DTL)', 'purple': 'North East Line (NEL)', 'blue': 'Thomson-East Coast Line (TEL)', 'gray': 'LRT Line'
            }[colors] || 'Unknown Line';
            const dot = (c) => (c === 'red' ? '#d42e12' : c === 'green' ? '#009645' : c === 'orange' ? '#fa9e0d' : c === 'brown' ? '#9D5B25' : c === 'purple' ? '#9900aa' : c === 'blue' ? '#005ec4' : '#748477');

            new mapboxgl.Popup({ maxWidth: '300px', closeButton: true, closeOnClick: false })
              .setLngLat(e.lngLat)
              .setHTML(`
                <div style="padding:12px">
                  <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
                    <span style="width:14px;height:14px;border-radius:50%;background:${dot(colors)};display:inline-block"></span>
                    <strong>${name}</strong>
                  </div>
                  <div class="mb-1"><span class="text-secondary">Code:</span> <span class="fw-semibold text-danger">${codes}</span></div>
                  <div class="mb-1"><span class="text-secondary">Line:</span> ${lineName}</div>
                  ${nameZh ? `<div class="mb-1"><span class="text-secondary">:</span> ${nameZh}</div>` : ''}
                  ${nameTa ? `<div class="mb-1"><span class="text-secondary">:</span> ${nameTa}</div>` : ''}
                  <button class="btn btn-primary btn-sm w-100 mt-2" onclick="alert('Live arrivals & crowd levels shown here in a full build')">View Live Info</button>
                </div>`)
              .addTo(map);
          });
          map.on('mouseenter', 'stations', () => map.getCanvas().style.cursor = 'pointer');
          map.on('mouseleave', 'stations', () => map.getCanvas().style.cursor = '');
        } catch (error) {
          console.error('Map load error, using fallback:', error);
          const fallback = {
            type: 'FeatureCollection', features: [
              { type: 'Feature', properties: { name: 'City Hall', station_codes: 'NS25-EW13', station_colors: 'red', 'name_zh-Hans': '', name_ta: ' ' }, geometry: { type: 'Point', coordinates: [103.8523, 1.2931] } },
              { type: 'Feature', properties: { name: 'Raffles Place', station_codes: 'NS26-EW14', station_colors: 'green', 'name_zh-Hans': '', name_ta: ' ' }, geometry: { type: 'Point', coordinates: [103.8514, 1.2834] } },
              { type: 'Feature', properties: { name: 'Marina Bay', station_codes: 'NS27-CC4-TE2', station_colors: 'orange', 'name_zh-Hans': '', name_ta: ' ' }, geometry: { type: 'Point', coordinates: [103.8546, 1.2767] } }
            ]
          };
          map.addSource('mrt-stations', { type: 'geojson', data: fallback });
          map.addLayer({
            id: 'stations', source: 'mrt-stations', type: 'circle',
            paint: { 'circle-radius': 8, 'circle-color': '#d42e12', 'circle-stroke-color': '#fff', 'circle-stroke-width': 2 }
          });
        }
      });
    }

    // ====== ON LOAD ======
    window.addEventListener('DOMContentLoaded', () => {
      // Initialize AOS (Animate On Scroll)
      AOS.init({
        duration: 800,
        easing: 'ease-out-cubic',
        once: true,
        offset: 100
      });

      initializeThemeToggle();
      startLiveClock();
      initializeDropdowns();
      initMap();
      renderLiveArrivals();
      renderLiveTickerCard(false);
      populateTimingFilters();
      handleTimingFilterChange();
      registerGsapAnimations();
      document.getElementById('liveTrainLine')?.addEventListener('change', renderLiveArrivals);
      document.getElementById('saveProfileBtn')?.addEventListener('click', saveProfile);
      document.getElementById('addFavoriteBtn')?.addEventListener('click', addFavorite);


      // make Dashboard default
      setActiveTab('dashboard');
    });
    // Select all flip cards
    const flipCards = document.querySelectorAll('.flip-card-inner');

    flipCards.forEach(card => {
      const hoverHint = card.querySelector('.hover-hint');

      // update hint text based on screen width
      function updateHintText() {
        if (window.innerWidth <= 992) {
          // Mobile and tablet - tap to flip
          if (hoverHint) hoverHint.textContent = 'Tap to see profile details';
          card.classList.remove('is-flipped');
        } else {
          // Desktop - hover to flip
          if (hoverHint) hoverHint.textContent = 'Hover to see profile details';
          card.classList.remove('is-flipped');
        }
      }

      // initial setup
      updateHintText();

      // update on resize
      window.addEventListener('resize', updateHintText);

      // tap flip for mobile and tablet
      card.addEventListener('click', (e) => {
        if (window.innerWidth <= 992) {
          card.classList.toggle('is-flipped');
        }
      });
    });
  </script>
  <!-- 1. Import the core Firebase App module (ensure version consistency) -->
  <script type="module" src="https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js"></script>

  <!-- 2. Import the Firebase Authentication module (ensure version consistency) -->
  <script type="module" src="https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js"></script>

  <!-- Add other Firebase products here as needed, maintaining version consistency -->
  <script type="module" src="https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js"></script>

  <!-- Your app's initialization script -->
  <script type="module">
    // Your Firebase project configuration (from Step 1)
    const firebaseConfig = {
      apiKey: "AIzaSyBTy0tRrYfIvPYhZ-k49IsU_IS9WuTVxKA",
      authDomain: "singatrain.firebaseapp.com",
      projectId: "singatrain",
      storageBucket: "singatrain.firebasestorage.app",
      messagingSenderId: "773752736023",
      appId: "1:773752736023:web:456315abd28b9854058f52",
      measurementId: "G-ZQHSRHNBCB"
    };

    // Import the necessary functions from the loaded modules
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js';
    import {
      getAuth,
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword,
      onAuthStateChanged,
      signOut,
      sendPasswordResetEmail
    } from 'https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js';
    import {
      getFirestore,
      doc,
      setDoc,
      getDoc
    } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

    // --- 3. Initialize Firebase App and Auth ---
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app); // This is your main Auth object
    const db = getFirestore(app);

    // ====== PROFILE / FAVORITES ======

    // Save profile name to Firestore
    window.saveProfile = async function () {
      const name = document.getElementById('profileName').value.trim();
      if (!name) { showToast('Name cannot be empty.'); return; }

      userData.name = name;
      document.getElementById('userName').textContent = name;
      document.getElementById('user-display-name').textContent = name;

      if (userData.uid) {
        await setDoc(doc(db, 'users', userData.uid), { name: name }, { merge: true });
        showToast('Profile saved.', false);
      }
    };

    // Display favorites in dashboard
    window.displayFavorites = function () {
      const listContainer = document.getElementById('favoriteList'); // <ul> inside profile dashboard-section
      const gridContainer = document.getElementById('dashboardFavorites'); // cards on main dashboard

      // Handle profile dashboard list
      if (listContainer) {
        listContainer.innerHTML = '';
        if (!userData.favorites || userData.favorites.length === 0) {
          listContainer.innerHTML = '<li style="color:#6b7280;">No favorite stations yet.</li>';
        } else {
          const favoriteCountEl = document.getElementById('favorite-count');
          if (favoriteCountEl) favoriteCountEl.textContent = userData.favorites?.length || 0;
          userData.favorites.forEach((f, i) => {
            const li = document.createElement('li');
            li.style.marginBottom = '5px';
            // Include label and station
            li.innerHTML = `<strong>${f.label}:</strong> ${f.station} `;
            const btn = document.createElement('button');
            btn.textContent = 'Remove';
            btn.classList.add('btn', 'btn-sm', 'btn-outline-danger');
            btn.addEventListener('click', () => removeFavorite(i));
            li.appendChild(btn);
            listContainer.appendChild(li);
          });
        }
      }

      // Handle main dashboard grid
      if (gridContainer) {
        gridContainer.innerHTML = '';
        if (!userData.favorites || userData.favorites.length === 0) {
          gridContainer.innerHTML = '<p style="color:#6b7280;">No favorite stations yet.</p>';
        } else {
          userData.favorites.forEach((f) => {
            const card = document.createElement('div');
            card.className = 'col-md-4';
            card.innerHTML = `
          <div class="p-3 rounded shadow-sm" style="background:#fff;border:1px solid #ddd;">
            <h6 style="margin-bottom:4px;">${f.label}</h6>
            <p style="margin:0;color:#555;">${f.station}</p>
          </div>`;
            gridContainer.appendChild(card);
          });
        }
      }
    };

    // --- Toggle favorite function ---
    window.toggleFavorite = async function (station) {
      const requiresSync = !!userData?.uid;

      if (!Array.isArray(userData.favorites)) userData.favorites = [];

      const existingIndex = userData.favorites.findIndex(f => f.station === station);
      if (existingIndex >= 0) {
        userData.favorites.splice(existingIndex, 1);
        if (!requiresSync) {
          showToast(`Removed ${station} from favorites.`, false);
        }
      } else {
        userData.favorites.push({ label: station, station });
        if (!requiresSync) {
          showToast(`Favorited ${station} (local only).`, false);
        }
      }

      if (requiresSync) {
        try {
          await setDoc(
            doc(db, 'users', userData.uid),
            { favorite_stations: userData.favorites },
            { merge: true }
          );
          showToast('Favorites synced.', false);
        } catch (err) {
          console.error('Failed to save favorites:', err);
          showToast('Error saving favorites. Please try again.');
          return;
        }
      }

      renderLiveArrivals();
      renderLiveTickerCard();
      displayFavorites();
    };

    // Add favorite
    window.addFavorite = async function () {
      const label = document.getElementById('favoriteLabel').value.trim();
      const station = document.getElementById('favoriteStation').value;
      if (!label || !station) { showToast('Please enter label and station.'); return; }
      if (userData.favorites.some(f => f.label === label)) { showToast('Duplicate label.'); return; }

      userData.favorites.push({ label, station });
      displayFavorites(); // Refresh dashboard display
      document.getElementById('favoriteLabel').value = '';
      document.getElementById('favoriteStation').value = '';
      const favoriteCountEl = document.getElementById('favorite-count');
      if (favoriteCountEl) favoriteCountEl.textContent = userData.favorites?.length || 0;

      if (userData.uid) {
        await setDoc(doc(db, 'users', userData.uid), { favorite_stations: userData.favorites }, { merge: true });
        showToast('Favorite added.', false);
      }
    };

    // Remove favorite
    window.removeFavorite = async function (idx) {
      userData.favorites.splice(idx, 1);
      displayFavorites(); // Refresh dashboard display

      if (userData.uid) {
        await setDoc(doc(db, 'users', userData.uid), { favorite_stations: userData.favorites }, { merge: true });
        showToast('Favorite removed.', false);
      }
    };

    // Populate station dropdown
    window.fillStationDropdown = function () {
      const el = document.getElementById('favoriteStation');
      el.innerHTML = '<option value="">-- Select Station --</option>' + ALL_STATIONS.map(s => `<option value="${s}">${s}</option>`).join('');
    };

    // Attach buttons
    document.getElementById('saveProfileBtn')?.addEventListener('click', saveProfile);
    document.getElementById('addFavoriteBtn')?.addEventListener('click', addFavorite);

    // Populate dropdown on page load
    fillStationDropdown();

    // --- 4. Get References to HTML Elements ---
    const authSection = document.getElementById('auth-section');
    const passwordResetSection = document.getElementById('password-reset-section');
    const dashboardSection = document.getElementById('dashboard-section');

    const authEmailInput = document.getElementById('auth-email');
    const authPasswordInput = document.getElementById('auth-password');
    const passwordRequirementsDiv = document.getElementById('password-requirements');
    const reqLength = document.getElementById('req-length');
    const reqUppercase = document.getElementById('req-uppercase');
    const reqLowercase = document.getElementById('req-lowercase');
    const reqNumber = document.getElementById('req-number');
    const reqSpecial = document.getElementById('req-special');

    const registerBtn = document.getElementById('register-btn');
    const loginBtn = document.getElementById('login-btn');
    const logoutBtn = document.getElementById('logout-btn');
    const forgotPasswordLink = document.getElementById('forgot-password-link');
    const backToAuthLink = document.getElementById('back-to-auth-link');

    const resetEmailInput = document.getElementById('reset-email');
    const sendResetEmailBtn = document.getElementById('send-reset-email-btn');

    const userDisplayEmail = document.getElementById('user-display-email');
    const errorMessageDiv = document.getElementById('error-message');
    const successMessageDiv = document.getElementById('success-message');
    const authStatusDiv = document.getElementById('auth-status');

    // --- 5. Helper Functions for UI Messages ---

    function showMessage(type, message) {
      if (type === 'error') {
        errorMessageDiv.textContent = message;
        errorMessageDiv.classList.remove('hidden');
        successMessageDiv.classList.add('hidden');
      } else if (type === 'success') {
        successMessageDiv.textContent = message;
        successMessageDiv.classList.remove('hidden');
        errorMessageDiv.classList.add('hidden');
      }
    }

    function clearMessages() {
      errorMessageDiv.classList.add('hidden');
      successMessageDiv.classList.add('hidden');
    }

    /**
     * Maps Firebase Auth error codes to user-friendly messages.
     * @param {string} code - The Firebase Auth error code.
     * @returns {string} - A user-friendly message.
     */
    function mapAuthError(code) {
      switch (code) {
        case 'auth/email-already-in-use':
          return 'This email address is already in use. Try signing in or resetting your password.';
        case 'auth/invalid-email':
          return 'The email address is not valid.';
        case 'auth/operation-not-allowed':
          return 'Email/password accounts are not enabled. Contact support.';
        case 'auth/weak-password':
          return 'The password is too weak. Please use a stronger password.';
        case 'auth/user-not-found':
          return 'No user found with this email. Please check your email or register.';
        case 'auth/wrong-password':
          return 'Incorrect password. Please try again.';
        case 'auth/invalid-credential': // Generic for failed sign-in due to wrong pass/email with identity platform
        case 'auth/invalid-login-credentials': // New error code for failed sign-in
          return 'Invalid login credentials. Please check your email and password.';
        case 'auth/too-many-requests':
          return 'Too many attempts. Access temporarily blocked. Please try again later.';
        case 'auth/network-request-failed':
          return 'Network error. Please check your internet connection.';
        default:
          return `An unknown error occurred. Code: ${code}`;
      }
    }

    // --- 6. Client-Side Password Validation ---
    function validatePassword(password) {
      let isValid = true;
      const requirements = {
        length: password.length >= 6,
        uppercase: /[A-Z]/.test(password),
        lowercase: /[a-z]/.test(password),
        number: /[0-9]/.test(password),
        special: /[!@#$%^&*]/.test(password)
      };

      reqLength.classList.toggle('met', requirements.length);
      reqLength.classList.toggle('not-met', !requirements.length);
      reqUppercase.classList.toggle('met', requirements.uppercase);
      reqUppercase.classList.toggle('not-met', !requirements.uppercase);
      reqLowercase.classList.toggle('met', requirements.lowercase);
      reqLowercase.classList.toggle('not-met', !requirements.lowercase);
      reqNumber.classList.toggle('met', requirements.number);
      reqNumber.classList.toggle('not-met', !requirements.number);
      reqSpecial.classList.toggle('met', requirements.special);
      reqSpecial.classList.toggle('not-met', !requirements.special);

      for (const key in requirements) {
        if (!requirements[key]) {
          isValid = false;
        }
      }
      return isValid;
    }

    authPasswordInput.addEventListener('input', () => {
      if (!auth.currentUser) { // Only show requirements for non-logged-in users trying to register/login
        passwordRequirementsDiv.classList.remove('hidden');
        validatePassword(authPasswordInput.value);
        if (authPasswordInput.value === '') { // Hide if password field is empty
          passwordRequirementsDiv.classList.add('hidden');
        }
      }
    });

    // --- 7. Event Listeners for Authentication Actions ---

    // Register User
    registerBtn.addEventListener('click', async () => {
      clearMessages();
      const email = authEmailInput.value;
      const password = authPasswordInput.value;

      if (!email || !password) {
        showMessage('error', 'Please enter both email and password.');
        return;
      }

      if (!validatePassword(password)) {
        showMessage('error', 'Password does not meet all requirements.');
        return;
      }

      try {
        await createUserWithEmailAndPassword(auth, email, password);
        showMessage('success', 'Registration successful! You are now logged in.');
        // UI will update via onAuthStateChanged
      } catch (error) {
        showMessage('error', mapAuthError(error.code || 'unknown-error'));
        console.error("Registration Error:", error);
      }
    });

    // Login User
    loginBtn.addEventListener('click', async () => {
      clearMessages();
      const email = authEmailInput.value;
      const password = authPasswordInput.value;

      if (!email || !password) {
        showMessage('error', 'Please enter both email and password.');
        return;
      }

      try {
        await signInWithEmailAndPassword(auth, email, password);
        showMessage('success', 'Sign-in successful! Welcome back.');
        // UI will update via onAuthStateChanged
      } catch (error) {
        showMessage('error', mapAuthError(error.code || 'unknown-error'));
        console.error("Login Error:", error);
      }
    });

    // Logout User
    logoutBtn.addEventListener('click', async () => {
      clearMessages();
      try {
        await signOut(auth);
        showMessage('success', 'You have been signed out.');
        // UI will update via onAuthStateChanged
      } catch (error) {
        showMessage('error', mapAuthError(error.code || 'unknown-error'));
        console.error("Logout Error:", error);
      }
    });

    // Go to Forgot Password section
    forgotPasswordLink.addEventListener('click', (e) => {
      e.preventDefault();
      clearMessages();
      authSection.classList.add('hidden');
      passwordResetSection.classList.remove('hidden');
      resetEmailInput.value = authEmailInput.value; // Pre-fill email if available
    });

    // Back to Auth section
    backToAuthLink.addEventListener('click', (e) => {
      e.preventDefault();
      clearMessages();
      passwordResetSection.classList.add('hidden');
      authSection.classList.remove('hidden');
    });

    // Send Password Reset Email
    sendResetEmailBtn.addEventListener('click', async () => {
      clearMessages();
      const email = resetEmailInput.value;

      if (!email) {
        showMessage('error', 'Please enter your email to reset password.');
        return;
      }

      try {
        await sendPasswordResetEmail(auth, email);
        showMessage('success', `A password reset link has been sent to ${email}. Please check your inbox.`);
        // Optionally, return to login after a delay
        setTimeout(() => {
          passwordResetSection.classList.add('hidden');
          authSection.classList.remove('hidden');
        }, 5000);
      } catch (error) {
        showMessage('error', mapAuthError(error.code || 'unknown-error'));
        console.error("Password Reset Error:", error);
      }
    });

    // --- 8. Monitor Authentication State Changes (Crucial for UI) ---
    onAuthStateChanged(auth, async (user) => {
      clearMessages();

      const authSection = document.getElementById('auth-section');
      const dashboardSection = document.getElementById('dashboard-section');

      if (user) {
        // Update userData with Firebase Auth info
        userData.uid = user.uid;
        userData.email = user.email;

        try {
          // Load user info from Firestore
          const userDocRef = doc(db, 'users', user.uid);
          const docSnap = await getDoc(userDocRef);

          if (docSnap.exists()) {
            const data = docSnap.data();
            userData.name = data.name || 'Anonymous';
            userData.favorites = data.favorite_stations || [];

            // --- Update flip-card fields dynamically ---
            const userDisplayNameEl = document.getElementById('user-display-name');
            const memberSinceEl = document.getElementById('member-since');
            const favoriteCountEl = document.getElementById('favorite-count');

            if (userDisplayNameEl) userDisplayNameEl.textContent = userData.name;

            if (memberSinceEl) {
              const createdAt = data.created_at;
              memberSinceEl.textContent = createdAt?.toDate ? createdAt.toDate().toLocaleDateString() : '--/--/----';
            }

            if (favoriteCountEl) favoriteCountEl.textContent = userData.favorites?.length || 0;
          } else {
            // Initialize Firestore for new user
            const initData = {
              name: 'Anonymous',
              email: user.email,
              created_at: new Date(),
              favorite_stations: []
            };
            await setDoc(userDocRef, initData);
            userData.name = initData.name;
            userData.favorites = initData.favorite_stations;
          }

          // Update UI
          document.getElementById('userName').textContent = userData.name;
          document.getElementById('profileName').value = userData.name;
          document.getElementById('user-display-email').textContent = userData.email;

          displayFavorites();      // Populate favorite stations list
          fillStationDropdown();   // Refill station dropdowns if needed

          // Show dashboard first (make visible)
          authSection?.classList.add('hidden');
          dashboardSection?.classList.remove('hidden');

          // Now load dashboard and await it, guaranteeing the grid is populated after visible
          await loadDashboard();

        } catch (err) {
          console.error('Error fetching user data:', err);
          showMessage('error', 'Failed to load user profile. Please try again.');
        }

      } else {
        // No user logged in  reset to guest
        userData = { uid: null, name: 'Guest User', email: null, favorites: [] };

        dashboardSection?.classList.add('hidden');
        authSection?.classList.remove('hidden');

        // Reset UI fields
        document.getElementById('userName').textContent = 'Guest User';
        document.getElementById('profileName').value = '';
        displayFavorites();
      }
    }
    );

  </script>
</body>

</html>