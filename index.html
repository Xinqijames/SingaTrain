<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Singapore MRT Assistant</title>

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" defer></script>

  <!-- Material Design Icons -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  
  <!-- Premium Typography - Neuralink-inspired fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- Animate.css for smooth animations -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
  
  <!-- AOS (Animate On Scroll) for premium animations -->
  <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
  <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
  
  <!-- Mapbox -->
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.10.0/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.10.0/mapbox-gl.css" rel="stylesheet" />

  <style>
    :root {
  /* Neuralink-inspired color palette - muted and sophisticated */
  --sg-red: #750000;         /* Primary brand red */
  --sg-red-dark: #4d0000;    /* Darker hover red */
  --sg-red-soft: #f8eaea;    /* Light background tint */
  --sg-grey: #6b7280;
  --sg-border: #e5e7eb;
  
  /* Premium Neuralink-inspired variables */
  --primary-gradient: linear-gradient(135deg, #750000 0%, #a00000 100%);
  --card-shadow: 0 2px 40px rgba(0,0,0,0.04);
  --card-shadow-hover: 0 8px 60px rgba(0,0,0,0.08);
  --border-radius: 20px;
  --border-radius-sm: 12px;
  --border-radius-lg: 32px;
  
  /* Neuralink-inspired muted palette */
  --neutral-50: #fafafa;
  --neutral-100: #f5f5f5;
  --neutral-200: #e5e5e5;
  --neutral-300: #d4d4d4;
  --neutral-400: #a3a3a3;
  --neutral-500: #737373;
  --neutral-600: #525252;
  --neutral-700: #404040;
  --neutral-800: #262626;
  --neutral-900: #171717;
  
  /* Premium accent colors */
  --accent-blue: #0ea5e9;
  --accent-green: #10b981;
  --accent-purple: #8b5cf6;
  --accent-orange: #f59e0b;
  
  /* Typography scale */
  --text-xs: 0.75rem;
  --text-sm: 0.875rem;
  --text-base: 1rem;
  --text-lg: 1.125rem;
  --text-xl: 1.25rem;
  --text-2xl: 1.5rem;
  --text-3xl: 1.875rem;
  --text-4xl: 2.25rem;
}
    * { 
      box-sizing: border-box; 
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Inter', system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol";
      background: var(--neutral-50);
      color: var(--neutral-800);
      min-height: 100vh;
      font-weight: 400;
      line-height: 1.7;
      letter-spacing: -0.01em;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    
    /* Premium typography hierarchy */
    h1, h2, h3, h4, h5, h6 {
      font-family: 'Playfair Display', serif;
      font-weight: 500;
      letter-spacing: -0.02em;
      line-height: 1.2;
    }
    
    .section-title {
      font-size: var(--text-3xl);
      font-weight: 600;
      color: var(--neutral-900);
      margin-bottom: 0.5rem;
    }
    header{
      background: #fff;
      border-bottom: 1px solid var(--sg-border);
      position: sticky; top:0; z-index:1000;
    }
    .app-title { color: var(--sg-red); }
    .nav-pills .nav-link {
  border-radius: 999px;
  color: #fff;
  background: var(--sg-red);
}
.nav-pills .nav-link:not(.active) {
  background: #8b0000;
  opacity: 0.85;
}
.nav-pills .nav-link:hover {
  background: var(--sg-red-dark);
}
    .section-card{
      background: #ffffff;
      border: 1px solid var(--neutral-200);
      border-radius: var(--border-radius);
      padding: 48px;
      box-shadow: var(--card-shadow);
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
      backdrop-filter: blur(10px);
    }
    
    .section-card:hover {
      box-shadow: var(--card-shadow-hover);
      transform: translateY(-4px);
      border-color: var(--neutral-300);
    }
    
    .section-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: linear-gradient(90deg, var(--sg-red) 0%, var(--accent-blue) 100%);
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    
    .section-card:hover::before {
      opacity: 1;
    }
    h2.section-title{ color:var(--sg-red); }
    .feature-description{
      background: var(--sg-red-soft); border:1px solid #fecaca; color:#991b1b;
    }
    .btn-primary{ background: var(--sg-red); border-color: var(--sg-red); }
    .btn-primary:hover{ background: var(--sg-red-dark); border-color: var(--sg-red-dark); }
    .btn-success{ background:#059669; border:#059669; }
    .pill{
      display:inline-block; padding:.25rem .6rem; border-radius:999px; font-size:.85rem;
      background:#f3f4f6; border:1px solid #e5e7eb; color:#111827;
    }
    .output-box{
      margin-top: 16px; padding:16px; background:#f9fafb; border-left:4px solid var(--sg-red);
      border-radius:8px; min-height: 100px;
    }
    .alert-card{ border:1px solid var(--sg-border); border-left-width:4px; border-radius:8px; padding:12px; background:#fff; }
    .alert-disrupted{ border-left-color:#ef4444; }
    .alert-normal{ border-left-color:#16a34a; }
    .route-step{ background:#f3f4f6; border-left:4px solid var(--sg-red); border-radius:8px; padding:12px; margin:.5rem 0; }
    .fare-result{
      background: linear-gradient(135deg, var(--sg-red) 0%, var(--sg-red-dark) 100%);
      color:#fff; padding:18px; border-radius:12px; text-align:center; font-size:1.1rem;
    }
    .mapboxgl-popup-content{ border-radius:12px !important; }
    .station-chip{ font-weight:600; color:var(--sg-red); }
    .form-select, .form-control{ 
      border:2px solid #e5e7eb; 
      border-radius: var(--border-radius-sm);
      padding: 12px 16px;
      font-size: 14px;
      transition: all 0.3s ease;
    }
    .form-select:focus, .form-control:focus{ 
      border-color: var(--sg-red); 
      box-shadow: 0 0 0 .2rem rgba(220,38,38,.15);
      transform: translateY(-1px);
    }

    /* Neuralink-inspired Meetup Section */
    .meetup-container {
      background: var(--neutral-50);
      border-radius: var(--border-radius-lg);
      padding: 40px;
      margin-bottom: 40px;
      border: 1px solid var(--neutral-200);
      position: relative;
      overflow: hidden;
    }
    
    .meetup-container::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, rgba(117, 0, 0, 0.02) 0%, rgba(14, 165, 233, 0.02) 100%);
      pointer-events: none;
    }
    
    .person-card {
      background: #ffffff;
      border: 1px solid var(--neutral-200);
      border-radius: var(--border-radius);
      padding: 32px;
      margin-bottom: 24px;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
      backdrop-filter: blur(10px);
    }
    
    .person-card:hover {
      border-color: var(--neutral-300);
      box-shadow: 0 8px 40px rgba(0, 0, 0, 0.06);
      transform: translateY(-3px);
    }
    
    .person-card.active {
      border-color: var(--sg-red);
      background: linear-gradient(135deg, #ffffff 0%, rgba(117, 0, 0, 0.02) 100%);
      box-shadow: 0 8px 40px rgba(117, 0, 0, 0.08);
    }
    
    .person-card.active::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: var(--primary-gradient);
    }
    
    .person-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
    }
    
    .person-avatar {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--sg-red) 0%, var(--accent-blue) 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 20px;
      box-shadow: 0 8px 24px rgba(117, 0, 0, 0.15);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }
    
    .person-avatar::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.2) 0%, rgba(255, 255, 255, 0) 100%);
      pointer-events: none;
    }
    
    .person-info h6 {
      margin: 0;
      color: var(--neutral-900);
      font-weight: 600;
      font-size: var(--text-lg);
      letter-spacing: -0.01em;
    }
    
    .person-info small {
      color: var(--neutral-500);
      font-size: var(--text-sm);
      font-weight: 400;
    }
    
    .station-selector {
      position: relative;
    }
    
    .station-selector .form-select {
      background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23343a40' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m1 6 7 7 7-7'/%3e%3c/svg%3e");
      background-repeat: no-repeat;
      background-position: right 12px center;
      background-size: 16px 12px;
      padding-right: 40px;
    }
    
    .meetup-actions {
      display: flex;
      gap: 12px;
      margin-top: 24px;
      flex-wrap: wrap;
    }
    
    .btn-modern {
      background: linear-gradient(135deg, var(--sg-red) 0%, var(--sg-red-dark) 100%);
      border: none;
      border-radius: var(--border-radius-sm);
      padding: 16px 32px;
      font-weight: 500;
      font-size: var(--text-base);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      display: inline-flex;
      align-items: center;
      gap: 12px;
      text-decoration: none;
      color: white;
      letter-spacing: -0.01em;
      position: relative;
      overflow: hidden;
    }
    
    .btn-modern::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s;
    }
    
    .btn-modern:hover::before {
      left: 100%;
    }
    
    .btn-modern:hover {
      transform: translateY(-3px);
      box-shadow: 0 12px 40px rgba(117, 0, 0, 0.25);
      color: white;
    }
    
    .btn-modern.secondary {
      background: var(--neutral-50);
      color: var(--neutral-700);
      border: 1px solid var(--neutral-300);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
    }
    
    .btn-modern.secondary:hover {
      background: var(--neutral-100);
      border-color: var(--sg-red);
      color: var(--sg-red);
      box-shadow: 0 8px 24px rgba(117, 0, 0, 0.1);
    }
    
    .meetup-results {
      background: #ffffff;
      border: 1px solid var(--neutral-200);
      border-radius: var(--border-radius);
      padding: 40px;
      margin-top: 40px;
      position: relative;
      overflow: hidden;
      box-shadow: 0 8px 40px rgba(0, 0, 0, 0.06);
      backdrop-filter: blur(10px);
    }
    
    .meetup-results::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--sg-red) 0%, var(--accent-green) 100%);
    }
    
    .meeting-point {
      background: linear-gradient(135deg, var(--sg-red) 0%, var(--accent-blue) 100%);
      color: white;
      padding: 32px;
      border-radius: var(--border-radius);
      text-align: center;
      margin-bottom: 32px;
      position: relative;
      overflow: hidden;
      box-shadow: 0 12px 40px rgba(117, 0, 0, 0.2);
    }
    
    .meeting-point::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0) 100%);
      pointer-events: none;
    }
    
    .meeting-point h4 {
      font-size: var(--text-2xl);
      font-weight: 600;
      margin-bottom: 8px;
      letter-spacing: -0.02em;
    }
    
    .meeting-point p {
      opacity: 0.9;
      font-size: var(--text-base);
      margin: 0;
    }
    
    .travel-times {
      display: grid;
      gap: 12px;
      margin-top: 20px;
    }
    
    .travel-time-item {
      background: var(--neutral-50);
      border: 1px solid var(--neutral-200);
      border-radius: var(--border-radius-sm);
      padding: 20px;
      display: flex;
      align-items: center;
      gap: 16px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }
    
    .travel-time-item:hover {
      background: #ffffff;
      border-color: var(--neutral-300);
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.04);
      transform: translateY(-2px);
    }
    
    .time-badge {
      background: linear-gradient(135deg, var(--sg-red) 0%, var(--accent-blue) 100%);
      color: white;
      padding: 8px 16px;
      border-radius: 24px;
      font-size: var(--text-sm);
      font-weight: 600;
      min-width: 80px;
      text-align: center;
      box-shadow: 0 4px 12px rgba(117, 0, 0, 0.15);
      letter-spacing: -0.01em;
    }
    
    .quick-stations {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 16px;
    }
    
    .quick-station-btn {
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 20px;
      padding: 6px 12px;
      font-size: 12px;
      color: #475569;
      text-decoration: none;
      transition: all 0.3s ease;
      cursor: pointer;
    }
    
    .quick-station-btn:hover {
      background: var(--sg-red);
      color: white;
      border-color: var(--sg-red);
      transform: translateY(-1px);
    }
    
    .floating-action {
      position: fixed;
      bottom: 24px;
      right: 24px;
      width: 56px;
      height: 56px;
      background: var(--primary-gradient);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 24px;
      box-shadow: 0 8px 25px rgba(117, 0, 0, 0.3);
      cursor: pointer;
      transition: all 0.3s ease;
      z-index: 1000;
    }
    
    .floating-action:hover {
      transform: scale(1.1);
      box-shadow: 0 12px 35px rgba(117, 0, 0, 0.4);
    }
    
    /* Premium Animations */
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    
    @keyframes slideInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    @keyframes fadeInScale {
      from {
        opacity: 0;
        transform: scale(0.9);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }
    
    /* Map Interaction Animations */
    @keyframes mapClickRipple {
      0% {
        transform: scale(0);
        opacity: 1;
      }
      100% {
        transform: scale(4);
        opacity: 0;
      }
    }
    
    @keyframes stationSelect {
      0% {
        transform: scale(1);
        box-shadow: 0 0 0 0 rgba(117, 0, 0, 0.4);
      }
      50% {
        transform: scale(1.2);
        box-shadow: 0 0 0 20px rgba(117, 0, 0, 0.1);
      }
      100% {
        transform: scale(1);
        box-shadow: 0 0 0 0 rgba(117, 0, 0, 0);
      }
    }
    
    @keyframes loadingPulse {
      0%, 100% {
        opacity: 0.4;
        transform: scale(0.95);
      }
      50% {
        opacity: 1;
        transform: scale(1.05);
      }
    }
    
    @keyframes loadingDots {
      0%, 20% {
        opacity: 0;
        transform: scale(0.8);
      }
      50% {
        opacity: 1;
        transform: scale(1);
      }
      80%, 100% {
        opacity: 0;
        transform: scale(0.8);
      }
    }
    
    @keyframes progressBar {
      0% {
        width: 0%;
        opacity: 0;
      }
      10% {
        opacity: 1;
      }
      90% {
        opacity: 1;
      }
      100% {
        width: 100%;
        opacity: 0;
      }
    }
    
    @keyframes successCheckmark {
      0% {
        transform: scale(0) rotate(0deg);
        opacity: 0;
      }
      50% {
        transform: scale(1.2) rotate(180deg);
        opacity: 1;
      }
      100% {
        transform: scale(1) rotate(360deg);
        opacity: 1;
      }
    }
    
    .animate-slide-in {
      animation: slideInUp 0.5s ease-out;
    }
    
    .animate-fade-in-scale {
      animation: fadeInScale 0.4s ease-out;
    }
    
    /* Map Animation Classes */
    .map-click-ripple {
      position: absolute;
      border-radius: 50%;
      background: rgba(117, 0, 0, 0.3);
      pointer-events: none;
      animation: mapClickRipple 0.6s ease-out;
    }
    
    .station-selected {
      animation: stationSelect 0.8s ease-out;
    }
    
    /* Loading Animation Classes */
    .loading-pulse {
      animation: loadingPulse 1.5s ease-in-out infinite;
    }
    
    .loading-dots {
      display: inline-flex;
      gap: 4px;
    }
    
    .loading-dots span {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--sg-red);
      animation: loadingDots 1.4s ease-in-out infinite;
    }
    
    .loading-dots span:nth-child(2) {
      animation-delay: 0.2s;
    }
    
    .loading-dots span:nth-child(3) {
      animation-delay: 0.4s;
    }
    
    .progress-bar {
      position: relative;
      height: 3px;
      background: var(--neutral-200);
      border-radius: 2px;
      overflow: hidden;
      margin: 20px 0;
    }
    
    .progress-bar::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      background: linear-gradient(90deg, var(--sg-red) 0%, var(--accent-blue) 100%);
      border-radius: 2px;
      animation: progressBar 2s ease-out;
    }
    
    .success-checkmark {
      animation: successCheckmark 0.8s ease-out;
    }
    
    /* Capybara Loader Animation - From Uiverse.io by Novaxlo */
    .capybaraloader {
      width: 14em;
      height: 10em;
      position: relative;
      z-index: 1;
      --color: rgb(117, 0, 0);
      --color2: rgb(77, 0, 0);
      transform: scale(0.75);
    }
    
    .capybara {
      width: 100%;
      height: 7.5em;
      position: relative;
      z-index: 1;
    }
    
    .loader {
      width: 100%;
      height: 2.5em;
      position: relative;
      z-index: 1;
      overflow: hidden;
    }
    
    .capy {
      width: 85%;
      height: 100%;
      background: linear-gradient(var(--color), 90%, var(--color2));
      border-radius: 45%;
      position: relative;
      z-index: 1;
      animation: movebody 1s linear infinite;
    }
    
    .capyhead {
      width: 7.5em;
      height: 7em;
      bottom: 0em;
      right: 0em;
      position: absolute;
      background-color: var(--color);
      z-index: 3;
      border-radius: 3.5em;
      box-shadow: -1em 0em var(--color2);
      animation: movebody 1s linear infinite;
    }
    
    .capyear {
      width: 2em;
      height: 2em;
      background: linear-gradient(-45deg, var(--color), 90%, var(--color2));
      top: 0em;
      left: 0em;
      border-radius: 100%;
      position: absolute;
      overflow: hidden;
      z-index: 3;
    }
    
    .capyear:nth-child(2) {
      left: 5em;
      background: linear-gradient(25deg, var(--color), 90%, var(--color2));
    }
    
    .capyear2 {
      width: 100%;
      height: 1em;
      background-color: var(--color2);
      bottom: 0em;
      left: 0.5em;
      border-radius: 100%;
      position: absolute;
      transform: rotate(-45deg);
    }
    
    .capymouth {
      width: 3.5em;
      height: 2em;
      background-color: var(--color2);
      position: absolute;
      bottom: 0em;
      left: 2.5em;
      border-radius: 50%;
      display: flex;
      justify-content: space-around;
      align-items: center;
      padding: 0.5em;
    }
    
    .capylips {
      width: 0.25em;
      height: 0.75em;
      border-radius: 100%;
      transform: rotate(-45deg);
      background-color: var(--color);
    }
    
    .capylips:nth-child(2) {
      transform: rotate(45deg);
    }
    
    .capyeye {
      width: 2em;
      height: 0.5em;
      background-color: var(--color2);
      position: absolute;
      bottom: 3.5em;
      left: 1.5em;
      border-radius: 5em;
      transform: rotate(45deg);
    }
    
    .capyeye:nth-child(4) {
      transform: rotate(-45deg);
      left: 5.5em;
      width: 1.75em;
    }
    
    .capyleg {
      width: 6em;
      height: 5em;
      bottom: 0em;
      left: 0em;
      position: absolute;
      background: linear-gradient(var(--color), 95%, var(--color2));
      z-index: 2;
      border-radius: 2em;
      animation: movebody 1s linear infinite;
    }
    
    .capyleg2 {
      width: 1.75em;
      height: 3em;
      bottom: 0em;
      left: 3.25em;
      position: absolute;
      background: linear-gradient(var(--color), 80%, var(--color2));
      z-index: 2;
      border-radius: 0.75em;
      box-shadow: inset 0em -0.5em var(--color2);
      animation: moveleg 1s linear infinite;
    }
    
    .capyleg2:nth-child(3) {
      width: 1.25em;
      left: 0.5em;
      height: 2em;
      animation: moveleg2 1s linear infinite 0.075s;
    }
    
    @keyframes moveleg {
      0% {
        transform: rotate(-45deg) translateX(-5%);
      }
      50% {
        transform: rotate(45deg) translateX(5%);
      }
      100% {
        transform: rotate(-45deg) translateX(-5%);
      }
    }
    
    @keyframes moveleg2 {
      0% {
        transform: rotate(45deg);
      }
      50% {
        transform: rotate(-45deg);
      }
      100% {
        transform: rotate(45deg);
      }
    }
    
    @keyframes movebody {
      0% {
        transform: translateX(0%);
      }
      50% {
        transform: translateX(2%);
      }
      100% {
        transform: translateX(0%);
      }
    }
    
    .loaderline {
      width: 50em;
      height: 0.5em;
      border-top: 0.5em dashed var(--color2);
      animation: moveline 10s linear infinite;
    }
    
    @keyframes moveline {
      0% {
        transform: translateX(0%);
        opacity: 0%;
      }
      5% {
        opacity: 100%;
      }
      95% {
        opacity: 100%;
      }
      100% {
        opacity: 0%;
        transform: translateX(-70%);
      }
    }
    
    /* Map overlay for capybara loading */
    .map-loading-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255, 255, 255, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      backdrop-filter: blur(2px);
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }
    
    .map-loading-overlay.show {
      opacity: 1;
      visibility: visible;
    }
    
    .map-loading-content {
      text-align: center;
      color: var(--neutral-800);
    }
    
    .map-loading-content h6 {
      margin-top: 20px;
      font-size: var(--text-lg);
      font-weight: 600;
    }
    
    .map-loading-content p {
      margin-top: 8px;
      font-size: var(--text-sm);
      color: var(--neutral-600);
    }
    
    /* Enhanced hover effects */
    .person-card:hover .person-avatar {
      transform: scale(1.1);
      box-shadow: 0 6px 20px rgba(117, 0, 0, 0.4);
    }
    
    .btn-modern:active {
      transform: translateY(0);
    }
    
    /* Loading states */
    .loading-shimmer {
      background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
    }
    
    @keyframes shimmer {
      0% { background-position: -200% 0; }
      100% { background-position: 200% 0; }
    }
    
    /* Success states */
    .success-glow {
      box-shadow: 0 0 20px rgba(34, 197, 94, 0.3);
      border-color: #22c55e;
    }
    
    /* Error states */
    .error-shake {
      animation: shake 0.5s ease-in-out;
    }
    
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      75% { transform: translateX(5px); }
    }
    
    @media (max-width: 768px) {
      .meetup-container {
        padding: 16px;
      }
      
      .person-card {
        padding: 16px;
      }
      
      .meetup-actions {
        flex-direction: column;
      }
      
      .btn-modern {
        width: 100%;
        justify-content: center;
      }
      
      .floating-action {
        bottom: 16px;
        right: 16px;
      }
      
      .travel-times {
        gap: 8px;
      }
      
      .travel-time-item {
        padding: 12px;
      }
    }
    
    @media (max-width: 576px) {
      .section-card {
        padding: 20px;
      }
      
      .meetup-container {
        padding: 12px;
      }
      
      .person-card {
        padding: 12px;
      }
      
      .quick-stations {
        gap: 6px;
      }
      
      .quick-station-btn {
        font-size: 11px;
        padding: 4px 8px;
      }
    }
  </style>
</head>
<body>
  <!-- HEADER -->
  <header class="py-3">
    <div class="container d-flex flex-wrap align-items-center justify-content-between">
      <div class="d-flex align-items-center gap-2">
  <img src="./singatrainlogo.png" alt="SingaTrain Logo" width="38" height="38" style="border-radius:8px;">
  <h1 class="h4 m-0 app-title">SingaTrain</h1>
</div>
      <div class="d-flex align-items-center gap-2">
        <span class="fw-semibold text-secondary" id="userName">Guest User</span>
        <button class="btn btn-outline-danger btn-sm" onclick="showTab('profile')">Profile</button>
      </div>
      <div class="w-100 mt-3">
        <ul class="nav nav-pills justify-content-center gap-2">
          <li class="nav-item"><button class="nav-link active" data-tab="dashboard">Dashboard</button></li>
          <li class="nav-item"><button class="nav-link" data-tab="live">Live Tracking</button></li>
          <li class="nav-item"><button class="nav-link" data-tab="route">Route Planner</button></li>
          <li class="nav-item"><button class="nav-link" data-tab="meetup">Meet-up</button></li>
          <li class="nav-item"><button class="nav-link" data-tab="alternatives">Alt Routes</button></li>
          <li class="nav-item"><button class="nav-link" data-tab="fare">Fare</button></li>
          <li class="nav-item"><button class="nav-link" data-tab="profile">Profile</button></li>
        </ul>
      </div>
    </div>
  </header>

  <main class="container my-4">

    <!-- DASHBOARD -->
    <section id="dashboard" class="section-card">
      <h2 class="section-title mb-2">üìä My Dashboard</h2>
      <div class="feature-description p-3 rounded mb-3">
        Quick access to your favorite stations, map, and live alerts.
      </div>

      <!-- Map -->
      <div class="mb-3">
        <h5 class="mb-2">üó∫Ô∏è Singapore MRT Network</h5>
        <div id="singaporeMap" style="width:100%;height:400px;border:1px solid var(--sg-border);border-radius:12px;background:#f3f4f6"></div>
      </div>

      <h5 class="mt-3">‚≠ê Favorite Stations</h5>
      <div id="dashboardFavorites" class="row g-3"></div>

      <h5 class="mt-4">üì£ Current Service Alerts</h5>
      <div id="dashboardAlerts" class="mt-2"></div>
    </section>

    <!-- LIVE -->
    <section id="live" class="section-card d-none">
      <h2 class="section-title mb-2">üöÜ Real-Time Train Tracking</h2>
      <div class="feature-description p-3 rounded mb-3">Live service alerts and station crowd levels by line.</div>

      <div class="row g-3">
        <div class="col-sm-6">
          <label class="form-label">Select MRT Line</label>
          <select id="liveTrainLine" class="form-select">
            <option value="NSL">North South Line (NSL)</option>
            <option value="EWL">East West Line (EWL)</option>
            <option value="DTL">Downtown Line (DTL)</option>
            <option value="CCL">Circle Line (CCL)</option>
            <option value="NEL">North East Line (NEL)</option>
            <option value="TEL">Thomson-East Coast Line (TEL)</option>
          </select>
        </div>
        <div class="col-sm-6 d-flex align-items-end">
          <button class="btn btn-primary" onclick="fetchLiveInfo()">Get Live Information</button>
        </div>
      </div>

      <div class="output-box mt-3" id="liveOutput">
        <div class="text-secondary">Select a line and click ‚ÄúGet Live Information‚Äù.</div>
      </div>
    </section>

    <!-- ROUTE -->
    <section id="route" class="section-card d-none">
      <h2 class="section-title mb-2">üó∫Ô∏è Interactive Route Planner</h2>
      <div class="feature-description p-3 rounded mb-3">Shortest path (fewest stops) across lines & interchanges with time estimate.</div>

      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label">Starting Station</label>
          <select id="routeStart" class="form-select"></select>
        </div>
        <div class="col-md-6">
          <label class="form-label">Destination Station</label>
          <select id="routeEnd" class="form-select"></select>
        </div>
      </div>
      <button class="btn btn-primary mt-3" onclick="planRoute()">Plan Route</button>

      <div class="output-box mt-3" id="routeOutput">
        <div class="text-secondary">Enter start & destination to plan your route.</div>
      </div>
    </section>

    <!-- MEETUP -->
    <section id="meetup" class="section-card d-none">
      <div class="d-flex align-items-center gap-3 mb-6">
        <div class="person-avatar" style="width: 64px; height: 64px; font-size: 28px;">
          <span class="material-icons">group</span>
        </div>
        <div>
          <h2 class="section-title mb-2">Meet-up Point Finder</h2>
          <p class="text-muted mb-0" style="font-size: var(--text-lg); color: var(--neutral-600);">Find the perfect meeting spot that's fair for everyone</p>
        </div>
      </div>

      <div class="meetup-container">
        <div class="d-flex align-items-center justify-content-between mb-6">
          <h5 class="mb-0 d-flex align-items-center gap-3" style="font-size: var(--text-xl); color: var(--neutral-900);">
            <span class="material-icons" style="color: var(--sg-red);">group</span>
            Group Members
          </h5>
          <button class="btn-modern secondary" onclick="addMeetupLocation()">
            <span class="material-icons">add</span>
            Add Person
          </button>
        </div>
        
        <div id="meetupLocations"></div>
        
        <div class="quick-stations">
          <span class="text-muted me-3" style="font-size: var(--text-sm); color: var(--neutral-500);">Quick select:</span>
          <span class="quick-station-btn" onclick="quickSelectStation('City Hall')">City Hall</span>
          <span class="quick-station-btn" onclick="quickSelectStation('Orchard')">Orchard</span>
          <span class="quick-station-btn" onclick="quickSelectStation('Raffles Place')">Raffles Place</span>
          <span class="quick-station-btn" onclick="quickSelectStation('Marina Bay')">Marina Bay</span>
          <span class="quick-station-btn" onclick="quickSelectStation('Dhoby Ghaut')">Dhoby Ghaut</span>
        </div>
      </div>

      <div class="meetup-actions">
        <button class="btn-modern" onclick="findMeetupPoint()">
          <span class="material-icons">location_searching</span>
          Find Best Meeting Point
        </button>
        <button class="btn-modern secondary" onclick="clearAllLocations()">
          <span class="material-icons">clear_all</span>
          Clear All
        </button>
      </div>
     
     <!-- Map for Meet-up -->
     <div class="mt-6">
       <div class="d-flex align-items-center gap-3 mb-4">
         <span class="material-icons" style="color: var(--sg-red); font-size: 28px;">map</span>
         <h5 class="mb-0" style="font-size: var(--text-xl); color: var(--neutral-900);">Interactive MRT Network</h5>
       </div>
       <div id="meetupMap" style="width:100%;height:500px;border:1px solid var(--neutral-200);border-radius:var(--border-radius);background:var(--neutral-50);box-shadow: 0 4px 20px rgba(0,0,0,0.04);"></div>
       <div class="mt-3 text-muted" style="font-size: var(--text-sm); color: var(--neutral-500);">
         <span class="material-icons" style="font-size: 18px; vertical-align: middle; margin-right: 8px;">info</span>
         Click on stations to add them to your group members
       </div>
     </div>
     
     <div id="meetupOutput" class="meetup-results d-none">
       <!-- Results will be populated here -->
     </div>
     
     <!-- Floating Action Button -->
     <div class="floating-action d-none" id="floatingAction" onclick="addMeetupLocation()">
       <span class="material-icons">add</span>
     </div>
   </section>

    <!-- ALTERNATIVES -->
    <section id="alternatives" class="section-card d-none">
      <h2 class="section-title mb-2">üîÑ Alternative Routes (Breakdown Mode)</h2>
      <div class="feature-description p-3 rounded mb-3">Auto-detect disruptions from Live Alerts. Offers MRT-only, Bus, or Mixed alternatives.</div>

      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label">Your Current Location</label>
          <select id="altStart" class="form-select"></select>
        </div>
        <div class="col-md-6">
          <label class="form-label">Your Destination</label>
          <select id="altEnd" class="form-select"></select>
        </div>
      </div>
      <div class="row g-3 mt-1">
        <div class="col-md-6">
          <label class="form-label">Affected Line (optional)</label>
          <select id="affectedLine" class="form-select">
            <option value="">Auto-detect from alerts</option>
            <option value="NSL">North South Line (NSL)</option>
            <option value="EWL">East West Line (EWL)</option>
            <option value="DTL">Downtown Line (DTL)</option>
            <option value="CCL">Circle Line (CCL)</option>
            <option value="NEL">North East Line (NEL)</option>
            <option value="TEL">Thomson-East Coast Line (TEL)</option>
          </select>
        </div>
      </div>

      <button class="btn btn-primary mt-3" onclick="findAlternatives()">Find Alternative Routes</button>
      <div class="output-box mt-3" id="altOutput">
        <div class="text-secondary">Enter your journey details.</div>
      </div>
    </section>

    <!-- FARE -->
    <section id="fare" class="section-card d-none">
      <h2 class="section-title mb-2">üí∞ Fare Calculator</h2>
      <div class="feature-description p-3 rounded mb-3">Distance-based adult & concession fares + Monthly Pass breakeven.</div>

      <div class="row g-3">
        <div class="col-md-4">
          <label class="form-label">From</label>
          <select id="fareStart" class="form-select"></select>
        </div>
        <div class="col-md-4">
          <label class="form-label">To</label>
          <select id="fareEnd" class="form-select"></select>
        </div>
        <div class="col-md-4">
          <label class="form-label">Commuter Type</label>
          <select id="commuterType" class="form-select">
            <option value="adult">Adult</option>
            <option value="primary">Primary School Student</option>
            <option value="secondary">Secondary School Student</option>
            <option value="polytechnic">Polytechnic Student</option>
            <option value="university">University Student</option>
            <option value="senior">Senior Citizen</option>
            <option value="disability">Person with Disabilities</option>
            <option value="ns">National Serviceman</option>
            <option value="workfare">Workfare Concession</option>
          </select>
        </div>
      </div>
      <button class="btn btn-primary mt-3" onclick="calculateFare()">Calculate Fare</button>
      <div class="output-box mt-3" id="fareOutput"></div>

      <h5 class="mt-4">Monthly Pass Calculator</h5>
      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label">Daily Round Trips</label>
          <input type="number" id="dailyTrips" class="form-control" value="2" min="1" max="10">
        </div>
        <div class="col-md-6">
          <label class="form-label">Working Days / Month</label>
          <input type="number" id="workingDays" class="form-control" value="22" min="1" max="31">
        </div>
      </div>
      <button class="btn btn-primary mt-3" onclick="calculatePassValue()">Check if Pass is Worth It</button>
      <div class="output-box mt-3" id="passOutput"></div>
    </section>

    <!-- PROFILE -->
    <section id="profile" class="section-card d-none">
      <h2 class="section-title mb-2">üë§ User Profile & Favorites</h2>
      <div class="feature-description p-3 rounded mb-3">Save frequently used stations for quick access on the dashboard.</div>

      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label">Your Name</label>
          <input type="text" id="profileName" class="form-control" placeholder="Enter your name">
        </div>
        <div class="col-md-6 d-flex align-items-end">
          <button class="btn btn-primary" onclick="saveProfile()">Save Profile</button>
        </div>
      </div>

      <h5 class="mt-4">Favorite Stations</h5>
      <div class="row g-2 align-items-end">
        <div class="col-md-4">
          <input type="text" id="favoriteLabel" class="form-control" placeholder="Label (e.g., Home, Work)">
        </div>
        <div class="col-md-6">
          <select id="favoriteStation" class="form-select"></select>
        </div>
        <div class="col-md-2 d-grid">
          <button class="btn btn-success" onclick="addFavorite()">Add</button>
        </div>
      </div>
      <div id="favoritesOutput" class="mt-3"></div>
    </section>

    <!-- Toast (API errors/info) -->
    <div class="position-fixed bottom-0 end-0 p-3" style="z-index:1100">
      <div id="appToast" class="toast align-items-center text-bg-danger border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
          <div class="toast-body" id="toastMsg">An error occurred.</div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
      </div>
    </div>

  </main>
  <script src="config.js"></script>
  <script>
    // ====== API CONFIG ======
    const PROXY = "https://corsproxy.io/?";
    const API_BASE = "https://datamall2.mytransport.sg/ltaodataservice";
     // <- replace with your real key

    // ====== STATIONS DB (simplified; you can expand) ======
    const MRT_STATIONS = {
      NSL: ['Jurong East','Bukit Batok','Bukit Gombak','Choa Chu Kang','Yew Tee','Kranji','Marsiling','Woodlands','Admiralty','Sembawang','Canberra','Yishun','Khatib','Yio Chu Kang','Ang Mo Kio','Bishan','Braddell','Toa Payoh','Novena','Newton','Orchard','Somerset','Dhoby Ghaut','City Hall','Raffles Place','Marina Bay','Marina South Pier'],
      EWL: ['Pasir Ris','Tampines','Simei','Tanah Merah','Bedok','Kembangan','Eunos','Paya Lebar','Aljunied','Kallang','Lavender','Bugis','City Hall','Raffles Place','Tanjong Pagar','Outram Park','Tiong Bahru','Redhill','Queenstown','Commonwealth','Buona Vista','Dover','Clementi','Jurong East','Chinese Garden','Lakeside','Boon Lay','Pioneer','Joo Koon','Gul Circle','Tuas Crescent','Tuas West Road','Tuas Link'],
      DTL: ['Bukit Panjang','Cashew','Hillview','Beauty World','King Albert Park','Sixth Avenue','Tan Kah Kee','Botanic Gardens','Stevens','Newton','Little India','Rochor','Bugis','Promenade','Bayfront','Downtown','Telok Ayer','Chinatown','Fort Canning','Bencoolen','Jalan Besar','Bendemeer','Geylang Bahru','Mattar','MacPherson','Ubi','Kaki Bukit','Bedok North','Bedok Reservoir','Tampines West','Tampines','Tampines East','Upper Changi','Expo'],
      CCL: ['Dhoby Ghaut','Bras Basah','Esplanade','Promenade','Nicoll Highway','Stadium','Mountbatten','Dakota','Paya Lebar','MacPherson','Tai Seng','Bartley','Serangoon','Lorong Chuan','Bishan','Marymount','Caldecott','Botanic Gardens','Farrer Road','Holland Village','Buona Vista','one-north','Kent Ridge','Haw Par Villa','Pasir Panjang','Labrador Park','Telok Blangah','HarbourFront'],
      NEL: ['HarbourFront','Outram Park','Chinatown','Clarke Quay','Dhoby Ghaut','Little India','Farrer Park','Boon Keng','Potong Pasir','Woodleigh','Serangoon','Kovan','Hougang','Buangkok','Sengkang','Punggol'],
      TEL: ['Woodlands North','Woodlands','Woodlands South','Springleaf','Lentor','Mayflower','Bright Hill','Upper Thomson','Caldecott','Mount Pleasant','Stevens','Napier','Orchard Boulevard','Orchard','Great World','Havelock','Outram Park','Maxwell','Shenton Way','Marina Bay','Marina South','Gardens by the Bay']
    };
    const ALL_STATIONS = [...new Set(Object.values(MRT_STATIONS).flat())].sort();

    // ====== USER DATA ======
    let userData = { name:'Guest User', favorites:[] };

    // ====== UI HELPERS ======
    const toastEl = document.getElementById('appToast');
    const toastMsg = document.getElementById('toastMsg');
    function showToast(msg, isError=true){
      toastMsg.textContent = msg;
      toastEl.classList.remove('text-bg-danger','text-bg-primary','text-bg-success');
      toastEl.classList.add(isError ? 'text-bg-danger' : 'text-bg-primary');
      new bootstrap.Toast(toastEl, { delay: 3500 }).show();
    }

    function setActiveTab(tabName){
      document.querySelectorAll('.nav-link').forEach(b=>b.classList.remove('active'));
      document.querySelector(`.nav-link[data-tab="${tabName}"]`)?.classList.add('active');
      document.querySelectorAll('main section').forEach(s=>s.classList.add('d-none'));
      document.getElementById(tabName)?.classList.remove('d-none');
      
      // Show/hide floating action button
      const floatingAction = document.getElementById('floatingAction');
      if (tabName === 'meetup') {
        floatingAction?.classList.remove('d-none');
        initMeetupMap();
        // Add first person if none exist
        const existingPersons = document.querySelectorAll('#meetupLocations .person-card');
        if (existingPersons.length === 0) {
          addMeetupLocation();
        }
      } else {
        floatingAction?.classList.add('d-none');
      }
      
      if(tabName==='dashboard'){ loadDashboard(); }
    }
    document.querySelectorAll('.nav-link').forEach(btn=>{
      btn.addEventListener('click', () => setActiveTab(btn.dataset.tab));
    });
    function showTab(tab){ setActiveTab(tab); }

    // ====== INIT DROPDOWNS ======
    function fillSelect(el){
      el.innerHTML = '<option value="">-- Select Station --</option>' +
        ALL_STATIONS.map(s=>`<option value="${s}">${s}</option>`).join('');
    }
    function initializeDropdowns(){
      ['routeStart','routeEnd','altStart','altEnd','fareStart','fareEnd','favoriteStation'].forEach(id=>{
        const el = document.getElementById(id); if(el) fillSelect(el);
      });
      addMeetupLocation(); // seed first row
    }

    // ====== BUILD GRAPH (for routing) ======
    // Graph maps "Station (LINE)" nodes; interchanges are connected with small penalty.
    const graph = new Map();
    function nodeKey(st, line){ return `${st} (${line})`; }

    function addEdge(a,b, weight=1){
      if(!graph.has(a)) graph.set(a,[]);
      if(!graph.has(b)) graph.set(b,[]);
      graph.get(a).push({to:b, w:weight});
      graph.get(b).push({to:a, w:weight});
    }
    function buildGraph(){
      graph.clear();
      // connect consecutive stations on same line
      Object.entries(MRT_STATIONS).forEach(([line, stations])=>{
        stations.forEach((st, i)=>{
          const A = nodeKey(st,line);
          if(i>0){
            const B = nodeKey(stations[i-1], line);
            addEdge(A,B,1);
          }
          if(i<stations.length-1){
            const C = nodeKey(stations[i+1], line);
            addEdge(A,C,1);
          }
        });
      });
      // connect interchanges (same physical station across lines)
      const stationToLines = new Map();
      Object.entries(MRT_STATIONS).forEach(([line, stations])=>{
        stations.forEach(st=>{
          if(!stationToLines.has(st)) stationToLines.set(st,[]);
          stationToLines.get(st).push(line);
        });
      });
      stationToLines.forEach((lines, st)=>{
        if(lines.length>1){
          // small interchange cost ~0.5 stops so pathfinder can pick smart transfers
          for(let i=0;i<lines.length;i++){
            for(let j=i+1;j<lines.length;j++){
              addEdge(nodeKey(st,lines[i]), nodeKey(st,lines[j]), 0.5);
            }
          }
        }
      });
    }
    buildGraph();

    // ====== SHORTEST PATH (Dijkstra) by stops (weights) ======
    function shortestPath(startStation, endStation){
      // start from any line containing startStation; end at any line containing endStation
      const startNodes = Object.keys(MRT_STATIONS).filter(l=>MRT_STATIONS[l].includes(startStation)).map(l=>nodeKey(startStation,l));
      const endNodes   = Object.keys(MRT_STATIONS).filter(l=>MRT_STATIONS[l].includes(endStation)).map(l=>nodeKey(endStation,l));
      if(startNodes.length===0 || endNodes.length===0) return null;

      const dist = new Map(), prev = new Map(), pq=[];
      function push(n, d){ pq.push([d,n]); pq.sort((a,b)=>a[0]-b[0]); }

      // initialize
      graph.forEach((_, n)=>dist.set(n, Infinity));
      startNodes.forEach(n=>{ dist.set(n,0); push(n,0); });

      let target=null;
      const endSet = new Set(endNodes);

      while(pq.length){
        const [d,u]=pq.shift();
        if(d!==dist.get(u)) continue;
        if(endSet.has(u)){ target=u; break; }
        for(const {to, w} of (graph.get(u)||[])){
          const nd = d + w;
          if(nd < dist.get(to)){
            dist.set(to, nd);
            prev.set(to, u);
            push(to, nd);
          }
        }
      }
      if(!target) return null;

      // reconstruct
      const path = [];
      let cur = target;
      while(cur){ path.unshift(cur); cur = prev.get(cur); }
      // compress to [ {station, line}... ]
      const steps = path.map(k=>{
        const m = k.match(/^(.*) \((.*)\)$/);
        return { station: m?m[1]:k, line: m?m[2]:'?' };
      });
      const totalWeight = dist.get(target); // stops incl. interchange weight

      return { steps, totalWeight };
    }

    // ====== TIME / DISTANCE ESTIMATES ======
    // avg 2.2 min between stops; interchange adds ~4 min walking; distance ~1.1 km per stop
    function estimateTimeMinutes(totalWeight){
      // split weight into stops vs. interchanges (0.5 weights become transfers)
      const stopsApprox = Math.max(0, Math.round(totalWeight)); // approx whole stops
      const transfersApprox = Math.max(0, Math.round((totalWeight - stopsApprox) * 2)); // each 0.5 => 1 transfer
      return Math.round(stopsApprox*2.2 + transfersApprox*4 + 3); // +3 buffer
    }
    function estimateDistanceKm(totalWeight){
      const stops = Math.max(0, Math.round(totalWeight)); // only full edges
      const transfers = Math.round((totalWeight - stops)*2);
      return +(stops*1.1 + transfers*0.3).toFixed(1); // add small transfer walk dist
    }

    // ====== LIVE INFO ======
    async function fetchLiveInfo(){
      const line = document.getElementById('liveTrainLine').value;
      const out = document.getElementById('liveOutput');
      out.innerHTML = '<div class="text-secondary">Fetching live data‚Ä¶</div>';

      try {
        // Alerts
        let alerts = [];
        try{
          const alertUrl = `${PROXY}${encodeURIComponent(API_BASE + "/TrainServiceAlerts")}`;
          const res = await fetch(alertUrl, { headers:{ AccountKey: ACCOUNT_KEY, accept:"application/json" } });
          if(res.ok){
            const data = await res.json();
            alerts = Array.isArray(data.value||data.Value) ? (data.value||data.Value) : (Array.isArray(data)?data:[]);
          }
        }catch(e){ 
          console.log('Service Alerts API unavailable, using demo data');
          alerts = []; // Use empty array instead of showing error
        }
        // Crowd
        let crowds = [];
        try{
          const crowdUrl = `${PROXY}${encodeURIComponent(API_BASE + "/PCDRealTime?TrainLine=" + line)}`;
          const res = await fetch(crowdUrl, { headers:{ AccountKey: ACCOUNT_KEY, accept:"application/json" } });
          if(res.ok){
            const data = await res.json();
            // console.log('Crowd API Response:', data); // Debug log
            crowds = Array.isArray(data.value||data.Value) ? (data.value||data.Value) : (Array.isArray(data)?data:[]);
            // console.log('Extracted crowds:', crowds); // Debug log
          }
        }catch(e){ 
          console.log('Crowd data API error:', e);
          crowds = []; // Use empty array instead of showing error
        }

        // Render
        let html = '<h5>Service Status</h5>';
        const lineAlert = alerts.find(a => (a.Line||a.line||'').toUpperCase().includes(line));
        if(lineAlert){
          html += `<div class="alert-card alert-disrupted mb-2">
            <strong>‚ö†Ô∏è ${lineAlert.Line || line}</strong><br>
            <small>${lineAlert.Message || 'Service disruption reported'}</small>
          </div>`;
        }else{
          html += `<div class="alert-card alert-normal mb-2">
            <strong>‚úÖ ${line}</strong><br><small>All services operating normally</small>
          </div>`;
        }

        html += '<h5 class="mt-3">Station Crowd Levels</h5>';
        if(crowds.length){
          html += crowds.map(s=>{
            const lvlRaw = (s.CrowdLevel||s.crowdLevel||'').toString().toLowerCase();
            const label = lvlRaw==='h' ? 'High' : lvlRaw==='m' ? 'Moderate' : lvlRaw==='l' ? 'Low' : (s.CrowdLevel||'N/A');
            const cls = lvlRaw==='h' ? 'text-danger fw-semibold' : (lvlRaw==='m'?'text-warning fw-semibold':'text-success fw-semibold');
            return `<div class="d-flex justify-content-between border rounded p-2 mb-1">
              <span>${s.Station||s.station||'Unknown'}</span>
              <span class="${cls}">${label}</span>
            </div>`;
          }).join('');
        }else{
          html += '<div class="text-secondary">No crowd data for this line.</div>';
        }
        out.innerHTML = html;
      } catch(err){
        out.innerHTML = `<span class="text-danger">Error: ${err.message}</span>`;
        showToast(err.message);
        console.error(err);
      }
    }
    // ====== ROUTE PLANNER ======
    function planRoute(){
      const start = document.getElementById('routeStart').value;
      const end = document.getElementById('routeEnd').value;
      const out = document.getElementById('routeOutput');
      if(!start || !end){ out.innerHTML = '<span class="text-danger">Please select both stations.</span>'; return; }
      if(start===end){ out.innerHTML = '<span class="text-secondary">You are already at your destination üòä</span>'; return; }

      const path = shortestPath(start, end);
      if(!path){ out.innerHTML = '<span class="text-danger">No route found.</span>'; return; }

      const mins = estimateTimeMinutes(path.totalWeight);
      const dist = estimateDistanceKm(path.totalWeight);

      let html = `<h5>Route from <span class="station-chip">${start}</span> to <span class="station-chip">${end}</span></h5>`;
      html += `<div class="fare-result my-2">Estimated Time: <strong>${mins} mins</strong> ‚Ä¢ Approx Distance: <strong>${dist} km</strong></div>`;

      // Build steps (group consecutive same-line segments)
      const steps = [];
      let i=0;
      while(i<path.steps.length-1){
        const cur = path.steps[i];
        let j=i+1;
        while(j<path.steps.length && path.steps[j].line===cur.line) j++;
        const segEnd = path.steps[j-1];
        if(cur.station!==segEnd.station){
          const stations = getStopsCount(cur, segEnd);
          steps.push({ action:`Take ${cur.line}`, details:`${cur.station} ‚Üí ${segEnd.station} (${stations} stops)` });
        }
        if(j<path.steps.length){
          const transferAt = segEnd.station;
          steps.push({ action:`Transfer`, details:`Change lines at ${transferAt}` });
        }
        i=j;
      }
      steps.push({ action:`Arrive`, details:`${end} ‚Äî journey complete` });

      steps.forEach((s, idx)=>{
        html += `<div class="route-step"><strong>Step ${idx+1}:</strong> ${s.action}<br><small>${s.details}</small></div>`;
      });

      out.innerHTML = html;
    }
    function getStopsCount(a,b){
      // count stations between a and b on line a.line
      const list = MRT_STATIONS[a.line] || [];
      const ia = list.indexOf(a.station), ib = list.indexOf(b.station);
      return Math.abs(ib-ia);
    }

    // ====== MEET-UP ======
    function addMeetupLocation(){
      const container = document.getElementById('meetupLocations');
      const personNumber = container.children.length + 1;
      const personCard = document.createElement('div');
      personCard.className = 'person-card animate__animated animate__fadeInUp';
      personCard.innerHTML = `
        <div class="person-header">
          <div class="person-avatar">${personNumber}</div>
          <div class="person-info">
            <h6>Person ${personNumber}</h6>
            <small>Select their starting station</small>
          </div>
        </div>
        <div class="station-selector">
          <select class="form-select meetup-station" onchange="updatePersonCard(this)">
            <option value="">-- Select Station --</option>
            ${ALL_STATIONS.map(s=>`<option value="${s}">${s}</option>`).join('')}
          </select>
        </div>
        <div class="d-flex justify-content-end mt-3">
          <button class="btn-modern secondary" onclick="removePersonCard(this)" style="padding: 8px 16px; font-size: 12px;">
            <span class="material-icons" style="font-size: 16px;">delete</span>
            Remove
          </button>
        </div>
      `;
      container.appendChild(personCard);
      
      // Add animation
      setTimeout(() => {
        personCard.classList.add('animate__fadeInUp');
      }, 50);
    }
    
    function updatePersonCard(selectElement) {
      const personCard = selectElement.closest('.person-card');
      const station = selectElement.value;
      
      if (station) {
        personCard.classList.add('active');
        const personInfo = personCard.querySelector('.person-info small');
        personInfo.textContent = `Starting from ${station}`;
        
        // Add success animation
        personCard.style.animation = 'none';
        setTimeout(() => {
          personCard.style.animation = 'pulse 0.6s ease-in-out';
        }, 10);
      } else {
        personCard.classList.remove('active');
        const personInfo = personCard.querySelector('.person-info small');
        personInfo.textContent = 'Select their starting station';
      }
    }
    
    function removePersonCard(button) {
      const personCard = button.closest('.person-card');
      personCard.classList.add('animate__fadeOutDown');
      
      setTimeout(() => {
        personCard.remove();
        updatePersonNumbers();
      }, 300);
    }
    
    function updatePersonNumbers() {
      const personCards = document.querySelectorAll('.person-card');
      personCards.forEach((card, index) => {
        const personNumber = index + 1;
        const avatar = card.querySelector('.person-avatar');
        const title = card.querySelector('.person-info h6');
        
        avatar.textContent = personNumber;
        title.textContent = `Person ${personNumber}`;
      });
    }
    
    function quickSelectStation(stationName) {
      const allSelects = document.querySelectorAll('#meetupLocations .meetup-station');
      let emptySelect = null;
      
      // Find first empty dropdown
      for (let select of allSelects) {
        if (!select.value || select.value === '') {
          emptySelect = select;
          break;
        }
      }
      
      if (emptySelect) {
        emptySelect.value = stationName;
        updatePersonCard(emptySelect);
        
        // Add success feedback
        const quickBtn = event.target;
        quickBtn.style.background = 'var(--sg-red)';
        quickBtn.style.color = 'white';
        setTimeout(() => {
          quickBtn.style.background = '';
          quickBtn.style.color = '';
        }, 1000);
      } else {
        // Add new person if no empty slots
        addMeetupLocation();
        setTimeout(() => {
          const newSelects = document.querySelectorAll('#meetupLocations .meetup-station');
          const newSelect = newSelects[newSelects.length - 1];
          if (newSelect) {
            newSelect.value = stationName;
            updatePersonCard(newSelect);
          }
        }, 100);
      }
    }
    
    function clearAllLocations() {
      const personCards = document.querySelectorAll('.person-card');
      personCards.forEach((card, index) => {
        setTimeout(() => {
          card.classList.add('animate__fadeOutDown');
          setTimeout(() => card.remove(), 300);
        }, index * 100);
      });
      
      // Clear results
      const output = document.getElementById('meetupOutput');
      output.classList.add('d-none');
      
      showToast('All locations cleared', false);
    }

    function findMeetupPoint(){
      const stations = Array.from(document.querySelectorAll('.meetup-station')).map(s=>s.value).filter(Boolean);
      const out = document.getElementById('meetupOutput');
      
      if(stations.length<2){ 
        showToast('Please add at least 2 locations to find a meeting point', true);
        return; 
      }

      // Show capybara loading animation over the map
      showMapLoadingAnimation();

      // Simulate processing time for better UX
      setTimeout(() => {

        // brute force: evaluate each candidate as meetup, choose minimal totalWeight sum
        const candidates = ALL_STATIONS;
        let best = { station:null, sum: Infinity, times:[] };

        candidates.forEach(cand=>{
          let total=0, times=[];
          for(const s of stations){
            const p = shortestPath(s, cand);
            if(!p){ total=Infinity; break; }
            total += p.totalWeight;
            times.push(estimateTimeMinutes(p.totalWeight));
          }
          if(total < best.sum){ best = { station:cand, sum:total, times }; }
        });

        if(!best.station){ 
          out.innerHTML = `
            <div class="text-center py-4">
              <span class="material-icons text-danger mb-2" style="font-size: 48px;">error_outline</span>
              <h6 class="text-danger">No Meeting Point Found</h6>
              <p class="text-muted">Unable to find a common reachable station for all locations.</p>
            </div>
          `;
          return; 
        }

        // Calculate average travel time
        const avgTime = Math.round(best.times.reduce((a, b) => a + b, 0) / best.times.length);
        const maxTime = Math.max(...best.times);
        const minTime = Math.min(...best.times);

        let html = `
          <div class="d-flex align-items-center gap-3 mb-6">
            <span class="material-icons text-success success-checkmark" style="font-size: 40px;">check_circle</span>
            <h5 class="mb-0 text-success" style="font-size: var(--text-xl);">Perfect Meeting Point Found!</h5>
          </div>
          
          <div class="meeting-point animate-fade-in-scale">
            <h4 class="mb-2">${best.station}</h4>
            <p class="mb-0 opacity-75">The most convenient location for everyone</p>
          </div>
          
          <div class="row g-4 mb-6">
            <div class="col-md-4">
              <div class="text-center p-4 bg-light rounded" style="border: 1px solid var(--neutral-200);">
                <div class="h3 text-primary mb-2" style="font-family: 'Playfair Display', serif;">${avgTime}</div>
                <small class="text-muted" style="font-size: var(--text-sm);">Avg Travel Time (mins)</small>
              </div>
            </div>
            <div class="col-md-4">
              <div class="text-center p-4 bg-light rounded" style="border: 1px solid var(--neutral-200);">
                <div class="h3 text-success mb-2" style="font-family: 'Playfair Display', serif;">${minTime}</div>
                <small class="text-muted" style="font-size: var(--text-sm);">Shortest Time (mins)</small>
              </div>
            </div>
            <div class="col-md-4">
              <div class="text-center p-4 bg-light rounded" style="border: 1px solid var(--neutral-200);">
                <div class="h3 text-warning mb-2" style="font-family: 'Playfair Display', serif;">${maxTime}</div>
                <small class="text-muted" style="font-size: var(--text-sm);">Longest Time (mins)</small>
              </div>
            </div>
          </div>
          
          <h6 class="mb-4 d-flex align-items-center gap-3" style="font-size: var(--text-lg); color: var(--neutral-900);">
            <span class="material-icons" style="color: var(--sg-red);">schedule</span>
            Individual Travel Times
          </h6>
          
          <div class="travel-times">`;

        stations.forEach((s, i)=>{
          const personCard = document.querySelectorAll('.person-card')[i];
          const personName = personCard ? personCard.querySelector('.person-info h6').textContent : `Person ${i+1}`;
          
          html += `
            <div class="travel-time-item animate-slide-in" style="animation-delay: ${i * 0.1}s;">
              <div class="person-avatar" style="width: 40px; height: 40px; font-size: 16px;">${i+1}</div>
              <div class="flex-grow-1">
                <div class="fw-semibold" style="font-size: var(--text-base); color: var(--neutral-900);">${personName}</div>
                <small class="text-muted" style="font-size: var(--text-sm);">From ${s}</small>
              </div>
              <div class="time-badge">${best.times[i]} min</div>
            </div>`;
        });

        html += `
          </div>
          
          <div class="d-flex gap-3 mt-6 flex-wrap">
            <button class="btn-modern" onclick="showMeetingPointInfo('${best.station}')">
              <span class="material-icons">info</span>
              Meeting Point Info
            </button>
            <button class="btn-modern secondary" onclick="shareMeetingPoint('${best.station}', [${stations.map(s => `'${s}'`).join(',')}])">
              <span class="material-icons">share</span>
              Share Meeting Point
            </button>
            <button class="btn-modern secondary" onclick="getDirections('${best.station}')">
              <span class="material-icons">directions</span>
              Get Directions
            </button>
          </div>
          
          <div class="mt-4 p-4 bg-light rounded" style="border: 1px solid var(--neutral-200);">
            <small class="text-muted" style="font-size: var(--text-sm);">
              <span class="material-icons" style="font-size: 18px; vertical-align: middle; margin-right: 8px;">info</span>
              This location minimizes total travel time for all group members (${best.sum.toFixed(1)} combined stops)
            </small>
          </div>
        `;
        
        out.innerHTML = html;
        out.classList.remove('d-none');
        
        // Hide the map loading animation and scroll to results
        hideMapLoadingAnimation();
        
        // Scroll to results after a short delay to ensure elements are restored
        setTimeout(() => {
          out.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }, 100);
        
        showToast(`Found perfect meeting point: ${best.station}!`, false);
      }, 2000);
    }
    
    function shareMeetingPoint(meetingPoint, locations) {
      const shareText = `Let's meet at ${meetingPoint}! üöá\n\nOur starting locations:\n${locations.map((loc, i) => `${i+1}. ${loc}`).join('\n')}\n\nFound using SingaTrain Meet-up Finder`;
      
      if (navigator.share) {
        navigator.share({
          title: 'Meeting Point',
          text: shareText
        });
      } else {
        // Fallback: copy to clipboard
        navigator.clipboard.writeText(shareText).then(() => {
          showToast('Meeting details copied to clipboard!', false);
        });
      }
    }
    
    function getDirections(station) {
      // This would integrate with Google Maps or Apple Maps
      const mapsUrl = `https://www.google.com/maps/search/${encodeURIComponent(station + ' MRT Station Singapore')}`;
      window.open(mapsUrl, '_blank');
    }
    
    function createCapybaraLoader() {
      return `
        <div class="capybaraloader">
          <div class="capybara">
            <div class="capy">
              <div class="capyhead">
                <div class="capyear">
                  <div class="capyear2"></div>
                </div>
                <div class="capyear">
                  <div class="capyear2"></div>
                </div>
                <div class="capymouth">
                  <div class="capylips"></div>
                  <div class="capylips"></div>
                </div>
                <div class="capyeye"></div>
                <div class="capyeye"></div>
              </div>
              <div class="capyleg">
                <div class="capyleg2"></div>
                <div class="capyleg2"></div>
              </div>
            </div>
          </div>
          <div class="loader">
            <div class="loaderline"></div>
          </div>
        </div>
      `;
    }
    
    function showMapLoadingAnimation() {
      const mapContainer = document.getElementById('meetupMap');
      if (!mapContainer) return;
      
      // Hide all form elements during loading
      const meetupSection = document.getElementById('meetup');
      const formElements = meetupSection.querySelectorAll('.meetup-container, .meetup-actions');
      const mapSection = meetupSection.querySelector('.mt-6'); // Map container
      
      // Store original display states
      window.meetupFormStates = [];
      formElements.forEach((element, index) => {
        window.meetupFormStates[index] = element.style.display;
        element.style.display = 'none';
      });
      
      // Show only the map section
      if (mapSection) {
        mapSection.style.display = 'block';
        mapSection.style.marginTop = '0';
      }
      
      // Create overlay if it doesn't exist
      let overlay = mapContainer.querySelector('.map-loading-overlay');
      if (!overlay) {
        overlay = document.createElement('div');
        overlay.className = 'map-loading-overlay';
        overlay.innerHTML = `
          <div class="map-loading-content">
            ${createCapybaraLoader()}
            <h6>Finding the perfect meeting point</h6>
            <p>Analyzing locations across the MRT network</p>
          </div>
        `;
        mapContainer.style.position = 'relative';
        mapContainer.appendChild(overlay);
      }
      
      // Show the overlay
      setTimeout(() => {
        overlay.classList.add('show');
      }, 100);
    }
    
    function hideMapLoadingAnimation() {
      const mapContainer = document.getElementById('meetupMap');
      if (!mapContainer) return;
      
      const overlay = mapContainer.querySelector('.map-loading-overlay');
      if (overlay) {
        overlay.classList.remove('show');
        // Remove overlay after animation completes
        setTimeout(() => {
          if (overlay.parentNode) {
            overlay.parentNode.removeChild(overlay);
          }
        }, 300);
      }
      
      // Restore form elements after loading
      const meetupSection = document.getElementById('meetup');
      const formElements = meetupSection.querySelectorAll('.meetup-container, .meetup-actions');
      const mapSection = meetupSection.querySelector('.mt-6'); // Map container
      
      // Restore original display states
      if (window.meetupFormStates) {
        formElements.forEach((element, index) => {
          if (window.meetupFormStates[index] !== undefined) {
            element.style.display = window.meetupFormStates[index] || '';
          } else {
            element.style.display = '';
          }
        });
      }
      
      // Restore map section margin
      if (mapSection) {
        mapSection.style.marginTop = '';
      }
      
      // Clear stored states
      window.meetupFormStates = null;
    }

    // ====== ALTERNATIVE ROUTES ======
    async function findAlternatives(){
      const start = document.getElementById('altStart').value;
      const end = document.getElementById('altEnd').value;
      const affectedLine = document.getElementById('affectedLine').value;
      const out = document.getElementById('altOutput');
      if(!start || !end){ out.innerHTML = '<span class="text-danger">Please select both start and destination.</span>'; return; }

      out.innerHTML = '<div class="text-secondary">Finding alternative routes‚Ä¶</div>';

      // get disrupted lines (if not provided)
      let affected = [];
      try{
        if(affectedLine){
          affected = [affectedLine];
        }else{
          try{
            const alertUrl = `${PROXY}${encodeURIComponent(API_BASE + "/TrainServiceAlerts")}`;
            const res = await fetch(alertUrl, { headers:{ AccountKey: ACCOUNT_KEY, accept:"application/json" } });
            if(res.ok){
              const data = await res.json();
              const alerts = Array.isArray(data.value||data.Value) ? (data.value||data.Value) : (Array.isArray(data)?data:[]);
              affected = alerts.filter(a=>a.Status==2).map(a=>a.Line||a.line).filter(Boolean);
            }
          }catch(e){ 
            console.log('Alternative routes API unavailable, no affected lines detected');
            affected = []; 
          }
        }
      }catch(e){ /* ignore, show no affected */ }

      let html = '<h5>Alternative Routes</h5>';
      if(affected.length){
        html += `<div class="alert-card alert-disrupted mb-2"><strong>‚ö†Ô∏è Disruption:</strong> ${affected.join(', ')}</div>`;
      }

      // Option 1: MRT alternative ‚Äî we‚Äôll just return normal route (path planner will likely avoid nothing without full GTFS);
      const p = shortestPath(start, end);
      if(p){
        html += renderAltCard('Alternative MRT Route', p);
      }else{
        html += `<div class="text-danger">No MRT path found.</div>`;
      }

      // Option 2 / 3: simple placeholders (since bus routes require other datasets/APIs)
      html += renderSimpleAlt('Bus Alternative', 'Take closest bus from origin, transfer where needed, and alight near destination. Check Bus Arrival in LTA apps.');
      html += renderSimpleAlt('Mixed MRT + Bus', 'Ride MRT part-way, switch to bus to bypass affected section, then continue MRT.');

      out.innerHTML = html;
    }
    function renderAltCard(title, path){
      const mins = estimateTimeMinutes(path.totalWeight);
      let stepsHTML = '';
      // collapse steps by line
      const segs = [];
      let i=0;
      while(i<path.steps.length-1){
        const cur=path.steps[i]; let j=i+1;
        while(j<path.steps.length && path.steps[j].line===cur.line) j++;
        segs.push({from:cur.station, to:path.steps[j-1].station, line:cur.line, stops:getStopsCount(cur, path.steps[j-1])});
        i=j;
      }
      stepsHTML += segs.map(s=>`<div class="route-step">Take <strong>${s.line}</strong>: ${s.from} ‚Üí ${s.to} (${s.stops} stops)</div>`).join('');
      return `
        <div class="border rounded-3 p-3 my-2">
          <h6 class="text-danger">${title}</h6>
          <p class="mb-1"><strong>Estimated Time:</strong> ${mins} minutes</p>
          <p class="mb-1"><strong>Route:</strong></p>
          ${stepsHTML}
        </div>
      `;
    }
    function renderSimpleAlt(title, text){
      return `
        <div class="border rounded-3 p-3 my-2">
          <h6 class="text-danger">${title}</h6>
          <p class="mb-1">${text}</p>
        </div>`;
    }

    // ====== FARES ======
    // --- Adult (Card) ---
const fareBandsAdult = [
  { max: 3.2, fare: 1.19 }, { max: 4.2, fare: 1.29 }, { max: 5.2, fare: 1.40 },
  { max: 6.2, fare: 1.50 }, { max: 7.2, fare: 1.59 }, { max: 8.2, fare: 1.66 },
  { max: 9.2, fare: 1.73 }, { max: 10.2, fare: 1.77 }, { max: 11.2, fare: 1.81 },
  { max: 12.2, fare: 1.85 }, { max: 13.2, fare: 1.89 }, { max: 14.2, fare: 1.93 },
  { max: 15.2, fare: 1.98 }, { max: 16.2, fare: 2.02 }, { max: 17.2, fare: 2.06 },
  { max: 18.2, fare: 2.10 }, { max: 19.2, fare: 2.14 }, { max: 20.2, fare: 2.17 },
  { max: 21.2, fare: 2.20 }, { max: 22.2, fare: 2.23 }, { max: 23.2, fare: 2.26 },
  { max: 24.2, fare: 2.28 }, { max: 25.2, fare: 2.30 }, { max: 26.2, fare: 2.32 },
  { max: 27.2, fare: 2.33 }, { max: 28.2, fare: 2.34 }, { max: 29.2, fare: 2.35 },
  { max: 30.2, fare: 2.36 }, { max: 31.2, fare: 2.37 }, { max: 32.2, fare: 2.38 },
  { max: 33.2, fare: 2.39 }, { max: 34.2, fare: 2.40 }, { max: 35.2, fare: 2.41 },
  { max: 36.2, fare: 2.42 }, { max: 37.2, fare: 2.43 }, { max: 38.2, fare: 2.44 },
  { max: 39.2, fare: 2.45 }, { max: 40.2, fare: 2.46 }, { max: Infinity, fare: 2.47 }
];

// --- Student (Card) ---
const fareBandsStudent = [
  { max: 3.2, fare: 0.52 }, { max: 4.2, fare: 0.57 }, { max: 5.2, fare: 0.63 },
  { max: 6.2, fare: 0.68 }, { max: 7.2, fare: 0.71 }, { max: Infinity, fare: 0.74 }
];

// --- Senior Citizens / Persons with Disabilities (Card) ---
const fareBandsSenior = [
  { max: 3.2, fare: 0.69 }, { max: 4.2, fare: 0.76 }, { max: 5.2, fare: 0.84 },
  { max: 6.2, fare: 0.91 }, { max: 7.2, fare: 0.97 }, { max: Infinity, fare: 1.03 }
];

// --- Workfare Transport Concession (Card) ---
const fareBandsWorkfare = [
  { max: 3.2, fare: 0.78 }, { max: 4.2, fare: 0.86 }, { max: 5.2, fare: 0.95 },
  { max: 6.2, fare: 1.03 }, { max: 7.2, fare: 1.10 }, { max: 8.2, fare: 1.16 },
  { max: 9.2, fare: 1.22 }, { max: 10.2, fare: 1.25 }, { max: 11.2, fare: 1.28 },
  { max: 12.2, fare: 1.31 }, { max: 13.2, fare: 1.34 }, { max: 14.2, fare: 1.37 },
  { max: 15.2, fare: 1.40 }, { max: 16.2, fare: 1.43 }, { max: 17.2, fare: 1.46 },
  { max: 18.2, fare: 1.49 }, { max: 19.2, fare: 1.52 }, { max: 20.2, fare: 1.55 },
  { max: 21.2, fare: 1.58 }, { max: 22.2, fare: 1.61 }, { max: 23.2, fare: 1.64 },
  { max: 24.2, fare: 1.66 }, { max: 25.2, fare: 1.67 }, { max: 26.2, fare: 1.68 },
  { max: 27.2, fare: 1.69 }, { max: 28.2, fare: 1.70 }, { max: 29.2, fare: 1.71 },
  { max: 30.2, fare: 1.72 }, { max: 31.2, fare: 1.73 }, { max: 32.2, fare: 1.74 },
  { max: 33.2, fare: 1.75 }, { max: 34.2, fare: 1.76 }, { max: 35.2, fare: 1.77 },
  { max: 36.2, fare: 1.78 }, { max: 37.2, fare: 1.79 }, { max: 38.2, fare: 1.80 },
  { max: 39.2, fare: 1.81 }, { max: 40.2, fare: 1.82 }, { max: Infinity, fare: 1.83 }
];



    // ====== Monthly Pass Tables (LTA Dec 2024) ======
const monthlyPasses = {
  // --- Train-only passes ---
  train: {
    primary: 21.00,
    secondary: 26.50,
    polytechnic: 26.50,
    university: 48.00,
    ns: 48.00,
    senior: 58.00,
    disability: 58.00,
    workfare: 96.00,
    adult: 128.00
  },

  // --- Bus-only passes ---
  bus: {
    primary: 24.00,
    secondary: 29.00,
    polytechnic: 29.00,
    university: 55.50,
    ns: 55.50,
    senior: 58.00,
    disability: 58.00,
    workfare: 96.00,
    adult: 128.00
  },

  // --- Hybrid (Bus + Train) passes ---
  hybrid: {
    primary: 39.00,
    secondary: 49.00,
    polytechnic: 49.00,
    university: 81.00,
    ns: 81.00,
    senior: 58.00,
    disability: 58.00,
    workfare: 96.00,
    adult: 128.00
  }
};


function fareByType(km, type = "adult") {
  let bands;

  switch (type) {
    // üßí Students up to Polytechnic ‚Üí Student table
    case "primary":
    case "secondary":
    case "polytechnic":
      bands = fareBandsStudent;
      break;

    // üë¥ Seniors & PWD ‚Üí Senior table
    case "senior":
    case "disability":
      bands = fareBandsSenior;
      break;

    // üßë‚Äçüè≠ Workfare ‚Üí Workfare table
    case "workfare":
      bands = fareBandsWorkfare;
      break;

    // üéì University & NS use the same fare as Adults
    case "university":
    case "ns":
    case "adult":
    default:
      bands = fareBandsAdult;
  }

  for (const b of bands) {
    if (km <= b.max) return b.fare;
  }
  return bands[bands.length - 1].fare;
}
   
    
    function calculateFare(){
  const start = document.getElementById('fareStart').value;
  const end = document.getElementById('fareEnd').value;
  const type = document.getElementById('commuterType').value;
  const out = document.getElementById('fareOutput');

  if(!start || !end){
    out.innerHTML = '<span class="text-danger">Please select both stations.</span>';
    return;
  }

  const p = shortestPath(start, end);
  if(!p){
    out.innerHTML = '<span class="text-danger">No route found.</span>';
    return;
  }

  const km = estimateDistanceKm(p.totalWeight);
  const fare = fareByType(km, type);
  const typeText = document.querySelector(`#commuterType option[value="${type}"]`).textContent;

  let html = `<h5>Fare Calculation</h5>`;
  html += `<div class="fare-result">
    <div class="fs-3 mb-1">$${fare.toFixed(2)}</div>
    <div class="small">Estimated fare (${typeText})</div>
  </div>`;
  html += `<div class="border rounded p-3 bg-light">
    <p class="mb-1"><strong>Journey:</strong> ${start} ‚Üí ${end}</p>
    <p class="mb-1"><strong>Approx Distance:</strong> ${km} km (stops-based estimate)</p>
  </div>`;
  out.innerHTML = html;
}

    function calculatePassValue() {
  const start = document.getElementById('fareStart').value;
  const end = document.getElementById('fareEnd').value;
  const type = document.getElementById('commuterType').value;
  const dailyTrips = parseInt(document.getElementById('dailyTrips').value) || 2;
  const workingDays = parseInt(document.getElementById('workingDays').value) || 22;
  const out = document.getElementById('passOutput');

  if (!start || !end) {
    out.innerHTML = '<span class="text-danger">Select journey in the fare calculator above.</span>';
    return;
  }

  const path = shortestPath(start, end);
  if (!path) {
    out.innerHTML = '<span class="text-danger">No route found.</span>';
    return;
  }

  // Estimate trip fare
  const km = estimateDistanceKm(path.totalWeight);
  const singleFare = fareByType(km, type);
  const monthlyTotal = singleFare * dailyTrips * workingDays;

  // Decide relevant pass types
  const travelModes = ["train", "bus", "hybrid"];
  const results = [];

  for (const mode of travelModes) {
    const passPrice = monthlyPasses[mode][type] ?? monthlyPasses[mode]["adult"];
    const savings = monthlyTotal - passPrice;
    const worth = savings > 0;
    results.push({ mode, passPrice, savings, worth });
  }

  // Render output
  let html = `<h5>Monthly Pass Analysis</h5>`;
  html += `<div class="border rounded p-3 bg-light mb-3">
    <p><strong>Single Trip Fare:</strong> $${singleFare.toFixed(2)}</p>
    <p><strong>Daily Trips:</strong> ${dailyTrips}</p>
    <p><strong>Working Days:</strong> ${workingDays}</p>
    <p><strong>Estimated Monthly Spend (Pay-Per-Ride):</strong> $${monthlyTotal.toFixed(2)}</p>
  </div>`;

  html += `<div class="table-responsive">
    <table class="table table-striped align-middle">
      <thead class="table-danger text-center">
        <tr>
          <th>Pass Type</th>
          <th>Price ($)</th>
          <th>Net Savings / Loss ($)</th>
          <th>Recommendation</th>
        </tr>
      </thead>
      <tbody class="text-center">`;

  for (const r of results) {
    html += `<tr>
      <td class="text-capitalize">${r.mode}</td>
      <td>${r.passPrice.toFixed(2)}</td>
      <td class="${r.worth ? 'text-success' : 'text-danger'}">
        ${r.worth ? '+' : '‚àí'}${Math.abs(r.savings).toFixed(2)}
      </td>
      <td>${r.worth ? '‚úÖ Worth It' : '‚ùå Not Worth It'}</td>
    </tr>`;
  }

  html += `</tbody></table></div>`;

  out.innerHTML = html;
}

    // ====== PROFILE / FAVORITES ======
    function saveProfile(){
      const name = document.getElementById('profileName').value.trim();
      if(name){
        userData.name = name;
        document.getElementById('userName').textContent = name;
        showToast('Profile saved.', false);
      }
    }
    function addFavorite(){
      const label = document.getElementById('favoriteLabel').value.trim();
      const station = document.getElementById('favoriteStation').value;
      if(!label || !station){ showToast('Please enter label and station.'); return; }
      if(userData.favorites.some(f=>f.label===label)){ showToast('Duplicate label.'); return; }
      userData.favorites.push({ label, station });
      document.getElementById('favoriteLabel').value='';
      document.getElementById('favoriteStation').value='';
      displayFavorites();
      showToast('Favorite added.', false);
    }
    function removeFavorite(idx){
      userData.favorites.splice(idx,1);
      displayFavorites();
    }
    function displayFavorites(){
      const container = document.getElementById('favoritesOutput');
      if(userData.favorites.length===0){
        container.innerHTML = '<div class="text-secondary">No favorite stations yet.</div>'; return;
      }
      container.innerHTML = userData.favorites.map((f,i)=>`
        <div class="d-flex justify-content-between align-items-center border rounded p-2 mb-2">
          <div><strong>${f.label}</strong><div class="text-secondary small">${f.station}</div></div>
          <button class="btn btn-outline-danger btn-sm" onclick="removeFavorite(${i})">Remove</button>
        </div>`).join('');
    }
    function loadDashboard(){
      // favorites
      const favContainer = document.getElementById('dashboardFavorites');
      if(userData.favorites.length===0){
        favContainer.innerHTML = '<div class="text-secondary">No favorites. Add some in Profile.</div>';
      }else{
        favContainer.innerHTML = userData.favorites.map(f=>`
          <div class="col-md-6">
            <div class="border rounded p-3 h-100" role="button" onclick="viewFavoriteDetails('${f.station.replace(/'/g,"\\'")}')">
              <div class="fw-semibold">${f.label}</div>
              <div class="text-danger">${f.station}</div>
              <div class="small text-secondary">Click for live info</div>
            </div>
          </div>
        `).join('');
      }

      // alerts
      const alertContainer = document.getElementById('dashboardAlerts');
      alertContainer.innerHTML = '<div class="text-secondary">Loading alerts‚Ä¶</div>';
      (async ()=>{
        try{
          const url = `${PROXY}${encodeURIComponent(API_BASE + "/TrainServiceAlerts")}`;
          const res = await fetch(url, { headers:{ AccountKey: ACCOUNT_KEY, accept:"application/json" } });
          if(!res.ok) throw new Error('Alerts not available');
          const data = await res.json();
          let alerts = Array.isArray(data.value||data.Value) ? (data.value||data.Value) : (Array.isArray(data)?data:[]);
          if(alerts.length===0){
            alertContainer.innerHTML = '<div class="alert-card alert-normal">‚úÖ All train lines operating normally</div>';
          }else{
            alertContainer.innerHTML = alerts.map(a=>{
              const disrupted = a.Status==2;
              return `<div class="alert-card ${disrupted?'alert-disrupted':'alert-normal'} mb-2">
                <strong>${disrupted?'‚ö†Ô∏è':'‚úÖ'} ${a.Line||'Line'}</strong><br>
                <small>${a.Message||'No details'}</small>
              </div>`;
            }).join('');
          }
        }catch(err){
          console.log('Dashboard alerts API unavailable, showing normal status');
          alertContainer.innerHTML = '<div class="alert-card alert-normal">‚úÖ All train lines operating normally (demo mode)</div>';
        }
      })();
    }
    function viewFavoriteDetails(station){
      alert(`Live details for ${station} would appear here.\n\nIn a full build: live arrivals, crowd level, service alerts, nearby facilities.`);
    }

    // ====== MAPBOX ======
    function initMeetupMap(){
      mapboxgl.accessToken = 'pk.eyJ1IjoiY2hlZWF1biIsImEiOiJja2NydG83cWMwaGJsMnBqdjR5aHc3MzdlIn0.YGTZpi7JQMquEOv9E8K_bg';
      const map = new mapboxgl.Map({
        container: 'meetupMap',
        style: 'mapbox://styles/mapbox/streets-v11',
        center: [103.8475, 1.3011], zoom: 11, renderWorldCopies:false
      });
      map.addControl(new mapboxgl.NavigationControl());

      map.on('load', async ()=>{
        try{
          const response = await fetch('./rail-map-standalone/sg-rail.geo.66ea655e.json');
          if(!response.ok) throw new Error(`HTTP ${response.status}`);
          const data = await response.json();

          map.addSource('mrt-stations', { type:'geojson', data });
          map.addLayer({
            id:'mrt-lines', source:'mrt-stations', filter:['==',['geometry-type'],'LineString'], type:'line',
            paint:{
              'line-width':['interpolate',['linear'],['zoom'],10,2,16,6],
              'line-color':[
                'match',['get','line_color'],
                'orangered','#d42e12','mediumseagreen','#009645','orange','#fa9e0d','saddlebrown','#9D5B25',
                'darkmagenta','#9900aa','darkslateblue','#005ec4','gray','#748477', '#748477'
              ], 'line-opacity':0.8
            }, layout:{ 'line-cap':'round','line-join':'round' }
          });
          map.addLayer({
            id:'stations', source:'mrt-stations', filter:['==',['get','stop_type'],'station'], type:'circle',
            paint:{
              'circle-radius':6,
              'circle-color':[
                'match',['get','station_colors'],
                'red','#d42e12','green','#009645','orange','#fa9e0d','brown','#9D5B25','purple','#9900aa','blue','#005ec4','#748477'
              ],
              'circle-stroke-color':'#fff','circle-stroke-width':2
            }
          });
          map.addLayer({
            id:'station-labels', source:'mrt-stations', filter:['==',['get','stop_type'],'station'], type:'symbol',
            layout:{ 'text-field':['get','name'],'text-size':12,'text-anchor':'bottom','text-offset':[0,-1] },
            paint:{ 'text-halo-color':'#fff','text-halo-width':2 }
          });

          // Store avatar markers
          const avatarMarkers = new Map();
          
          map.on('click','stations',(e)=>{
            const f = e.features[0];
            const props = f.properties;
            const name = props.name;
            const coordinates = e.lngLat;
            
            // Create click ripple animation
            createMapClickRipple(e.point);
            
            // Add station selection animation
            const stationElement = e.originalEvent.target;
            if (stationElement) {
              stationElement.classList.add('station-selected');
              setTimeout(() => {
                stationElement.classList.remove('station-selected');
              }, 800);
            }
            
            // Get all dropdowns
            const allSelects = document.querySelectorAll('#meetupLocations .meetup-station');
            
            // Check if this station is already selected
            let selectedIndex = -1;
            for (let i = 0; i < allSelects.length; i++) {
              if (allSelects[i].value === name) {
                selectedIndex = i;
                break;
              }
            }
            
            if (selectedIndex !== -1) {
              // Station already selected - remove it
              allSelects[selectedIndex].value = '';
              removeAvatarMarker(name);
              showToast(`Removed ${name} from person ${selectedIndex + 1}`, false);
            } else {
              // Station not selected - add it
              let emptySelect = null;
              
              // Look for first empty dropdown
              for (let select of allSelects) {
                if (!select.value || select.value === '') {
                  emptySelect = select;
                  break;
                }
              }
              
              if (emptySelect) {
                // Fill the empty slot
                emptySelect.value = name;
                const personNumber = Array.from(allSelects).indexOf(emptySelect) + 1;
                addAvatarMarker(name, coordinates, personNumber);
                showToast(`Selected ${name} for person ${personNumber}`, false);
              } else {
                // No empty slots, add a new person only if we have less than 10 people
                const currentCount = allSelects.length;
                if (currentCount < 10) {
                  addMeetupLocation();
                  // Wait for DOM update, then fill the new select
                  setTimeout(() => {
                    const newSelects = document.querySelectorAll('#meetupLocations .meetup-station');
                    const newSelect = newSelects[newSelects.length - 1]; // Get the last one
                    if (newSelect) {
                      newSelect.value = name;
                      const personNumber = newSelects.length;
                      addAvatarMarker(name, coordinates, personNumber);
                      showToast(`Added ${name} as person ${personNumber}`, false);
                    }
                  }, 50); // Increased timeout for DOM update
                } else {
                  showToast('Maximum 10 people allowed', true);
                }
              }
            }
          });
          
          function createMapClickRipple(point) {
            const mapContainer = document.getElementById('meetupMap');
            const ripple = document.createElement('div');
            ripple.className = 'map-click-ripple';
            ripple.style.left = point.x + 'px';
            ripple.style.top = point.y + 'px';
            ripple.style.width = '20px';
            ripple.style.height = '20px';
            ripple.style.marginLeft = '-10px';
            ripple.style.marginTop = '-10px';
            
            mapContainer.appendChild(ripple);
            
            setTimeout(() => {
              ripple.remove();
            }, 600);
          }
          
          function addAvatarMarker(stationName, coordinates, personNumber) {
            // Remove existing marker if any
            removeAvatarMarker(stationName);
            
            // Create simple emoji marker
            const avatarEl = document.createElement('div');
            avatarEl.className = 'avatar-marker';
            avatarEl.innerHTML = getCarEmoji(personNumber);
            avatarEl.style.cssText = `
              width: 30px;
              height: 30px;
              display: flex;
              align-items: center;
              justify-content: center;
              cursor: pointer;
              font-size: 20px;
              background: white;
              border-radius: 50%;
              box-shadow: 0 2px 8px rgba(0,0,0,0.2);
              border: 2px solid var(--sg-red);
            `;
            
            // Add marker to map
            const marker = new mapboxgl.Marker(avatarEl)
              .setLngLat([coordinates.lng, coordinates.lat])
              .addTo(map);
            
            avatarMarkers.set(stationName, marker);
          }
          
          
          function removeAvatarMarker(stationName) {
            const marker = avatarMarkers.get(stationName);
            if (marker) {
              marker.remove();
              avatarMarkers.delete(stationName);
            }
          }
          
          function getAvatarEmoji(personNumber) {
            const cars = ['üöó', 'üöô', 'üöï', 'üöì', 'üöë', 'üöí', 'üöê', 'üöö', 'üöõ', 'üèéÔ∏è'];
            return cars[(personNumber - 1) % cars.length];
          }
          
          // Driving animation functions
          function showMeetingPointInfo(meetingStation) {
            showToast(`üìç Meeting Point: ${meetingStation}`, false);
            
            // Center the map on the meeting point
            const stationCoords = getStationCoordinates(meetingStation);
            if (stationCoords) {
              map.flyTo({
                center: [stationCoords.lng, stationCoords.lat],
                zoom: 15,
                duration: 1000
              });
            }
          }
          
          function getStationCoordinates(stationName) {
            // This would normally query the GeoJSON data
            // For now, return some sample coordinates
            const sampleCoords = {
              'City Hall': { lng: 103.8523, lat: 1.2931 },
              'Raffles Place': { lng: 103.8514, lat: 1.2834 },
              'Marina Bay': { lng: 103.8546, lat: 1.2767 },
              'Orchard': { lng: 103.8320, lat: 1.3048 },
              'Dhoby Ghaut': { lng: 103.8458, lat: 1.2990 },
              'Newton': { lng: 103.8384, lat: 1.3003 },
              'Stevens': { lng: 103.8254, lat: 1.3201 },
              'Napier': { lng: 103.8080, lat: 1.3048 },
              'Orchard Boulevard': { lng: 103.8320, lat: 1.3048 }
            };
            
            return sampleCoords[stationName] || null;
          }
          map.on('mouseenter','stations',()=>map.getCanvas().style.cursor='pointer');
          map.on('mouseleave','stations',()=>map.getCanvas().style.cursor='');
        }catch(error){
          console.error('Meetup map load error, using fallback:', error);
          const fallback = {
            type:'FeatureCollection', features:[
              { type:'Feature', properties:{ name:'City Hall', station_codes:'NS25-EW13', station_colors:'red', 'name_zh-Hans':'ÊîøÂ∫úÂ§ßÂé¶', name_ta:'‡Æö‡Æø‡Æü‡Øç‡Æü‡Æø ‡Æπ‡Ææ‡Æ≤‡Øç' }, geometry:{ type:'Point', coordinates:[103.8523,1.2931] } },
              { type:'Feature', properties:{ name:'Raffles Place', station_codes:'NS26-EW14', station_colors:'green', 'name_zh-Hans':'Ëé±‰ΩõÂ£´Âùä', name_ta:'‡Æ∞‡Ææ‡ÆÉ‡Æ™‡Æø‡Æ≥‡Øç‡Æ∏‡Øç ‡Æ™‡Æø‡Æ≥‡Øá‡Æ∏‡Øç' }, geometry:{ type:'Point', coordinates:[103.8514,1.2834] } },
              { type:'Feature', properties:{ name:'Marina Bay', station_codes:'NS27-CC4-TE2', station_colors:'orange', 'name_zh-Hans':'Êª®Êµ∑Êπæ', name_ta:'‡ÆÆ‡Æ∞‡Æø‡Æ©‡Ææ ‡Æ™‡Øá' }, geometry:{ type:'Point', coordinates:[103.8546,1.2767] } }
            ]
          };
          map.addSource('mrt-stations',{ type:'geojson', data:fallback });
          map.addLayer({ id:'stations', source:'mrt-stations', type:'circle',
            paint:{ 'circle-radius':8,'circle-color':'#d42e12','circle-stroke-color':'#fff','circle-stroke-width':2 }});
        }
      });
    }

    function initMap(){
      mapboxgl.accessToken = 'pk.eyJ1IjoiY2hlZWF1biIsImEiOiJja2NydG83cWMwaGJsMnBqdjR5aHc3MzdlIn0.YGTZpi7JQMquEOv9E8K_bg';
      const map = new mapboxgl.Map({
        container: 'singaporeMap',
        style: 'mapbox://styles/mapbox/streets-v11',
        center: [103.8475, 1.3011], zoom: 11, renderWorldCopies:false
      });
      map.addControl(new mapboxgl.NavigationControl());

      map.on('load', async ()=>{
        try{
          const response = await fetch('./rail-map-standalone/sg-rail.geo.66ea655e.json');
          if(!response.ok) throw new Error(`HTTP ${response.status}`);
          const data = await response.json();

          map.addSource('mrt-stations', { type:'geojson', data });
          map.addLayer({
            id:'mrt-lines', source:'mrt-stations', filter:['==',['geometry-type'],'LineString'], type:'line',
            paint:{
              'line-width':['interpolate',['linear'],['zoom'],10,2,16,6],
              'line-color':[
                'match',['get','line_color'],
                'orangered','#d42e12','mediumseagreen','#009645','orange','#fa9e0d','saddlebrown','#9D5B25',
                'darkmagenta','#9900aa','darkslateblue','#005ec4','gray','#748477', '#748477'
              ], 'line-opacity':0.8
            }, layout:{ 'line-cap':'round','line-join':'round' }
          });
          map.addLayer({
            id:'stations', source:'mrt-stations', filter:['==',['get','stop_type'],'station'], type:'circle',
            paint:{
              'circle-radius':6,
              'circle-color':[
                'match',['get','station_colors'],
                'red','#d42e12','green','#009645','orange','#fa9e0d','brown','#9D5B25','purple','#9900aa','blue','#005ec4','#748477'
              ],
              'circle-stroke-color':'#fff','circle-stroke-width':2
            }
          });
          map.addLayer({
            id:'station-labels', source:'mrt-stations', filter:['==',['get','stop_type'],'station'], type:'symbol',
            layout:{ 'text-field':['get','name'],'text-size':12,'text-anchor':'bottom','text-offset':[0,-1] },
            paint:{ 'text-halo-color':'#fff','text-halo-width':2 }
          });

          map.on('click','stations',(e)=>{
            document.querySelectorAll('.mapboxgl-popup').forEach(p=>p.remove());
            const f = e.features[0];
            const props = f.properties;
            const name = props.name;
            const codes = props.station_codes;
            const colors = props.station_colors;
            const nameZh = props['name_zh-Hans']||'';
            const nameTa = props.name_ta||'';
            const lineName = {
              'red':'North-South Line (NSL)','green':'East-West Line (EWL)','orange':'Circle Line (CCL)','brown':'Downtown Line (DTL)','purple':'North East Line (NEL)','blue':'Thomson-East Coast Line (TEL)','gray':'LRT Line'
            }[colors] || 'Unknown Line';
            const dot = (c)=> (c==='red'?'#d42e12':c==='green'?'#009645':c==='orange'?'#fa9e0d':c==='brown'?'#9D5B25':c==='purple'?'#9900aa':c==='blue'?'#005ec4':'#748477');

            new mapboxgl.Popup({ maxWidth:'300px', closeButton:true, closeOnClick:false })
              .setLngLat(e.lngLat)
              .setHTML(`
                <div style="padding:12px">
                  <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
                    <span style="width:14px;height:14px;border-radius:50%;background:${dot(colors)};display:inline-block"></span>
                    <strong>${name}</strong>
                  </div>
                  <div class="mb-1"><span class="text-secondary">Code:</span> <span class="fw-semibold text-danger">${codes}</span></div>
                  <div class="mb-1"><span class="text-secondary">Line:</span> ${lineName}</div>
                  ${nameZh? `<div class="mb-1"><span class="text-secondary">‰∏≠Êñá:</span> ${nameZh}</div>`:''}
                  ${nameTa? `<div class="mb-1"><span class="text-secondary">‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç:</span> ${nameTa}</div>`:''}
                  <button class="btn btn-primary btn-sm w-100 mt-2" onclick="alert('Live arrivals & crowd levels shown here in a full build')">View Live Info</button>
                </div>`)
              .addTo(map);
          });
          map.on('mouseenter','stations',()=>map.getCanvas().style.cursor='pointer');
          map.on('mouseleave','stations',()=>map.getCanvas().style.cursor='');
        }catch(error){
          console.error('Map load error, using fallback:', error);
          const fallback = {
            type:'FeatureCollection', features:[
              { type:'Feature', properties:{ name:'City Hall', station_codes:'NS25-EW13', station_colors:'red', 'name_zh-Hans':'ÊîøÂ∫úÂ§ßÂé¶', name_ta:'‡Æö‡Æø‡Æü‡Øç‡Æü‡Æø ‡Æπ‡Ææ‡Æ≤‡Øç' }, geometry:{ type:'Point', coordinates:[103.8523,1.2931] } },
              { type:'Feature', properties:{ name:'Raffles Place', station_codes:'NS26-EW14', station_colors:'green', 'name_zh-Hans':'Ëé±‰ΩõÂ£´Âùä', name_ta:'‡Æ∞‡Ææ‡ÆÉ‡Æ™‡Æø‡Æ≥‡Øç‡Æ∏‡Øç ‡Æ™‡Æø‡Æ≥‡Øá‡Æ∏‡Øç' }, geometry:{ type:'Point', coordinates:[103.8514,1.2834] } },
              { type:'Feature', properties:{ name:'Marina Bay', station_codes:'NS27-CC4-TE2', station_colors:'orange', 'name_zh-Hans':'Êª®Êµ∑Êπæ', name_ta:'‡ÆÆ‡Æ∞‡Æø‡Æ©‡Ææ ‡Æ™‡Øá' }, geometry:{ type:'Point', coordinates:[103.8546,1.2767] } }
            ]
          };
          map.addSource('mrt-stations',{ type:'geojson', data:fallback });
          map.addLayer({ id:'stations', source:'mrt-stations', type:'circle',
            paint:{ 'circle-radius':8,'circle-color':'#d42e12','circle-stroke-color':'#fff','circle-stroke-width':2 }});
        }
      });
    }

    // ====== ON LOAD ======
    window.addEventListener('DOMContentLoaded', ()=>{
      // Initialize AOS (Animate On Scroll)
      AOS.init({
        duration: 800,
        easing: 'ease-out-cubic',
        once: true,
        offset: 100
      });
      
      initializeDropdowns();
      displayFavorites();
      loadDashboard();
      initMap();

      // make Dashboard default
      setActiveTab('dashboard');
    });
  </script>
</body>
</html>