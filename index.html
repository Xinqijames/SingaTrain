<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Singapore MRT Assistant</title>

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" defer></script>

  <!-- Mapbox -->
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.10.0/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.10.0/mapbox-gl.css" rel="stylesheet" />

  <style>
    :root {
  --sg-red: #750000;         /* Primary brand red */
  --sg-red-dark: #4d0000;    /* Darker hover red */
  --sg-red-soft: #f8eaea;    /* Light background tint */
  --sg-grey: #6b7280;
  --sg-border: #e5e7eb;
}
    * { box-sizing: border-box; }
    body {
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol";
       background: linear-gradient(135deg, #ffffff 0%, #fff5f5 40%, #f8eaea 100%);
      color:#111827;
      min-height: 100vh;
    }
    header{
      background: #fff;
      border-bottom: 1px solid var(--sg-border);
      position: sticky; top:0; z-index:1000;
    }
    .app-title { color: var(--sg-red); }
    .nav-pills .nav-link {
  border-radius: 999px;
  color: #fff;
  background: var(--sg-red);
}
.nav-pills .nav-link:not(.active) {
  background: #8b0000;
  opacity: 0.85;
}
.nav-pills .nav-link:hover {
  background: var(--sg-red-dark);
}
    .section-card{
      background:#fff; border:1px solid var(--sg-border);
      border-radius:16px; padding:24px; box-shadow:0 10px 24px rgba(0,0,0,.06);
    }
    h2.section-title{ color:var(--sg-red); }
    .feature-description{
      background: var(--sg-red-soft); border:1px solid #fecaca; color:#991b1b;
    }
    .btn-primary{ background: var(--sg-red); border-color: var(--sg-red); }
    .btn-primary:hover{ background: var(--sg-red-dark); border-color: var(--sg-red-dark); }
    .btn-success{ background:#059669; border:#059669; }
    .pill{
      display:inline-block; padding:.25rem .6rem; border-radius:999px; font-size:.85rem;
      background:#f3f4f6; border:1px solid #e5e7eb; color:#111827;
    }
    .output-box{
      margin-top: 16px; padding:16px; background:#f9fafb; border-left:4px solid var(--sg-red);
      border-radius:8px; min-height: 100px;
    }
    .alert-card{ border:1px solid var(--sg-border); border-left-width:4px; border-radius:8px; padding:12px; background:#fff; }
    .alert-disrupted{ border-left-color:#ef4444; }
    .alert-normal{ border-left-color:#16a34a; }
    .route-step{ background:#f3f4f6; border-left:4px solid var(--sg-red); border-radius:8px; padding:12px; margin:.5rem 0; }
    .fare-result{
      background: linear-gradient(135deg, var(--sg-red) 0%, var(--sg-red-dark) 100%);
      color:#fff; padding:18px; border-radius:12px; text-align:center; font-size:1.1rem;
    }
    .mapboxgl-popup-content{ border-radius:12px !important; }
    .station-chip{ font-weight:600; color:var(--sg-red); }
    .form-select, .form-control{ border:2px solid #e5e7eb; }
    .form-select:focus, .form-control:focus{ border-color: var(--sg-red); box-shadow: 0 0 0 .2rem rgba(220,38,38,.15); }
  </style>
</head>
<body>
  <!-- HEADER -->
  <header class="py-3">
    <div class="container d-flex flex-wrap align-items-center justify-content-between">
      <div class="d-flex align-items-center gap-2">
  <img src="./singatrainlogo.png" alt="SingaTrain Logo" width="38" height="38" style="border-radius:8px;">
  <h1 class="h4 m-0 app-title">SingaTrain</h1>
</div>
      <div class="d-flex align-items-center gap-2">
        <span class="fw-semibold text-secondary" id="userName">Guest User</span>
        <button class="btn btn-outline-danger btn-sm" onclick="showTab('profile')">Profile</button>
      </div>
      <div class="w-100 mt-3">
        <ul class="nav nav-pills justify-content-center gap-2">
          <li class="nav-item"><button class="nav-link active" data-tab="dashboard">Dashboard</button></li>
          <li class="nav-item"><button class="nav-link" data-tab="live">Live Tracking</button></li>
          <li class="nav-item"><button class="nav-link" data-tab="route">Route Planner</button></li>
          <li class="nav-item"><button class="nav-link" data-tab="meetup">Meet-up</button></li>
          <li class="nav-item"><button class="nav-link" data-tab="alternatives">Alt Routes</button></li>
          <li class="nav-item"><button class="nav-link" data-tab="fare">Fare</button></li>
          <li class="nav-item"><button class="nav-link" data-tab="profile">Profile</button></li>
        </ul>
      </div>
    </div>
  </header>

  <main class="container my-4">

    <!-- DASHBOARD -->
    <section id="dashboard" class="section-card">
      <h2 class="section-title mb-2">üìä My Dashboard</h2>
      <div class="feature-description p-3 rounded mb-3">
        Quick access to your favorite stations, map, and live alerts.
      </div>

      <!-- Map -->
      <div class="mb-3">
        <h5 class="mb-2">üó∫Ô∏è Singapore MRT Network</h5>
        <div id="singaporeMap" style="width:100%;height:400px;border:1px solid var(--sg-border);border-radius:12px;background:#f3f4f6"></div>
      </div>

      <h5 class="mt-3">‚≠ê Favorite Stations</h5>
      <div id="dashboardFavorites" class="row g-3"></div>

      <h5 class="mt-4">üì£ Current Service Alerts</h5>
      <div id="dashboardAlerts" class="mt-2"></div>
    </section>

    <!-- LIVE -->
    <section id="live" class="section-card d-none">
      <h2 class="section-title mb-2">üöÜ Real-Time Train Tracking</h2>
      <div class="feature-description p-3 rounded mb-3">Live service alerts and station crowd levels by line.</div>

      <div class="row g-3">
        <div class="col-sm-6">
          <label class="form-label">Select MRT Line</label>
          <select id="liveTrainLine" class="form-select">
            <option value="NSL">North South Line (NSL)</option>
            <option value="EWL">East West Line (EWL)</option>
            <option value="DTL">Downtown Line (DTL)</option>
            <option value="CCL">Circle Line (CCL)</option>
            <option value="NEL">North East Line (NEL)</option>
            <option value="TEL">Thomson-East Coast Line (TEL)</option>
          </select>
        </div>
        <div class="col-sm-6 d-flex align-items-end">
          <button class="btn btn-primary" onclick="fetchLiveInfo()">Get Live Information</button>
        </div>
      </div>

      <div class="output-box mt-3" id="liveOutput">
        <div class="text-secondary">Select a line and click ‚ÄúGet Live Information‚Äù.</div>
      </div>
    </section>

    <!-- ROUTE -->
    <section id="route" class="section-card d-none">
      <h2 class="section-title mb-2">üó∫Ô∏è Interactive Route Planner</h2>
      <div class="feature-description p-3 rounded mb-3">Shortest path (fewest stops) across lines & interchanges with time estimate.</div>

      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label">Starting Station</label>
          <select id="routeStart" class="form-select"></select>
        </div>
        <div class="col-md-6">
          <label class="form-label">Destination Station</label>
          <select id="routeEnd" class="form-select"></select>
        </div>
      </div>
      <button class="btn btn-primary mt-3" onclick="planRoute()">Plan Route</button>

      <div class="output-box mt-3" id="routeOutput">
        <div class="text-secondary">Enter start & destination to plan your route.</div>
      </div>
    </section>

    <!-- MEETUP -->
    <section id="meetup" class="section-card d-none">
      <h2 class="section-title mb-2">üë• Meet-up Point Finder</h2>
      <div class="feature-description p-3 rounded mb-3">Find a fair meet-up station by minimizing total stops (approx time).</div>

      <div class="mb-2">
        <label class="form-label">Add Group Members‚Äô Locations</label>
        <div id="meetupLocations" class="d-grid gap-2"></div>
        <button class="btn btn-success btn-sm mt-2" onclick="addMeetupLocation()">+ Add Another Person</button>
      </div>

      <button class="btn btn-primary" onclick="findMeetupPoint()">Find Best Meet-up Point</button>
      
      <!-- Map for Meet-up -->
      <div class="mt-4">
        <h5 class="mb-2">üó∫Ô∏è Singapore MRT Network</h5>
        <div id="meetupMap" style="width:100%;height:400px;border:1px solid var(--sg-border);border-radius:12px;background:#f3f4f6"></div>
      </div>
      
      <div class="output-box mt-3" id="meetupOutput">
        <div class="text-secondary">Add at least two locations.</div>
      </div>
    </section>

    <!-- ALTERNATIVES -->
    <section id="alternatives" class="section-card d-none">
      <h2 class="section-title mb-2">üîÑ Alternative Routes (Breakdown Mode)</h2>
      <div class="feature-description p-3 rounded mb-3">Auto-detect disruptions from Live Alerts. Offers MRT-only, Bus, or Mixed alternatives.</div>

      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label">Your Current Location</label>
          <select id="altStart" class="form-select"></select>
        </div>
        <div class="col-md-6">
          <label class="form-label">Your Destination</label>
          <select id="altEnd" class="form-select"></select>
        </div>
      </div>
      <div class="row g-3 mt-1">
        <div class="col-md-6">
          <label class="form-label">Affected Line (optional)</label>
          <select id="affectedLine" class="form-select">
            <option value="">Auto-detect from alerts</option>
            <option value="NSL">North South Line (NSL)</option>
            <option value="EWL">East West Line (EWL)</option>
            <option value="DTL">Downtown Line (DTL)</option>
            <option value="CCL">Circle Line (CCL)</option>
            <option value="NEL">North East Line (NEL)</option>
            <option value="TEL">Thomson-East Coast Line (TEL)</option>
          </select>
        </div>
      </div>

      <button class="btn btn-primary mt-3" onclick="findAlternatives()">Find Alternative Routes</button>
      <div class="output-box mt-3" id="altOutput">
        <div class="text-secondary">Enter your journey details.</div>
      </div>
    </section>

    <!-- FARE -->
    <section id="fare" class="section-card d-none">
      <h2 class="section-title mb-2">üí∞ Fare Calculator</h2>
      <div class="feature-description p-3 rounded mb-3">Distance-based adult & concession fares + Monthly Pass breakeven.</div>

      <div class="row g-3">
        <div class="col-md-4">
          <label class="form-label">From</label>
          <select id="fareStart" class="form-select"></select>
        </div>
        <div class="col-md-4">
          <label class="form-label">To</label>
          <select id="fareEnd" class="form-select"></select>
        </div>
        <div class="col-md-4">
          <label class="form-label">Commuter Type</label>
          <select id="commuterType" class="form-select">
            <option value="adult">Adult</option>
            <option value="primary">Primary School Student</option>
            <option value="secondary">Secondary School Student</option>
            <option value="polytechnic">Polytechnic Student</option>
            <option value="university">University Student</option>
            <option value="senior">Senior Citizen</option>
            <option value="disability">Person with Disabilities</option>
            <option value="ns">National Serviceman</option>
            <option value="workfare">Workfare Concession</option>
          </select>
        </div>
      </div>
      <button class="btn btn-primary mt-3" onclick="calculateFare()">Calculate Fare</button>
      <div class="output-box mt-3" id="fareOutput"></div>

      <h5 class="mt-4">Monthly Pass Calculator</h5>
      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label">Daily Round Trips</label>
          <input type="number" id="dailyTrips" class="form-control" value="2" min="1" max="10">
        </div>
        <div class="col-md-6">
          <label class="form-label">Working Days / Month</label>
          <input type="number" id="workingDays" class="form-control" value="22" min="1" max="31">
        </div>
      </div>
      <button class="btn btn-primary mt-3" onclick="calculatePassValue()">Check if Pass is Worth It</button>
      <div class="output-box mt-3" id="passOutput"></div>
    </section>

    <!-- PROFILE -->
    <section id="profile" class="section-card d-none">
      <h2 class="section-title mb-2">üë§ User Profile & Favorites</h2>
      <div class="feature-description p-3 rounded mb-3">Save frequently used stations for quick access on the dashboard.</div>

      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label">Your Name</label>
          <input type="text" id="profileName" class="form-control" placeholder="Enter your name">
        </div>
        <div class="col-md-6 d-flex align-items-end">
          <button class="btn btn-primary" onclick="saveProfile()">Save Profile</button>
        </div>
      </div>

      <h5 class="mt-4">Favorite Stations</h5>
      <div class="row g-2 align-items-end">
        <div class="col-md-4">
          <input type="text" id="favoriteLabel" class="form-control" placeholder="Label (e.g., Home, Work)">
        </div>
        <div class="col-md-6">
          <select id="favoriteStation" class="form-select"></select>
        </div>
        <div class="col-md-2 d-grid">
          <button class="btn btn-success" onclick="addFavorite()">Add</button>
        </div>
      </div>
      <div id="favoritesOutput" class="mt-3"></div>
    </section>

    <!-- Toast (API errors/info) -->
    <div class="position-fixed bottom-0 end-0 p-3" style="z-index:1100">
      <div id="appToast" class="toast align-items-center text-bg-danger border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
          <div class="toast-body" id="toastMsg">An error occurred.</div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
      </div>
    </div>

  </main>

  <script>
    // ====== API CONFIG ======
    const PROXY = "https://corsproxy.io/?";
    const API_BASE = "https://datamall2.mytransport.sg/ltaodataservice";
    const ACCOUNT_KEY = "YOUR_API_KEY_HERE"; // <- replace with your real key

    // ====== STATIONS DB (simplified; you can expand) ======
    const MRT_STATIONS = {
      NSL: ['Jurong East','Bukit Batok','Bukit Gombak','Choa Chu Kang','Yew Tee','Kranji','Marsiling','Woodlands','Admiralty','Sembawang','Canberra','Yishun','Khatib','Yio Chu Kang','Ang Mo Kio','Bishan','Braddell','Toa Payoh','Novena','Newton','Orchard','Somerset','Dhoby Ghaut','City Hall','Raffles Place','Marina Bay','Marina South Pier'],
      EWL: ['Pasir Ris','Tampines','Simei','Tanah Merah','Bedok','Kembangan','Eunos','Paya Lebar','Aljunied','Kallang','Lavender','Bugis','City Hall','Raffles Place','Tanjong Pagar','Outram Park','Tiong Bahru','Redhill','Queenstown','Commonwealth','Buona Vista','Dover','Clementi','Jurong East','Chinese Garden','Lakeside','Boon Lay','Pioneer','Joo Koon','Gul Circle','Tuas Crescent','Tuas West Road','Tuas Link'],
      DTL: ['Bukit Panjang','Cashew','Hillview','Beauty World','King Albert Park','Sixth Avenue','Tan Kah Kee','Botanic Gardens','Stevens','Newton','Little India','Rochor','Bugis','Promenade','Bayfront','Downtown','Telok Ayer','Chinatown','Fort Canning','Bencoolen','Jalan Besar','Bendemeer','Geylang Bahru','Mattar','MacPherson','Ubi','Kaki Bukit','Bedok North','Bedok Reservoir','Tampines West','Tampines','Tampines East','Upper Changi','Expo'],
      CCL: ['Dhoby Ghaut','Bras Basah','Esplanade','Promenade','Nicoll Highway','Stadium','Mountbatten','Dakota','Paya Lebar','MacPherson','Tai Seng','Bartley','Serangoon','Lorong Chuan','Bishan','Marymount','Caldecott','Botanic Gardens','Farrer Road','Holland Village','Buona Vista','one-north','Kent Ridge','Haw Par Villa','Pasir Panjang','Labrador Park','Telok Blangah','HarbourFront'],
      NEL: ['HarbourFront','Outram Park','Chinatown','Clarke Quay','Dhoby Ghaut','Little India','Farrer Park','Boon Keng','Potong Pasir','Woodleigh','Serangoon','Kovan','Hougang','Buangkok','Sengkang','Punggol'],
      TEL: ['Woodlands North','Woodlands','Woodlands South','Springleaf','Lentor','Mayflower','Bright Hill','Upper Thomson','Caldecott','Mount Pleasant','Stevens','Napier','Orchard Boulevard','Orchard','Great World','Havelock','Outram Park','Maxwell','Shenton Way','Marina Bay','Marina South','Gardens by the Bay']
    };
    const ALL_STATIONS = [...new Set(Object.values(MRT_STATIONS).flat())].sort();

    // ====== USER DATA ======
    let userData = { name:'Guest User', favorites:[] };

    // ====== UI HELPERS ======
    const toastEl = document.getElementById('appToast');
    const toastMsg = document.getElementById('toastMsg');
    function showToast(msg, isError=true){
      toastMsg.textContent = msg;
      toastEl.classList.remove('text-bg-danger','text-bg-primary','text-bg-success');
      toastEl.classList.add(isError ? 'text-bg-danger' : 'text-bg-primary');
      new bootstrap.Toast(toastEl, { delay: 3500 }).show();
    }

    function setActiveTab(tabName){
      document.querySelectorAll('.nav-link').forEach(b=>b.classList.remove('active'));
      document.querySelector(`.nav-link[data-tab="${tabName}"]`)?.classList.add('active');
      document.querySelectorAll('main section').forEach(s=>s.classList.add('d-none'));
      document.getElementById(tabName)?.classList.remove('d-none');
      if(tabName==='dashboard'){ loadDashboard(); }
      if(tabName==='meetup'){ initMeetupMap(); }
    }
    document.querySelectorAll('.nav-link').forEach(btn=>{
      btn.addEventListener('click', () => setActiveTab(btn.dataset.tab));
    });
    function showTab(tab){ setActiveTab(tab); }

    // ====== INIT DROPDOWNS ======
    function fillSelect(el){
      el.innerHTML = '<option value="">-- Select Station --</option>' +
        ALL_STATIONS.map(s=>`<option value="${s}">${s}</option>`).join('');
    }
    function initializeDropdowns(){
      ['routeStart','routeEnd','altStart','altEnd','fareStart','fareEnd','favoriteStation'].forEach(id=>{
        const el = document.getElementById(id); if(el) fillSelect(el);
      });
      addMeetupLocation(); // seed first row
    }

    // ====== BUILD GRAPH (for routing) ======
    // Graph maps "Station (LINE)" nodes; interchanges are connected with small penalty.
    const graph = new Map();
    function nodeKey(st, line){ return `${st} (${line})`; }

    function addEdge(a,b, weight=1){
      if(!graph.has(a)) graph.set(a,[]);
      if(!graph.has(b)) graph.set(b,[]);
      graph.get(a).push({to:b, w:weight});
      graph.get(b).push({to:a, w:weight});
    }
    function buildGraph(){
      graph.clear();
      // connect consecutive stations on same line
      Object.entries(MRT_STATIONS).forEach(([line, stations])=>{
        stations.forEach((st, i)=>{
          const A = nodeKey(st,line);
          if(i>0){
            const B = nodeKey(stations[i-1], line);
            addEdge(A,B,1);
          }
          if(i<stations.length-1){
            const C = nodeKey(stations[i+1], line);
            addEdge(A,C,1);
          }
        });
      });
      // connect interchanges (same physical station across lines)
      const stationToLines = new Map();
      Object.entries(MRT_STATIONS).forEach(([line, stations])=>{
        stations.forEach(st=>{
          if(!stationToLines.has(st)) stationToLines.set(st,[]);
          stationToLines.get(st).push(line);
        });
      });
      stationToLines.forEach((lines, st)=>{
        if(lines.length>1){
          // small interchange cost ~0.5 stops so pathfinder can pick smart transfers
          for(let i=0;i<lines.length;i++){
            for(let j=i+1;j<lines.length;j++){
              addEdge(nodeKey(st,lines[i]), nodeKey(st,lines[j]), 0.5);
            }
          }
        }
      });
    }
    buildGraph();

    // ====== SHORTEST PATH (Dijkstra) by stops (weights) ======
    function shortestPath(startStation, endStation){
      // start from any line containing startStation; end at any line containing endStation
      const startNodes = Object.keys(MRT_STATIONS).filter(l=>MRT_STATIONS[l].includes(startStation)).map(l=>nodeKey(startStation,l));
      const endNodes   = Object.keys(MRT_STATIONS).filter(l=>MRT_STATIONS[l].includes(endStation)).map(l=>nodeKey(endStation,l));
      if(startNodes.length===0 || endNodes.length===0) return null;

      const dist = new Map(), prev = new Map(), pq=[];
      function push(n, d){ pq.push([d,n]); pq.sort((a,b)=>a[0]-b[0]); }

      // initialize
      graph.forEach((_, n)=>dist.set(n, Infinity));
      startNodes.forEach(n=>{ dist.set(n,0); push(n,0); });

      let target=null;
      const endSet = new Set(endNodes);

      while(pq.length){
        const [d,u]=pq.shift();
        if(d!==dist.get(u)) continue;
        if(endSet.has(u)){ target=u; break; }
        for(const {to, w} of (graph.get(u)||[])){
          const nd = d + w;
          if(nd < dist.get(to)){
            dist.set(to, nd);
            prev.set(to, u);
            push(to, nd);
          }
        }
      }
      if(!target) return null;

      // reconstruct
      const path = [];
      let cur = target;
      while(cur){ path.unshift(cur); cur = prev.get(cur); }
      // compress to [ {station, line}... ]
      const steps = path.map(k=>{
        const m = k.match(/^(.*) \((.*)\)$/);
        return { station: m?m[1]:k, line: m?m[2]:'?' };
      });
      const totalWeight = dist.get(target); // stops incl. interchange weight

      return { steps, totalWeight };
    }

    // ====== TIME / DISTANCE ESTIMATES ======
    // avg 2.2 min between stops; interchange adds ~4 min walking; distance ~1.1 km per stop
    function estimateTimeMinutes(totalWeight){
      // split weight into stops vs. interchanges (0.5 weights become transfers)
      const stopsApprox = Math.max(0, Math.round(totalWeight)); // approx whole stops
      const transfersApprox = Math.max(0, Math.round((totalWeight - stopsApprox) * 2)); // each 0.5 => 1 transfer
      return Math.round(stopsApprox*2.2 + transfersApprox*4 + 3); // +3 buffer
    }
    function estimateDistanceKm(totalWeight){
      const stops = Math.max(0, Math.round(totalWeight)); // only full edges
      const transfers = Math.round((totalWeight - stops)*2);
      return +(stops*1.1 + transfers*0.3).toFixed(1); // add small transfer walk dist
    }

    // ====== LIVE INFO ======
    async function fetchLiveInfo(){
      const line = document.getElementById('liveTrainLine').value;
      const out = document.getElementById('liveOutput');
      out.innerHTML = '<div class="text-secondary">Fetching live data‚Ä¶</div>';

      try {
        // Alerts
        let alerts = [];
        try{
          const alertUrl = `${PROXY}${encodeURIComponent(API_BASE + "/TrainServiceAlerts")}`;
          const res = await fetch(alertUrl, { headers:{ AccountKey: ACCOUNT_KEY, accept:"application/json" } });
          if(res.ok){
            const data = await res.json();
            alerts = Array.isArray(data.value||data.Value) ? (data.value||data.Value) : (Array.isArray(data)?data:[]);
          }
        }catch(e){ 
          console.log('Service Alerts API unavailable, using demo data');
          alerts = []; // Use empty array instead of showing error
        }

        // Crowd
        let crowds = [];
        try{
          const crowdUrl = `${PROXY}${encodeURIComponent(API_BASE + "/PCDRealTime?TrainLine=" + line)}`;
          const res = await fetch(crowdUrl, { headers:{ AccountKey: ACCOUNT_KEY, accept:"application/json" } });
          if(res.ok){
            const data = await res.json();
            crowds = Array.isArray(data.value||data.Value) ? (data.value||data.Value) : (Array.isArray(data)?data:[]);
          }
        }catch(e){ 
          console.log('Crowd data API unavailable, using demo data');
          crowds = []; // Use empty array instead of showing error
        }

        // Render
        let html = '<h5>Service Status</h5>';
        const lineAlert = alerts.find(a => (a.Line||a.line||'').toUpperCase().includes(line));
        if(lineAlert){
          html += `<div class="alert-card alert-disrupted mb-2">
            <strong>‚ö†Ô∏è ${lineAlert.Line || line}</strong><br>
            <small>${lineAlert.Message || 'Service disruption reported'}</small>
          </div>`;
        }else{
          html += `<div class="alert-card alert-normal mb-2">
            <strong>‚úÖ ${line}</strong><br><small>All services operating normally</small>
          </div>`;
        }

        html += '<h5 class="mt-3">Station Crowd Levels</h5>';
        if(crowds.length){
          html += crowds.map(s=>{
            const lvlRaw = (s.CrowdLevel||s.crowdLevel||'').toString().toUpperCase();
            const label = lvlRaw==='H' ? 'High' : lvlRaw==='M' ? 'Medium' : lvlRaw==='L' ? 'Low' : (s.CrowdLevel||'N/A');
            const cls = lvlRaw==='H' ? 'text-danger fw-semibold' : (lvlRaw==='M'?'text-warning fw-semibold':'text-success fw-semibold');
            return `<div class="d-flex justify-content-between border rounded p-2 mb-1">
              <span>${s.Station||s.station||'Unknown'}</span>
              <span class="${cls}">${label}</span>
            </div>`;
          }).join('');
        }else{
          html += '<div class="text-secondary">No crowd data for this line.</div>';
        }
        out.innerHTML = html;
      } catch(err){
        out.innerHTML = `<span class="text-danger">Error: ${err.message}</span>`;
        showToast(err.message);
        console.error(err);
      }
    }

    // ====== ROUTE PLANNER ======
    function planRoute(){
      const start = document.getElementById('routeStart').value;
      const end = document.getElementById('routeEnd').value;
      const out = document.getElementById('routeOutput');
      if(!start || !end){ out.innerHTML = '<span class="text-danger">Please select both stations.</span>'; return; }
      if(start===end){ out.innerHTML = '<span class="text-secondary">You are already at your destination üòä</span>'; return; }

      const path = shortestPath(start, end);
      if(!path){ out.innerHTML = '<span class="text-danger">No route found.</span>'; return; }

      const mins = estimateTimeMinutes(path.totalWeight);
      const dist = estimateDistanceKm(path.totalWeight);

      let html = `<h5>Route from <span class="station-chip">${start}</span> to <span class="station-chip">${end}</span></h5>`;
      html += `<div class="fare-result my-2">Estimated Time: <strong>${mins} mins</strong> ‚Ä¢ Approx Distance: <strong>${dist} km</strong></div>`;

      // Build steps (group consecutive same-line segments)
      const steps = [];
      let i=0;
      while(i<path.steps.length-1){
        const cur = path.steps[i];
        let j=i+1;
        while(j<path.steps.length && path.steps[j].line===cur.line) j++;
        const segEnd = path.steps[j-1];
        if(cur.station!==segEnd.station){
          const stations = getStopsCount(cur, segEnd);
          steps.push({ action:`Take ${cur.line}`, details:`${cur.station} ‚Üí ${segEnd.station} (${stations} stops)` });
        }
        if(j<path.steps.length){
          const transferAt = segEnd.station;
          steps.push({ action:`Transfer`, details:`Change lines at ${transferAt}` });
        }
        i=j;
      }
      steps.push({ action:`Arrive`, details:`${end} ‚Äî journey complete` });

      steps.forEach((s, idx)=>{
        html += `<div class="route-step"><strong>Step ${idx+1}:</strong> ${s.action}<br><small>${s.details}</small></div>`;
      });

      out.innerHTML = html;
    }
    function getStopsCount(a,b){
      // count stations between a and b on line a.line
      const list = MRT_STATIONS[a.line] || [];
      const ia = list.indexOf(a.station), ib = list.indexOf(b.station);
      return Math.abs(ib-ia);
    }

    // ====== MEET-UP ======
    function addMeetupLocation(){
      const container = document.getElementById('meetupLocations');
      const row = document.createElement('div');
      row.className = 'row g-2';
      row.innerHTML = `
        <div class="col">
          <select class="form-select meetup-station">
            <option value="">-- Select Station --</option>
            ${ALL_STATIONS.map(s=>`<option value="${s}">${s}</option>`).join('')}
          </select>
        </div>
        <div class="col-auto">
          <button class="btn btn-outline-danger" onclick="this.closest('.row').remove()">Remove</button>
        </div>
      `;
      container.appendChild(row);
    }

    function findMeetupPoint(){
      const stations = Array.from(document.querySelectorAll('.meetup-station')).map(s=>s.value).filter(Boolean);
      const out = document.getElementById('meetupOutput');
      if(stations.length<2){ out.innerHTML = '<span class="text-danger">Please add at least 2 locations.</span>'; return; }

      // brute force: evaluate each candidate as meetup, choose minimal totalWeight sum
      const candidates = ALL_STATIONS;
      let best = { station:null, sum: Infinity, times:[] };

      candidates.forEach(cand=>{
        let total=0, times=[];
        for(const s of stations){
          const p = shortestPath(s, cand);
          if(!p){ total=Infinity; break; }
          total += p.totalWeight;
          times.push(estimateTimeMinutes(p.totalWeight));
        }
        if(total < best.sum){ best = { station:cand, sum:total, times }; }
      });

      if(!best.station){ out.innerHTML = '<span class="text-danger">No common reachable station found.</span>'; return; }

      let html = `<h5>Recommended Meet-up Point</h5>
        <div class="fare-result my-2">üìç ${best.station}</div>
        <h6>Travel Times:</h6>`;
      stations.forEach((s, i)=>{
        html += `<div class="route-step">Person ${i+1} from <strong>${s}</strong>: approx ${best.times[i]} mins</div>`;
      });
      html += `<p class="mt-2"><strong>Total combined travel weight:</strong> ${best.sum.toFixed(1)}</p>`;
      html += `<button class="btn btn-success mt-3" onclick="animateCarsToMeetingPoint('${best.station}')">üöó Watch Cars Drive to Meeting Point!</button>`;
      out.innerHTML = html;
    }

    // ====== ALTERNATIVE ROUTES ======
    async function findAlternatives(){
      const start = document.getElementById('altStart').value;
      const end = document.getElementById('altEnd').value;
      const affectedLine = document.getElementById('affectedLine').value;
      const out = document.getElementById('altOutput');
      if(!start || !end){ out.innerHTML = '<span class="text-danger">Please select both start and destination.</span>'; return; }

      out.innerHTML = '<div class="text-secondary">Finding alternative routes‚Ä¶</div>';

      // get disrupted lines (if not provided)
      let affected = [];
      try{
        if(affectedLine){
          affected = [affectedLine];
        }else{
          try{
            const alertUrl = `${PROXY}${encodeURIComponent(API_BASE + "/TrainServiceAlerts")}`;
            const res = await fetch(alertUrl, { headers:{ AccountKey: ACCOUNT_KEY, accept:"application/json" } });
            if(res.ok){
              const data = await res.json();
              const alerts = Array.isArray(data.value||data.Value) ? (data.value||data.Value) : (Array.isArray(data)?data:[]);
              affected = alerts.filter(a=>a.Status==2).map(a=>a.Line||a.line).filter(Boolean);
            }
          }catch(e){ 
            console.log('Alternative routes API unavailable, no affected lines detected');
            affected = []; 
          }
        }
      }catch(e){ /* ignore, show no affected */ }

      let html = '<h5>Alternative Routes</h5>';
      if(affected.length){
        html += `<div class="alert-card alert-disrupted mb-2"><strong>‚ö†Ô∏è Disruption:</strong> ${affected.join(', ')}</div>`;
      }

      // Option 1: MRT alternative ‚Äî we‚Äôll just return normal route (path planner will likely avoid nothing without full GTFS);
      const p = shortestPath(start, end);
      if(p){
        html += renderAltCard('Alternative MRT Route', p);
      }else{
        html += `<div class="text-danger">No MRT path found.</div>`;
      }

      // Option 2 / 3: simple placeholders (since bus routes require other datasets/APIs)
      html += renderSimpleAlt('Bus Alternative', 'Take closest bus from origin, transfer where needed, and alight near destination. Check Bus Arrival in LTA apps.');
      html += renderSimpleAlt('Mixed MRT + Bus', 'Ride MRT part-way, switch to bus to bypass affected section, then continue MRT.');

      out.innerHTML = html;
    }
    function renderAltCard(title, path){
      const mins = estimateTimeMinutes(path.totalWeight);
      let stepsHTML = '';
      // collapse steps by line
      const segs = [];
      let i=0;
      while(i<path.steps.length-1){
        const cur=path.steps[i]; let j=i+1;
        while(j<path.steps.length && path.steps[j].line===cur.line) j++;
        segs.push({from:cur.station, to:path.steps[j-1].station, line:cur.line, stops:getStopsCount(cur, path.steps[j-1])});
        i=j;
      }
      stepsHTML += segs.map(s=>`<div class="route-step">Take <strong>${s.line}</strong>: ${s.from} ‚Üí ${s.to} (${s.stops} stops)</div>`).join('');
      return `
        <div class="border rounded-3 p-3 my-2">
          <h6 class="text-danger">${title}</h6>
          <p class="mb-1"><strong>Estimated Time:</strong> ${mins} minutes</p>
          <p class="mb-1"><strong>Route:</strong></p>
          ${stepsHTML}
        </div>
      `;
    }
    function renderSimpleAlt(title, text){
      return `
        <div class="border rounded-3 p-3 my-2">
          <h6 class="text-danger">${title}</h6>
          <p class="mb-1">${text}</p>
        </div>`;
    }

    // ====== FARES ======
    // --- Adult (Card) ---
const fareBandsAdult = [
  { max: 3.2, fare: 1.19 }, { max: 4.2, fare: 1.29 }, { max: 5.2, fare: 1.40 },
  { max: 6.2, fare: 1.50 }, { max: 7.2, fare: 1.59 }, { max: 8.2, fare: 1.66 },
  { max: 9.2, fare: 1.73 }, { max: 10.2, fare: 1.77 }, { max: 11.2, fare: 1.81 },
  { max: 12.2, fare: 1.85 }, { max: 13.2, fare: 1.89 }, { max: 14.2, fare: 1.93 },
  { max: 15.2, fare: 1.98 }, { max: 16.2, fare: 2.02 }, { max: 17.2, fare: 2.06 },
  { max: 18.2, fare: 2.10 }, { max: 19.2, fare: 2.14 }, { max: 20.2, fare: 2.17 },
  { max: 21.2, fare: 2.20 }, { max: 22.2, fare: 2.23 }, { max: 23.2, fare: 2.26 },
  { max: 24.2, fare: 2.28 }, { max: 25.2, fare: 2.30 }, { max: 26.2, fare: 2.32 },
  { max: 27.2, fare: 2.33 }, { max: 28.2, fare: 2.34 }, { max: 29.2, fare: 2.35 },
  { max: 30.2, fare: 2.36 }, { max: 31.2, fare: 2.37 }, { max: 32.2, fare: 2.38 },
  { max: 33.2, fare: 2.39 }, { max: 34.2, fare: 2.40 }, { max: 35.2, fare: 2.41 },
  { max: 36.2, fare: 2.42 }, { max: 37.2, fare: 2.43 }, { max: 38.2, fare: 2.44 },
  { max: 39.2, fare: 2.45 }, { max: 40.2, fare: 2.46 }, { max: Infinity, fare: 2.47 }
];

// --- Student (Card) ---
const fareBandsStudent = [
  { max: 3.2, fare: 0.52 }, { max: 4.2, fare: 0.57 }, { max: 5.2, fare: 0.63 },
  { max: 6.2, fare: 0.68 }, { max: 7.2, fare: 0.71 }, { max: Infinity, fare: 0.74 }
];

// --- Senior Citizens / Persons with Disabilities (Card) ---
const fareBandsSenior = [
  { max: 3.2, fare: 0.69 }, { max: 4.2, fare: 0.76 }, { max: 5.2, fare: 0.84 },
  { max: 6.2, fare: 0.91 }, { max: 7.2, fare: 0.97 }, { max: Infinity, fare: 1.03 }
];

// --- Workfare Transport Concession (Card) ---
const fareBandsWorkfare = [
  { max: 3.2, fare: 0.78 }, { max: 4.2, fare: 0.86 }, { max: 5.2, fare: 0.95 },
  { max: 6.2, fare: 1.03 }, { max: 7.2, fare: 1.10 }, { max: 8.2, fare: 1.16 },
  { max: 9.2, fare: 1.22 }, { max: 10.2, fare: 1.25 }, { max: 11.2, fare: 1.28 },
  { max: 12.2, fare: 1.31 }, { max: 13.2, fare: 1.34 }, { max: 14.2, fare: 1.37 },
  { max: 15.2, fare: 1.40 }, { max: 16.2, fare: 1.43 }, { max: 17.2, fare: 1.46 },
  { max: 18.2, fare: 1.49 }, { max: 19.2, fare: 1.52 }, { max: 20.2, fare: 1.55 },
  { max: 21.2, fare: 1.58 }, { max: 22.2, fare: 1.61 }, { max: 23.2, fare: 1.64 },
  { max: 24.2, fare: 1.66 }, { max: 25.2, fare: 1.67 }, { max: 26.2, fare: 1.68 },
  { max: 27.2, fare: 1.69 }, { max: 28.2, fare: 1.70 }, { max: 29.2, fare: 1.71 },
  { max: 30.2, fare: 1.72 }, { max: 31.2, fare: 1.73 }, { max: 32.2, fare: 1.74 },
  { max: 33.2, fare: 1.75 }, { max: 34.2, fare: 1.76 }, { max: 35.2, fare: 1.77 },
  { max: 36.2, fare: 1.78 }, { max: 37.2, fare: 1.79 }, { max: 38.2, fare: 1.80 },
  { max: 39.2, fare: 1.81 }, { max: 40.2, fare: 1.82 }, { max: Infinity, fare: 1.83 }
];



    // ====== Monthly Pass Tables (LTA Dec 2024) ======
const monthlyPasses = {
  // --- Train-only passes ---
  train: {
    primary: 21.00,
    secondary: 26.50,
    polytechnic: 26.50,
    university: 48.00,
    ns: 48.00,
    senior: 58.00,
    disability: 58.00,
    workfare: 96.00,
    adult: 128.00
  },

  // --- Bus-only passes ---
  bus: {
    primary: 24.00,
    secondary: 29.00,
    polytechnic: 29.00,
    university: 55.50,
    ns: 55.50,
    senior: 58.00,
    disability: 58.00,
    workfare: 96.00,
    adult: 128.00
  },

  // --- Hybrid (Bus + Train) passes ---
  hybrid: {
    primary: 39.00,
    secondary: 49.00,
    polytechnic: 49.00,
    university: 81.00,
    ns: 81.00,
    senior: 58.00,
    disability: 58.00,
    workfare: 96.00,
    adult: 128.00
  }
};


function fareByType(km, type = "adult") {
  let bands;

  switch (type) {
    // üßí Students up to Polytechnic ‚Üí Student table
    case "primary":
    case "secondary":
    case "polytechnic":
      bands = fareBandsStudent;
      break;

    // üë¥ Seniors & PWD ‚Üí Senior table
    case "senior":
    case "disability":
      bands = fareBandsSenior;
      break;

    // üßë‚Äçüè≠ Workfare ‚Üí Workfare table
    case "workfare":
      bands = fareBandsWorkfare;
      break;

    // üéì University & NS use the same fare as Adults
    case "university":
    case "ns":
    case "adult":
    default:
      bands = fareBandsAdult;
  }

  for (const b of bands) {
    if (km <= b.max) return b.fare;
  }
  return bands[bands.length - 1].fare;
}
   
    
    function calculateFare(){
  const start = document.getElementById('fareStart').value;
  const end = document.getElementById('fareEnd').value;
  const type = document.getElementById('commuterType').value;
  const out = document.getElementById('fareOutput');

  if(!start || !end){
    out.innerHTML = '<span class="text-danger">Please select both stations.</span>';
    return;
  }

  const p = shortestPath(start, end);
  if(!p){
    out.innerHTML = '<span class="text-danger">No route found.</span>';
    return;
  }

  const km = estimateDistanceKm(p.totalWeight);
  const fare = fareByType(km, type);
  const typeText = document.querySelector(`#commuterType option[value="${type}"]`).textContent;

  let html = `<h5>Fare Calculation</h5>`;
  html += `<div class="fare-result">
    <div class="fs-3 mb-1">$${fare.toFixed(2)}</div>
    <div class="small">Estimated fare (${typeText})</div>
  </div>`;
  html += `<div class="border rounded p-3 bg-light">
    <p class="mb-1"><strong>Journey:</strong> ${start} ‚Üí ${end}</p>
    <p class="mb-1"><strong>Approx Distance:</strong> ${km} km (stops-based estimate)</p>
  </div>`;
  out.innerHTML = html;
}

    function calculatePassValue() {
  const start = document.getElementById('fareStart').value;
  const end = document.getElementById('fareEnd').value;
  const type = document.getElementById('commuterType').value;
  const dailyTrips = parseInt(document.getElementById('dailyTrips').value) || 2;
  const workingDays = parseInt(document.getElementById('workingDays').value) || 22;
  const out = document.getElementById('passOutput');

  if (!start || !end) {
    out.innerHTML = '<span class="text-danger">Select journey in the fare calculator above.</span>';
    return;
  }

  const path = shortestPath(start, end);
  if (!path) {
    out.innerHTML = '<span class="text-danger">No route found.</span>';
    return;
  }

  // Estimate trip fare
  const km = estimateDistanceKm(path.totalWeight);
  const singleFare = fareByType(km, type);
  const monthlyTotal = singleFare * dailyTrips * workingDays;

  // Decide relevant pass types
  const travelModes = ["train", "bus", "hybrid"];
  const results = [];

  for (const mode of travelModes) {
    const passPrice = monthlyPasses[mode][type] ?? monthlyPasses[mode]["adult"];
    const savings = monthlyTotal - passPrice;
    const worth = savings > 0;
    results.push({ mode, passPrice, savings, worth });
  }

  // Render output
  let html = `<h5>Monthly Pass Analysis</h5>`;
  html += `<div class="border rounded p-3 bg-light mb-3">
    <p><strong>Single Trip Fare:</strong> $${singleFare.toFixed(2)}</p>
    <p><strong>Daily Trips:</strong> ${dailyTrips}</p>
    <p><strong>Working Days:</strong> ${workingDays}</p>
    <p><strong>Estimated Monthly Spend (Pay-Per-Ride):</strong> $${monthlyTotal.toFixed(2)}</p>
  </div>`;

  html += `<div class="table-responsive">
    <table class="table table-striped align-middle">
      <thead class="table-danger text-center">
        <tr>
          <th>Pass Type</th>
          <th>Price ($)</th>
          <th>Net Savings / Loss ($)</th>
          <th>Recommendation</th>
        </tr>
      </thead>
      <tbody class="text-center">`;

  for (const r of results) {
    html += `<tr>
      <td class="text-capitalize">${r.mode}</td>
      <td>${r.passPrice.toFixed(2)}</td>
      <td class="${r.worth ? 'text-success' : 'text-danger'}">
        ${r.worth ? '+' : '‚àí'}${Math.abs(r.savings).toFixed(2)}
      </td>
      <td>${r.worth ? '‚úÖ Worth It' : '‚ùå Not Worth It'}</td>
    </tr>`;
  }

  html += `</tbody></table></div>`;

  out.innerHTML = html;
}

    // ====== PROFILE / FAVORITES ======
    function saveProfile(){
      const name = document.getElementById('profileName').value.trim();
      if(name){
        userData.name = name;
        document.getElementById('userName').textContent = name;
        showToast('Profile saved.', false);
      }
    }
    function addFavorite(){
      const label = document.getElementById('favoriteLabel').value.trim();
      const station = document.getElementById('favoriteStation').value;
      if(!label || !station){ showToast('Please enter label and station.'); return; }
      if(userData.favorites.some(f=>f.label===label)){ showToast('Duplicate label.'); return; }
      userData.favorites.push({ label, station });
      document.getElementById('favoriteLabel').value='';
      document.getElementById('favoriteStation').value='';
      displayFavorites();
      showToast('Favorite added.', false);
    }
    function removeFavorite(idx){
      userData.favorites.splice(idx,1);
      displayFavorites();
    }
    function displayFavorites(){
      const container = document.getElementById('favoritesOutput');
      if(userData.favorites.length===0){
        container.innerHTML = '<div class="text-secondary">No favorite stations yet.</div>'; return;
      }
      container.innerHTML = userData.favorites.map((f,i)=>`
        <div class="d-flex justify-content-between align-items-center border rounded p-2 mb-2">
          <div><strong>${f.label}</strong><div class="text-secondary small">${f.station}</div></div>
          <button class="btn btn-outline-danger btn-sm" onclick="removeFavorite(${i})">Remove</button>
        </div>`).join('');
    }
    function loadDashboard(){
      // favorites
      const favContainer = document.getElementById('dashboardFavorites');
      if(userData.favorites.length===0){
        favContainer.innerHTML = '<div class="text-secondary">No favorites. Add some in Profile.</div>';
      }else{
        favContainer.innerHTML = userData.favorites.map(f=>`
          <div class="col-md-6">
            <div class="border rounded p-3 h-100" role="button" onclick="viewFavoriteDetails('${f.station.replace(/'/g,"\\'")}')">
              <div class="fw-semibold">${f.label}</div>
              <div class="text-danger">${f.station}</div>
              <div class="small text-secondary">Click for live info</div>
            </div>
          </div>
        `).join('');
      }

      // alerts
      const alertContainer = document.getElementById('dashboardAlerts');
      alertContainer.innerHTML = '<div class="text-secondary">Loading alerts‚Ä¶</div>';
      (async ()=>{
        try{
          const url = `${PROXY}${encodeURIComponent(API_BASE + "/TrainServiceAlerts")}`;
          const res = await fetch(url, { headers:{ AccountKey: ACCOUNT_KEY, accept:"application/json" } });
          if(!res.ok) throw new Error('Alerts not available');
          const data = await res.json();
          let alerts = Array.isArray(data.value||data.Value) ? (data.value||data.Value) : (Array.isArray(data)?data:[]);
          if(alerts.length===0){
            alertContainer.innerHTML = '<div class="alert-card alert-normal">‚úÖ All train lines operating normally</div>';
          }else{
            alertContainer.innerHTML = alerts.map(a=>{
              const disrupted = a.Status==2;
              return `<div class="alert-card ${disrupted?'alert-disrupted':'alert-normal'} mb-2">
                <strong>${disrupted?'‚ö†Ô∏è':'‚úÖ'} ${a.Line||'Line'}</strong><br>
                <small>${a.Message||'No details'}</small>
              </div>`;
            }).join('');
          }
        }catch(err){
          console.log('Dashboard alerts API unavailable, showing normal status');
          alertContainer.innerHTML = '<div class="alert-card alert-normal">‚úÖ All train lines operating normally (demo mode)</div>';
        }
      })();
    }
    function viewFavoriteDetails(station){
      alert(`Live details for ${station} would appear here.\n\nIn a full build: live arrivals, crowd level, service alerts, nearby facilities.`);
    }

    // ====== MAPBOX ======
    function initMeetupMap(){
      mapboxgl.accessToken = 'pk.eyJ1IjoiY2hlZWF1biIsImEiOiJja2NydG83cWMwaGJsMnBqdjR5aHc3MzdlIn0.YGTZpi7JQMquEOv9E8K_bg';
      const map = new mapboxgl.Map({
        container: 'meetupMap',
        style: 'mapbox://styles/mapbox/streets-v11',
        center: [103.8475, 1.3011], zoom: 11, renderWorldCopies:false
      });
      map.addControl(new mapboxgl.NavigationControl());

      map.on('load', async ()=>{
        try{
          const response = await fetch('./rail-map-standalone/sg-rail.geo.66ea655e.json');
          if(!response.ok) throw new Error(`HTTP ${response.status}`);
          const data = await response.json();

          map.addSource('mrt-stations', { type:'geojson', data });
          map.addLayer({
            id:'mrt-lines', source:'mrt-stations', filter:['==',['geometry-type'],'LineString'], type:'line',
            paint:{
              'line-width':['interpolate',['linear'],['zoom'],10,2,16,6],
              'line-color':[
                'match',['get','line_color'],
                'orangered','#d42e12','mediumseagreen','#009645','orange','#fa9e0d','saddlebrown','#9D5B25',
                'darkmagenta','#9900aa','darkslateblue','#005ec4','gray','#748477', '#748477'
              ], 'line-opacity':0.8
            }, layout:{ 'line-cap':'round','line-join':'round' }
          });
          map.addLayer({
            id:'stations', source:'mrt-stations', filter:['==',['get','stop_type'],'station'], type:'circle',
            paint:{
              'circle-radius':6,
              'circle-color':[
                'match',['get','station_colors'],
                'red','#d42e12','green','#009645','orange','#fa9e0d','brown','#9D5B25','purple','#9900aa','blue','#005ec4','#748477'
              ],
              'circle-stroke-color':'#fff','circle-stroke-width':2
            }
          });
          map.addLayer({
            id:'station-labels', source:'mrt-stations', filter:['==',['get','stop_type'],'station'], type:'symbol',
            layout:{ 'text-field':['get','name'],'text-size':12,'text-anchor':'bottom','text-offset':[0,-1] },
            paint:{ 'text-halo-color':'#fff','text-halo-width':2 }
          });

          // Store avatar markers
          const avatarMarkers = new Map();
          
          map.on('click','stations',(e)=>{
            const f = e.features[0];
            const props = f.properties;
            const name = props.name;
            const coordinates = e.lngLat;
            
            // Get all dropdowns
            const allSelects = document.querySelectorAll('#meetupLocations .meetup-station');
            
            // Check if this station is already selected
            let selectedIndex = -1;
            for (let i = 0; i < allSelects.length; i++) {
              if (allSelects[i].value === name) {
                selectedIndex = i;
                break;
              }
            }
            
            if (selectedIndex !== -1) {
              // Station already selected - remove it
              allSelects[selectedIndex].value = '';
              removeAvatarMarker(name);
              showToast(`Removed ${name} from person ${selectedIndex + 1}`, false);
            } else {
              // Station not selected - add it
              let emptySelect = null;
              
              // Look for first empty dropdown
              for (let select of allSelects) {
                if (!select.value || select.value === '') {
                  emptySelect = select;
                  break;
                }
              }
              
              if (emptySelect) {
                // Fill the empty slot
                emptySelect.value = name;
                const personNumber = Array.from(allSelects).indexOf(emptySelect) + 1;
                addAvatarMarker(name, coordinates, personNumber);
                showToast(`Selected ${name} for person ${personNumber}`, false);
              } else {
                // No empty slots, add a new person only if we have less than 10 people
                const currentCount = allSelects.length;
                if (currentCount < 10) {
                  addMeetupLocation();
                  // Wait for DOM update, then fill the new select
                  setTimeout(() => {
                    const newSelects = document.querySelectorAll('#meetupLocations .meetup-station');
                    const newSelect = newSelects[newSelects.length - 1]; // Get the last one
                    if (newSelect) {
                      newSelect.value = name;
                      const personNumber = newSelects.length;
                      addAvatarMarker(name, coordinates, personNumber);
                      showToast(`Added ${name} as person ${personNumber}`, false);
                    }
                  }, 50); // Increased timeout for DOM update
                } else {
                  showToast('Maximum 10 people allowed', true);
                }
              }
            }
          });
          
          function addAvatarMarker(stationName, coordinates, personNumber) {
            // Remove existing marker if any
            removeAvatarMarker(stationName);
            
            // Create 3D car element
            const avatarEl = document.createElement('div');
            avatarEl.className = 'avatar-marker';
            avatarEl.innerHTML = create3DCar(personNumber);
            avatarEl.style.cssText = `
              width: 40px;
              height: 40px;
              display: flex;
              align-items: center;
              justify-content: center;
              cursor: pointer;
              transform-style: preserve-3d;
              perspective: 1000px;
            `;
            
            // Add marker to map
            const marker = new mapboxgl.Marker(avatarEl)
              .setLngLat([coordinates.lng, coordinates.lat])
              .addTo(map);
            
            avatarMarkers.set(stationName, marker);
          }
          
          function create3DCar(personNumber) {
            const colors = ['#ff4444', '#44ff44', '#4444ff', '#ffff44', '#ff44ff', '#44ffff', '#ff8844', '#8844ff', '#44ff88', '#ff4488'];
            const color = colors[(personNumber - 1) % colors.length];
            
            return `
              <div style="
                width: 30px;
                height: 15px;
                background: ${color};
                border-radius: 3px;
                position: relative;
                transform: rotateX(15deg) rotateY(15deg);
                box-shadow: 
                  0 2px 4px rgba(0,0,0,0.3),
                  inset 0 1px 0 rgba(255,255,255,0.3);
                animation: carIdle 2s ease-in-out infinite;
              ">
                <!-- Car body -->
                <div style="
                  position: absolute;
                  top: -3px;
                  left: 2px;
                  width: 26px;
                  height: 8px;
                  background: ${color};
                  border-radius: 2px;
                  box-shadow: inset 0 1px 0 rgba(255,255,255,0.2);
                "></div>
                <!-- Windshield -->
                <div style="
                  position: absolute;
                  top: -2px;
                  left: 20px;
                  width: 6px;
                  height: 6px;
                  background: rgba(135, 206, 235, 0.7);
                  border-radius: 1px;
                  transform: skewX(-10deg);
                "></div>
                <!-- Wheels -->
                <div style="
                  position: absolute;
                  top: 12px;
                  left: 3px;
                  width: 4px;
                  height: 4px;
                  background: #333;
                  border-radius: 50%;
                  box-shadow: inset 0 1px 0 rgba(255,255,255,0.1);
                "></div>
                <div style="
                  position: absolute;
                  top: 12px;
                  right: 3px;
                  width: 4px;
                  height: 4px;
                  background: #333;
                  border-radius: 50%;
                  box-shadow: inset 0 1px 0 rgba(255,255,255,0.1);
                "></div>
                <!-- Headlights -->
                <div style="
                  position: absolute;
                  top: 2px;
                  left: -1px;
                  width: 2px;
                  height: 2px;
                  background: #ffff88;
                  border-radius: 50%;
                  box-shadow: 0 0 4px #ffff88;
                "></div>
                <div style="
                  position: absolute;
                  top: 2px;
                  right: -1px;
                  width: 2px;
                  height: 2px;
                  background: #ffff88;
                  border-radius: 50%;
                  box-shadow: 0 0 4px #ffff88;
                "></div>
              </div>
              <style>
                @keyframes carIdle {
                  0%, 100% { transform: rotateX(15deg) rotateY(15deg) translateY(0px); }
                  50% { transform: rotateX(15deg) rotateY(15deg) translateY(-1px); }
                }
                @keyframes carDrive {
                  0% { transform: rotateX(15deg) rotateY(15deg) translateX(0px); }
                  100% { transform: rotateX(15deg) rotateY(15deg) translateX(100px); }
                }
              </style>
            `;
          }
          
          function removeAvatarMarker(stationName) {
            const marker = avatarMarkers.get(stationName);
            if (marker) {
              marker.remove();
              avatarMarkers.delete(stationName);
            }
          }
          
          function getAvatarEmoji(personNumber) {
            const cars = ['üöó', 'üöô', 'üöï', 'üöì', 'üöë', 'üöí', 'üöê', 'üöö', 'üöõ', 'üèéÔ∏è'];
            return cars[(personNumber - 1) % cars.length];
          }
          
          // Driving animation functions
          function animateCarsToMeetingPoint(meetingStation) {
            const allSelects = document.querySelectorAll('#meetupLocations .meetup-station');
            const selectedStations = Array.from(allSelects)
              .map(s => s.value)
              .filter(Boolean)
              .filter(station => station !== meetingStation);
            
            if (selectedStations.length === 0) {
              showToast('No cars to animate!', true);
              return;
            }
            
            showToast(`üöó Cars driving to ${meetingStation}...`, false);
            
            // Animate each car
            selectedStations.forEach((station, index) => {
              setTimeout(() => {
                animateCarToStation(station, meetingStation, index + 1);
              }, index * 1000); // Stagger animations by 1 second
            });
          }
          
          function animateCarToStation(fromStation, toStation, carNumber) {
            // Create a temporary moving 3D car marker
            const carEl = document.createElement('div');
            carEl.innerHTML = create3DCar(carNumber);
            carEl.style.cssText = `
              width: 40px;
              height: 40px;
              display: flex;
              align-items: center;
              justify-content: center;
              position: relative;
              z-index: 1000;
              transform-style: preserve-3d;
              perspective: 1000px;
            `;
            
            // Get coordinates for from and to stations
            const fromCoords = getStationCoordinates(fromStation);
            const toCoords = getStationCoordinates(toStation);
            
            if (!fromCoords || !toCoords) {
              console.log(`Could not find coordinates for ${fromStation} or ${toStation}`);
              return;
            }
            
            // Create moving marker
            const movingMarker = new mapboxgl.Marker(carEl)
              .setLngLat([fromCoords.lng, fromCoords.lat])
              .addTo(map);
            
            // Add driving animation to the car
            const carElement = carEl.querySelector('div');
            if (carElement) {
              carElement.style.animation = 'carDrive 3s linear forwards';
            }
            
            // Animate the car
            animateMarkerMovement(movingMarker, fromCoords, toCoords, 3000, () => {
              // Animation complete - remove moving car and show arrival
              movingMarker.remove();
              showToast(`üöó Car ${carNumber} arrived at ${toStation}!`, false);
            });
          }
          
          function getStationCoordinates(stationName) {
            // This would normally query the GeoJSON data
            // For now, return some sample coordinates
            const sampleCoords = {
              'City Hall': { lng: 103.8523, lat: 1.2931 },
              'Raffles Place': { lng: 103.8514, lat: 1.2834 },
              'Marina Bay': { lng: 103.8546, lat: 1.2767 },
              'Orchard': { lng: 103.8320, lat: 1.3048 },
              'Dhoby Ghaut': { lng: 103.8458, lat: 1.2990 },
              'Newton': { lng: 103.8384, lat: 1.3003 },
              'Stevens': { lng: 103.8254, lat: 1.3201 },
              'Napier': { lng: 103.8080, lat: 1.3048 },
              'Orchard Boulevard': { lng: 103.8320, lat: 1.3048 }
            };
            
            return sampleCoords[stationName] || null;
          }
          
          function animateMarkerMovement(marker, startCoords, endCoords, duration, onComplete) {
            const startTime = Date.now();
            
            function animate() {
              const elapsed = Date.now() - startTime;
              const progress = Math.min(elapsed / duration, 1);
              
              // Easing function for smooth animation
              const easeInOutCubic = progress < 0.5 
                ? 4 * progress * progress * progress 
                : 1 - Math.pow(-2 * progress + 2, 3) / 2;
              
              // Interpolate coordinates
              const currentLng = startCoords.lng + (endCoords.lng - startCoords.lng) * easeInOutCubic;
              const currentLat = startCoords.lat + (endCoords.lat - startCoords.lat) * easeInOutCubic;
              
              marker.setLngLat([currentLng, currentLat]);
              
              if (progress < 1) {
                requestAnimationFrame(animate);
              } else {
                onComplete();
              }
            }
            
            animate();
          }
          map.on('mouseenter','stations',()=>map.getCanvas().style.cursor='pointer');
          map.on('mouseleave','stations',()=>map.getCanvas().style.cursor='');
        }catch(error){
          console.error('Meetup map load error, using fallback:', error);
          const fallback = {
            type:'FeatureCollection', features:[
              { type:'Feature', properties:{ name:'City Hall', station_codes:'NS25-EW13', station_colors:'red', 'name_zh-Hans':'ÊîøÂ∫úÂ§ßÂé¶', name_ta:'‡Æö‡Æø‡Æü‡Øç‡Æü‡Æø ‡Æπ‡Ææ‡Æ≤‡Øç' }, geometry:{ type:'Point', coordinates:[103.8523,1.2931] } },
              { type:'Feature', properties:{ name:'Raffles Place', station_codes:'NS26-EW14', station_colors:'green', 'name_zh-Hans':'Ëé±‰ΩõÂ£´Âùä', name_ta:'‡Æ∞‡Ææ‡ÆÉ‡Æ™‡Æø‡Æ≥‡Øç‡Æ∏‡Øç ‡Æ™‡Æø‡Æ≥‡Øá‡Æ∏‡Øç' }, geometry:{ type:'Point', coordinates:[103.8514,1.2834] } },
              { type:'Feature', properties:{ name:'Marina Bay', station_codes:'NS27-CC4-TE2', station_colors:'orange', 'name_zh-Hans':'Êª®Êµ∑Êπæ', name_ta:'‡ÆÆ‡Æ∞‡Æø‡Æ©‡Ææ ‡Æ™‡Øá' }, geometry:{ type:'Point', coordinates:[103.8546,1.2767] } }
            ]
          };
          map.addSource('mrt-stations',{ type:'geojson', data:fallback });
          map.addLayer({ id:'stations', source:'mrt-stations', type:'circle',
            paint:{ 'circle-radius':8,'circle-color':'#d42e12','circle-stroke-color':'#fff','circle-stroke-width':2 }});
        }
      });
    }

    function initMap(){
      mapboxgl.accessToken = 'pk.eyJ1IjoiY2hlZWF1biIsImEiOiJja2NydG83cWMwaGJsMnBqdjR5aHc3MzdlIn0.YGTZpi7JQMquEOv9E8K_bg';
      const map = new mapboxgl.Map({
        container: 'singaporeMap',
        style: 'mapbox://styles/mapbox/streets-v11',
        center: [103.8475, 1.3011], zoom: 11, renderWorldCopies:false
      });
      map.addControl(new mapboxgl.NavigationControl());

      map.on('load', async ()=>{
        try{
          const response = await fetch('./rail-map-standalone/sg-rail.geo.66ea655e.json');
          if(!response.ok) throw new Error(`HTTP ${response.status}`);
          const data = await response.json();

          map.addSource('mrt-stations', { type:'geojson', data });
          map.addLayer({
            id:'mrt-lines', source:'mrt-stations', filter:['==',['geometry-type'],'LineString'], type:'line',
            paint:{
              'line-width':['interpolate',['linear'],['zoom'],10,2,16,6],
              'line-color':[
                'match',['get','line_color'],
                'orangered','#d42e12','mediumseagreen','#009645','orange','#fa9e0d','saddlebrown','#9D5B25',
                'darkmagenta','#9900aa','darkslateblue','#005ec4','gray','#748477', '#748477'
              ], 'line-opacity':0.8
            }, layout:{ 'line-cap':'round','line-join':'round' }
          });
          map.addLayer({
            id:'stations', source:'mrt-stations', filter:['==',['get','stop_type'],'station'], type:'circle',
            paint:{
              'circle-radius':6,
              'circle-color':[
                'match',['get','station_colors'],
                'red','#d42e12','green','#009645','orange','#fa9e0d','brown','#9D5B25','purple','#9900aa','blue','#005ec4','#748477'
              ],
              'circle-stroke-color':'#fff','circle-stroke-width':2
            }
          });
          map.addLayer({
            id:'station-labels', source:'mrt-stations', filter:['==',['get','stop_type'],'station'], type:'symbol',
            layout:{ 'text-field':['get','name'],'text-size':12,'text-anchor':'bottom','text-offset':[0,-1] },
            paint:{ 'text-halo-color':'#fff','text-halo-width':2 }
          });

          map.on('click','stations',(e)=>{
            document.querySelectorAll('.mapboxgl-popup').forEach(p=>p.remove());
            const f = e.features[0];
            const props = f.properties;
            const name = props.name;
            const codes = props.station_codes;
            const colors = props.station_colors;
            const nameZh = props['name_zh-Hans']||'';
            const nameTa = props.name_ta||'';
            const lineName = {
              'red':'North-South Line (NSL)','green':'East-West Line (EWL)','orange':'Circle Line (CCL)','brown':'Downtown Line (DTL)','purple':'North East Line (NEL)','blue':'Thomson-East Coast Line (TEL)','gray':'LRT Line'
            }[colors] || 'Unknown Line';
            const dot = (c)=> (c==='red'?'#d42e12':c==='green'?'#009645':c==='orange'?'#fa9e0d':c==='brown'?'#9D5B25':c==='purple'?'#9900aa':c==='blue'?'#005ec4':'#748477');

            new mapboxgl.Popup({ maxWidth:'300px', closeButton:true, closeOnClick:false })
              .setLngLat(e.lngLat)
              .setHTML(`
                <div style="padding:12px">
                  <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
                    <span style="width:14px;height:14px;border-radius:50%;background:${dot(colors)};display:inline-block"></span>
                    <strong>${name}</strong>
                  </div>
                  <div class="mb-1"><span class="text-secondary">Code:</span> <span class="fw-semibold text-danger">${codes}</span></div>
                  <div class="mb-1"><span class="text-secondary">Line:</span> ${lineName}</div>
                  ${nameZh? `<div class="mb-1"><span class="text-secondary">‰∏≠Êñá:</span> ${nameZh}</div>`:''}
                  ${nameTa? `<div class="mb-1"><span class="text-secondary">‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç:</span> ${nameTa}</div>`:''}
                  <button class="btn btn-primary btn-sm w-100 mt-2" onclick="alert('Live arrivals & crowd levels shown here in a full build')">View Live Info</button>
                </div>`)
              .addTo(map);
          });
          map.on('mouseenter','stations',()=>map.getCanvas().style.cursor='pointer');
          map.on('mouseleave','stations',()=>map.getCanvas().style.cursor='');
        }catch(error){
          console.error('Map load error, using fallback:', error);
          const fallback = {
            type:'FeatureCollection', features:[
              { type:'Feature', properties:{ name:'City Hall', station_codes:'NS25-EW13', station_colors:'red', 'name_zh-Hans':'ÊîøÂ∫úÂ§ßÂé¶', name_ta:'‡Æö‡Æø‡Æü‡Øç‡Æü‡Æø ‡Æπ‡Ææ‡Æ≤‡Øç' }, geometry:{ type:'Point', coordinates:[103.8523,1.2931] } },
              { type:'Feature', properties:{ name:'Raffles Place', station_codes:'NS26-EW14', station_colors:'green', 'name_zh-Hans':'Ëé±‰ΩõÂ£´Âùä', name_ta:'‡Æ∞‡Ææ‡ÆÉ‡Æ™‡Æø‡Æ≥‡Øç‡Æ∏‡Øç ‡Æ™‡Æø‡Æ≥‡Øá‡Æ∏‡Øç' }, geometry:{ type:'Point', coordinates:[103.8514,1.2834] } },
              { type:'Feature', properties:{ name:'Marina Bay', station_codes:'NS27-CC4-TE2', station_colors:'orange', 'name_zh-Hans':'Êª®Êµ∑Êπæ', name_ta:'‡ÆÆ‡Æ∞‡Æø‡Æ©‡Ææ ‡Æ™‡Øá' }, geometry:{ type:'Point', coordinates:[103.8546,1.2767] } }
            ]
          };
          map.addSource('mrt-stations',{ type:'geojson', data:fallback });
          map.addLayer({ id:'stations', source:'mrt-stations', type:'circle',
            paint:{ 'circle-radius':8,'circle-color':'#d42e12','circle-stroke-color':'#fff','circle-stroke-width':2 }});
        }
      });
    }

    // ====== ON LOAD ======
    window.addEventListener('DOMContentLoaded', ()=>{
      initializeDropdowns();
      displayFavorites();
      loadDashboard();
      initMap();

      // make Dashboard default
      setActiveTab('dashboard');
    });
  </script>
</body>
</html>